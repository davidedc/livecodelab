<!DOCTYPE html>  <html> <head>   <title>animation-controls.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-controls.html">                 animation-controls.js               </a>                                           <a class="source" href="background-painting.html">                 background-painting.js               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.js               </a>                                           <a class="source" href="blend-style.html">                 blend-style.js               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="colour-definitions.html">                 colour-definitions.js               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.js               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="events.html">                 events.js               </a>                                           <a class="source" href="globals.html">                 globals.js               </a>                                           <a class="source" href="graphic-primitives.html">                 graphic-primitives.js               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.js               </a>                                           <a class="source" href="math.html">                 math.js               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.js               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.js               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.js               </a>                                           <a class="source" href="ui.html">                 ui.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               animation-controls.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="comment">/*jslint browser: true */</span>
<span class="comment">/*global $ */</span>


<span class="keyword">var</span> frame = <span class="number">0</span>;


<span class="keyword">var</span> createAnimationController = <span class="function"><span class="keyword">function</span> <span class="params">(events, CodeTransformer, threejs, timekeeper, graphics, stats, matrixcommands, soundsystem, lightsystem, blendcontrols, backgroundpainter)</span> {</span>

    <span class="string">'use strict'</span>;

    <span class="keyword">var</span> AnimationController = {},
        loopInterval,
        lastStableProgram;

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>if you put to -1 then it means that
requestAnimationFrame will try to go as fast as it
can.</p>             </td>             <td class="code">               <div class="highlight"><pre>    AnimationController.wantedFramesPerSecond = -<span class="number">1</span>;
    AnimationController.useRequestAnimationFrame = <span class="literal">true</span>;

    AnimationController.drawFunction = <span class="string">""</span>;

    AnimationController.setDrawFunction = <span class="function"><span class="keyword">function</span> <span class="params">(drawFunc)</span> {</span>
        AnimationController.drawFunction = drawFunc;
    };

    AnimationController.registerCode = <span class="function"><span class="keyword">function</span> <span class="params">(Editor)</span> {</span>
        <span class="keyword">var</span> drawFunction = CodeTransformer.registerCode(Editor);
        AnimationController.setDrawFunction(drawFunction);
    };

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>animation loop</p>             </td>             <td class="code">               <div class="highlight"><pre>    AnimationController.animate = <span class="function"><span class="keyword">function</span> <span class="params">(Editor)</span> {</span>

        <span class="keyword">var</span> drawFunction;

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>loop on request animation loop
- it has to be at the begining of the function
- see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
requestAnimationFrame seems to only do 60 fps, which in my case is too much,
I rather prefer to have a slower framerate but steadier.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="keyword">if</span> (AnimationController.useRequestAnimationFrame) {
            <span class="keyword">if</span> (AnimationController.wantedFramesPerSecond === -<span class="number">1</span>) {
                window.requestAnimationFrame(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                    AnimationController.animate(Editor);
                });
            } <span class="keyword">else</span> {
                <span class="keyword">if</span> (loopInterval === <span class="literal">undefined</span>) {
                    loopInterval = setInterval(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                        window.requestAnimationFrame(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                            AnimationController.animate(Editor);
                        });
                    }, <span class="number">1000</span> / AnimationController.wantedFramesPerSecond);
                }
            }
        } <span class="keyword">else</span> {
            setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                AnimationController.animate(Editor);
            }, <span class="number">1000</span> / AnimationController.wantedFramesPerSecond);
        }

        matrixcommands.resetMatrixStack();

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>the sound list needs to be cleaned
so that the user program can create its own from scratch</p>             </td>             <td class="code">               <div class="highlight"><pre>        soundsystem.resetLoops();


        <span class="keyword">if</span> (AnimationController.drawFunction !== <span class="string">""</span>) {

            <span class="keyword">if</span> (frame === <span class="number">0</span>) {
                timekeeper.resetTime();
            } <span class="keyword">else</span> {
                timekeeper.updateTime();
            }
            CodeTransformer.doOnceOccurrencesLineNumbers = [];
            soundsystem.anyCodeReactingTobpm = <span class="literal">false</span>;

            soundsystem.SetUpdatesPerMinute(<span class="number">60</span> * <span class="number">4</span>);
            lightsystem.noLights();

            graphics.reset();

            blendcontrols.animationStyle(blendcontrols.animationStyles.normal);
            backgroundpainter.resetGradientStack();

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Now here there is another try/catch check when the draw function is ran.
The reason is that there might be references to uninitialised or inexistent
variables. For example:
  box
  background yeLow
  ball
draws only a box, because the execution silently fails at the yeLow reference.
So in that case we need to a) highlight the error and b) run the previously
known good program.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="keyword">try</span> {
                AnimationController.drawFunction();
            } <span class="keyword">catch</span> (e) {

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>highlight the error</p>             </td>             <td class="code">               <div class="highlight"><pre>                events.trigger(<span class="string">'display-error'</span>, e);

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>mark the program as flawed and register the previous stable one.</p>             </td>             <td class="code">               <div class="highlight"><pre>                CodeTransformer.consecutiveFramesWithoutRunTimeError = <span class="number">0</span>;
                AnimationController.drawFunction = lastStableProgram;

                <span class="keyword">return</span>;
            }

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>we have to repeat this check because in the case
the user has set frame = 0,
then we have to catch that case here
after the program has executed</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="keyword">if</span> (frame === <span class="number">0</span>) {
                timekeeper.resetTime();
            }
            blendcontrols.animationStyleUpdateIfChanged();
            backgroundpainter.simpleGradientUpdateIfChanged();
            soundsystem.changeUpdatesPerMinuteIfNeeded();

            frame += <span class="number">1</span>;

            CodeTransformer.consecutiveFramesWithoutRunTimeError += <span class="number">1</span>;
            <span class="keyword">if</span> (CodeTransformer.consecutiveFramesWithoutRunTimeError === <span class="number">5</span>) {
                lastStableProgram = AnimationController.drawFunction;
            }
        } <span class="comment">// if typeof draw</span>

</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>do the render</p>             </td>             <td class="code">               <div class="highlight"><pre>        AnimationController.combDisplayList();
        AnimationController.render();
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>update stats</p>             </td>             <td class="code">               <div class="highlight"><pre>        stats.update();

        drawFunction = CodeTransformer.putTicksNextToDoOnceBlocksThatHaveBeenRun(Editor);
        <span class="keyword">if</span> (drawFunction) {
            AnimationController.setDrawFunction(drawFunction);
        }

    };

    AnimationController.render = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

        <span class="keyword">if</span> (threejs.isWebGLUsed) {
            threejs.composer.render();
        } <span class="keyword">else</span> {

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>the renderer draws into an offscreen canvas called sceneRenderingCanvas</p>             </td>             <td class="code">               <div class="highlight"><pre>            threejs.renderer.render(threejs.scene, threejs.camera);

</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>clear the final render context</p>             </td>             <td class="code">               <div class="highlight"><pre>            threejs.finalRenderWithSceneAndBlendContext.globalAlpha = <span class="number">1.0</span>;
            threejs.finalRenderWithSceneAndBlendContext.clearRect(<span class="number">0</span>, <span class="number">0</span>, window.innerWidth, window.innerHeight);

</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>draw the rendering of the scene on the final render
clear the final render context</p>             </td>             <td class="code">               <div class="highlight"><pre>            threejs.finalRenderWithSceneAndBlendContext.globalAlpha = blendcontrols.blendAmount;
            threejs.finalRenderWithSceneAndBlendContext.drawImage(threejs.previousRenderForBlending, <span class="number">0</span>, <span class="number">0</span>);

            threejs.finalRenderWithSceneAndBlendContext.globalAlpha = <span class="number">1.0</span>;
            threejs.finalRenderWithSceneAndBlendContext.drawImage(threejs.sceneRenderingCanvas, <span class="number">0</span>, <span class="number">0</span>);

            threejs.previousRenderForBlendingContext.globalCompositeOperation = <span class="string">'copy'</span>;
            threejs.previousRenderForBlendingContext.drawImage(threejs.finalRenderWithSceneAndBlend, <span class="number">0</span>, <span class="number">0</span>);

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>clear the renderer's canvas to transparent black</p>             </td>             <td class="code">               <div class="highlight"><pre>            threejs.sceneRenderingCanvasContext.clearRect(<span class="number">0</span>, <span class="number">0</span>, window.innerWidth, window.innerHeight);

        }
    };

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>By doing some profiling it is apparent that
adding and removing objects has a big cost.
So instead of adding/removing objects every frame,
objects are only added at creation and they are
never removed from the scene. They are
only made invisible. This routine combs the
scene and finds the objects that need to be visible and
those that need to be hidden.
This is a scenario of how it works:
  frame 1: 3 boxes invoked. effect: 3 cubes are created and put in the scene
  frame 2: 1 box invoked. effect: 1st cube is updated with new scale/matrix/material
           and the other 2 boxes are set to hidden
So there is a pool of objects for each primitive. It starts empty, new objects are
added to the scene only if the ones available from previous draws are not sufficient.
Note that in theory we could be smarter, instead of combing the whole scene
we could pack all the similar primitives together (because the order in the
display list doesn't matter, because there are no "matrix" nodes, each
primitive contains a fully calculated matrix) and keep indexes of where each
group is, so we could for example have 100 boxes and 100 balls, and we could
scan the first two boxes and set those two visible, then jump to the balls
avoiding to scan all the other 98 boxes, and set the correct amount of balls
visible. In practice, it's not clear whether a lot of time is spend in this
function, so that should be determined first.
TODO a way to shrink the scene and delete from the scene objects that have
not been used for a long time.
Note: Mr Doob said that the new scene destruction/creation primitives of Three.js
      are much faster. Also the objects of the scene are harder to reach, so
      it could be the case that this mechanism is not needed anymore.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    AnimationController.combDisplayList = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> i,
            sceneObject,
            primitiveType;
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>scan all the objects in the display list</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; threejs.scene.children.length; i += <span class="number">1</span>) {
            sceneObject = threejs.scene.children[i];

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>check the type of object. Each type has one pool. Go through each object in the
pool and set to visible the number of used objects in this frame, set the
others to hidden.
Only tiny exception is that the ball has one pool for each detail level.</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>set the first "used<strong>*</strong>" objects to visible...</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="keyword">if</span> (graphics.objectsUsedInFrameCounts[sceneObject.primitiveType + sceneObject.detailLevel] &gt; <span class="number">0</span>) {
                sceneObject.visible = <span class="literal">true</span>;
                graphics.objectsUsedInFrameCounts[sceneObject.primitiveType + sceneObject.detailLevel] -= <span class="number">1</span>;
            } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>... and the others to invisible</p>             </td>             <td class="code">               <div class="highlight"><pre>                sceneObject.visible = <span class="literal">false</span>;
            }

        }
    };


</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Setup Event Listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>    events.bind(<span class="string">'editor-change'</span>, AnimationController.registerCode, AnimationController);



    <span class="keyword">return</span> AnimationController;

};

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 