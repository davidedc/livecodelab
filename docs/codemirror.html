<!DOCTYPE html>  <html> <head>   <title>codemirror.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               codemirror.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>CodeMirror version 2.2</p>

<p>All functions that need access to the editor's state live inside
the CodeMirror function. Below that, at the bottom of the file,
some utilities are defined.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>CodeMirror is the only global var we claim</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">CodeMirror</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This is the function that produces an editor instance. It's
closure is used to store the editor state.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">CodeMirror</span><span class="p">(</span><span class="nx">place</span><span class="p">,</span> <span class="nx">givenOptions</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Determine effective options based on given values and defaults.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">defaults</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">opt</span> <span class="k">in</span> <span class="nx">defaults</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">opt</span><span class="p">))</span>
        <span class="nx">options</span><span class="p">[</span><span class="nx">opt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">givenOptions</span> <span class="o">&amp;&amp;</span> <span class="nx">givenOptions</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="o">?</span> <span class="nx">givenOptions</span> <span class="o">:</span> <span class="nx">defaults</span><span class="p">)[</span><span class="nx">opt</span><span class="p">];</span>

    <span class="kd">var</span> <span class="nx">targetDocument</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;document&quot;</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The element in which the editor lives.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">targetDocument</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s2">&quot;CodeMirror&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span> <span class="o">?</span> <span class="s2">&quot; CodeMirror-wrap&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>This mess creates the base DOM structure for the editor.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span>
      <span class="s1">&#39;&lt;div style=&quot;overflow: hidden; position: relative; width: 3px; height: 0px;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="c1">// Wraps and hides input textarea</span>
        <span class="s1">&#39;&lt;textarea style=&quot;position: absolute; padding: 0; width: 1px;&quot; wrap=&quot;off&quot; &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;autocorrect=&quot;off&quot; autocapitalize=&quot;off&quot;&gt;&lt;/textarea&gt;&lt;/div&gt;&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;&lt;div class=&quot;CodeMirror-scroll&quot; tabindex=&quot;-1&quot;&gt;&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;&lt;div style=&quot;position: relative&quot;&gt;&#39;</span> <span class="o">+</span> <span class="c1">// Set to the height of the text, causes scrolling</span>
          <span class="s1">&#39;&lt;div style=&quot;position: relative&quot;&gt;&#39;</span> <span class="o">+</span> <span class="c1">// Moved around its parent to cover visible view</span>
            <span class="s1">&#39;&lt;div class=&quot;CodeMirror-gutter&quot;&gt;&lt;div class=&quot;CodeMirror-gutter-text&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span> <span class="o">+</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Provides positioning relative to (visible) text origin</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="s1">&#39;&lt;div class=&quot;CodeMirror-lines&quot;&gt;&lt;div style=&quot;position: relative&quot;&gt;&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;&lt;div style=&quot;position: absolute; width: 100%; height: 0; overflow: hidden; visibility: hidden&quot;&gt;&lt;/div&gt;&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;&lt;pre class=&quot;CodeMirror-cursor&quot;&gt;&amp;#160;&lt;/pre&gt;&#39;</span> <span class="o">+</span> <span class="c1">// Absolutely positioned blinky cursor</span>
              <span class="s1">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span> <span class="o">+</span> <span class="c1">// This DIV contains the actual code</span>
            <span class="s1">&#39;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">place</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">)</span> <span class="nx">place</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">);</span> <span class="k">else</span> <span class="nx">place</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>I've never seen more elegant code in my life.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">inputDiv</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">inputDiv</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span>
        <span class="nx">scroller</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">,</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span>
        <span class="nx">mover</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">gutter</span> <span class="o">=</span> <span class="nx">mover</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">gutterText</span> <span class="o">=</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span>
        <span class="nx">lineSpace</span> <span class="o">=</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">measure</span> <span class="o">=</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span>
        <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">measure</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">,</span> <span class="nx">lineDiv</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
    <span class="nx">themeChanged</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Needed to hide big blue blinking cursor on Mobile Safari</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="sr">/AppleWebKit/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="sr">/Mobile\/\w+/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">))</span> <span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;0px&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">webkit</span><span class="p">)</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabindex</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">input</span><span class="p">.</span><span class="nx">tabIndex</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tabindex</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span><span class="p">)</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Check for problem with IE innerHTML not working when we have a
P (or similar) parent node.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">try</span> <span class="p">{</span> <span class="nx">stringWidth</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/runtime/i</span><span class="p">))</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;A CodeMirror inside a P-style element does not work in Internet Explorer. (innerHTML bug)&quot;</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Delayed object wrap timeouts, making sure only one is active. blinker holds an interval.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">poll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Delayed</span><span class="p">(),</span> <span class="nx">highlight</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Delayed</span><span class="p">(),</span> <span class="nx">blinker</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>mode holds a mode API object. doc is the tree of Line objects,
work an array of lines that should be parsed, and history the
undo history (instance of History constructor).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BranchChunk</span><span class="p">([</span><span class="k">new</span> <span class="nx">LeafChunk</span><span class="p">([</span><span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)])]),</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">focused</span><span class="p">;</span>
    <span class="nx">loadMode</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The selection. These are always maintained to point at valid
positions. Inverted is used to remember that the user is
selecting bottom-to-top.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="nx">to</span><span class="o">:</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="nx">inverted</span><span class="o">:</span> <span class="kc">false</span><span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Selection-related flags. shiftSelecting obviously tracks
whether the user is holding shift.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">shiftSelecting</span><span class="p">,</span> <span class="nx">lastClick</span><span class="p">,</span> <span class="nx">lastDoubleClick</span><span class="p">,</span> <span class="nx">draggingText</span><span class="p">,</span> <span class="nx">overwrite</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Variables used by startOperation/endOperation to track what
happened during the operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">updateInput</span><span class="p">,</span> <span class="nx">userSelChange</span><span class="p">,</span> <span class="nx">changes</span><span class="p">,</span> <span class="nx">textChanged</span><span class="p">,</span> <span class="nx">selectionChanged</span><span class="p">,</span> <span class="nx">leaveInputAlone</span><span class="p">,</span>
        <span class="nx">gutterDirty</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Current visible range (may be bigger than the view window).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">displayOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">showingFrom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">showingTo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">lastSizeC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>bracketHighlighted is used to remember that a backet has been
marked.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">bracketHighlighted</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Tracks the maximum line length so that the horizontal scrollbar
can be kept static when scrolling.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">maxLine</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">maxWidth</span><span class="p">,</span> <span class="nx">tabText</span> <span class="o">=</span> <span class="nx">computeTabText</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Initialize the content.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="nx">updateInput</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;})();</span>
    <span class="kd">var</span> <span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">History</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Register our event handlers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">onMouseDown</span><span class="p">));</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;dblclick&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">onDoubleClick</span><span class="p">));</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">lineSpace</span><span class="p">,</span> <span class="s2">&quot;dragstart&quot;</span><span class="p">,</span> <span class="nx">onDragStart</span><span class="p">);</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">lineSpace</span><span class="p">,</span> <span class="s2">&quot;selectstart&quot;</span><span class="p">,</span> <span class="nx">e_preventDefault</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Gecko browsers fire contextmenu <em>after</em> opening the menu, at
which point we can't mess with it anymore. Context menu is
handled in onMouseDown for Gecko.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gecko</span><span class="p">)</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;contextmenu&quot;</span><span class="p">,</span> <span class="nx">onContextMenu</span><span class="p">);</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">updateDisplay</span><span class="p">([]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">fixedGutter</span><span class="p">)</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onScroll</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onScroll</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">&quot;resize&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">updateDisplay</span><span class="p">(</span><span class="kc">true</span><span class="p">);});</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;keyup&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">onKeyUp</span><span class="p">));</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="nx">fastPoll</span><span class="p">);</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;keydown&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">onKeyDown</span><span class="p">));</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;keypress&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">onKeyPress</span><span class="p">));</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;focus&quot;</span><span class="p">,</span> <span class="nx">onFocus</span><span class="p">);</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;blur&quot;</span><span class="p">,</span> <span class="nx">onBlur</span><span class="p">);</span>

    <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;dragenter&quot;</span><span class="p">,</span> <span class="nx">e_stop</span><span class="p">);</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;dragover&quot;</span><span class="p">,</span> <span class="nx">e_stop</span><span class="p">);</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">onDrop</span><span class="p">));</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;paste&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">focusInput</span><span class="p">();</span> <span class="nx">fastPoll</span><span class="p">();});</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;paste&quot;</span><span class="p">,</span> <span class="nx">fastPoll</span><span class="p">);</span>
    <span class="nx">connect</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;cut&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);}));</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>IE throws unspecified error in certain cases, when
trying to access activeElement before onload</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">hasFocus</span><span class="p">;</span> <span class="k">try</span> <span class="p">{</span> <span class="nx">hasFocus</span> <span class="o">=</span> <span class="p">(</span><span class="nx">targetDocument</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">==</span> <span class="nx">input</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasFocus</span><span class="p">)</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">onFocus</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">onBlur</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">isLine</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">;}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>The instance object that we'll return. Mostly calls out to
local functions in the CodeMirror function. Some do some extra
range checking and/or clipping. operation is used to wrap the
call so that changes it makes are tracked, and the display is
updated afterwards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">CodeMirror</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">getValue</span><span class="o">:</span> <span class="nx">getValue</span><span class="p">,</span>
      <span class="nx">setValue</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">setValue</span><span class="p">),</span>
      <span class="nx">getSelection</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">,</span>
      <span class="nx">replaceSelection</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">replaceSelection</span><span class="p">),</span>
      <span class="nx">focus</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">focusInput</span><span class="p">();</span> <span class="nx">onFocus</span><span class="p">();</span> <span class="nx">fastPoll</span><span class="p">();},</span>
      <span class="nx">setOption</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">option</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">oldVal</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">];</span>
        <span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;mode&quot;</span> <span class="o">||</span> <span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;indentUnit&quot;</span><span class="p">)</span> <span class="nx">loadMode</span><span class="p">();</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;readOnly&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span><span class="nx">onBlur</span><span class="p">();</span> <span class="nx">input</span><span class="p">.</span><span class="nx">blur</span><span class="p">();}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;theme&quot;</span><span class="p">)</span> <span class="nx">themeChanged</span><span class="p">();</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;lineWrapping&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">oldVal</span> <span class="o">!=</span> <span class="nx">value</span><span class="p">)</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">wrappingChanged</span><span class="p">)();</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;tabSize&quot;</span><span class="p">)</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">tabsChanged</span><span class="p">)();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;lineNumbers&quot;</span> <span class="o">||</span> <span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;gutter&quot;</span> <span class="o">||</span> <span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;firstLineNumber&quot;</span> <span class="o">||</span> <span class="nx">option</span> <span class="o">==</span> <span class="s2">&quot;theme&quot;</span><span class="p">)</span>
          <span class="nx">operation</span><span class="p">(</span><span class="nx">gutterChanged</span><span class="p">)();</span>
      <span class="p">},</span>
      <span class="nx">getOption</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">];},</span>
      <span class="nx">undo</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">undo</span><span class="p">),</span>
      <span class="nx">redo</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">redo</span><span class="p">),</span>
      <span class="nx">indentLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="nx">indentLine</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">dir</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s2">&quot;smart&quot;</span> <span class="o">:</span> <span class="nx">dir</span> <span class="o">?</span> <span class="s2">&quot;add&quot;</span> <span class="o">:</span> <span class="s2">&quot;subtract&quot;</span><span class="p">);</span>
      <span class="p">}),</span>
      <span class="nx">indentSelection</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">indentSelected</span><span class="p">),</span>
      <span class="nx">historySize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="p">{</span><span class="nx">undo</span><span class="o">:</span> <span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">redo</span><span class="o">:</span> <span class="nx">history</span><span class="p">.</span><span class="nx">undone</span><span class="p">.</span><span class="nx">length</span><span class="p">};},</span>
      <span class="nx">clearHistory</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">History</span><span class="p">();},</span>
      <span class="nx">matchBrackets</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">matchBrackets</span><span class="p">(</span><span class="kc">true</span><span class="p">);}),</span>
      <span class="nx">getTokenAt</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">getTokenAt</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
      <span class="p">}),</span>
      <span class="nx">getStateAfter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">line</span> <span class="o">=</span> <span class="nx">clipLine</span><span class="p">(</span><span class="nx">line</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">:</span> <span class="nx">line</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">cursorCoords</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">pageCoords</span><span class="p">(</span><span class="nx">start</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">charCoords</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">){</span><span class="k">return</span> <span class="nx">pageCoords</span><span class="p">(</span><span class="nx">clipPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">));},</span>
      <span class="nx">coordsChar</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">off</span> <span class="o">=</span> <span class="nx">eltOffset</span><span class="p">(</span><span class="nx">lineSpace</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">off</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">off</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">markText</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">markText</span><span class="p">),</span>
      <span class="nx">setBookmark</span><span class="o">:</span> <span class="nx">setBookmark</span><span class="p">,</span>
      <span class="nx">setMarker</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">addGutterMarker</span><span class="p">),</span>
      <span class="nx">clearMarker</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">removeGutterMarker</span><span class="p">),</span>
      <span class="nx">setLineClass</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">setLineClass</span><span class="p">),</span>
      <span class="nx">hideLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">setLineHidden</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="kc">true</span><span class="p">);}),</span>
      <span class="nx">showLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">setLineHidden</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="kc">false</span><span class="p">);}),</span>
      <span class="nx">onDeleteLine</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">line</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
      <span class="p">},</span>
      <span class="nx">lineInfo</span><span class="o">:</span> <span class="nx">lineInfo</span><span class="p">,</span>
      <span class="nx">addWidget</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">scroll</span><span class="p">,</span> <span class="nx">vert</span><span class="p">,</span> <span class="nx">horiz</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="nx">localCoords</span><span class="p">(</span><span class="nx">clipPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">yBot</span><span class="p">,</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;absolute&quot;</span><span class="p">;</span>
        <span class="nx">code</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">vert</span> <span class="o">==</span> <span class="s2">&quot;over&quot;</span><span class="p">)</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vert</span> <span class="o">==</span> <span class="s2">&quot;near&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">vspace</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">textHeight</span><span class="p">()),</span>
              <span class="nx">hspace</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">code</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">,</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">)</span> <span class="o">-</span> <span class="nx">paddingLeft</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">yBot</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">&gt;</span> <span class="nx">vspace</span> <span class="o">&amp;&amp;</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">)</span>
            <span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">&gt;</span> <span class="nx">hspace</span><span class="p">)</span>
            <span class="nx">left</span> <span class="o">=</span> <span class="nx">hspace</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">paddingTop</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">horiz</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">left</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="s2">&quot;0px&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">horiz</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span> <span class="nx">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">horiz</span> <span class="o">==</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span> <span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nx">code</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">paddingLeft</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scroll</span><span class="p">)</span>
          <span class="nx">scrollIntoView</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">left</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="nx">top</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">lineCount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">;},</span>
      <span class="nx">clipPos</span><span class="o">:</span> <span class="nx">clipPos</span><span class="p">,</span>
      <span class="nx">getCursor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">copyPos</span><span class="p">(</span><span class="nx">start</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">somethingSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);},</span>
      <span class="nx">setCursor</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">line</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">setCursor</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">setCursor</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
      <span class="p">}),</span>
      <span class="nx">setSelection</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="nx">user</span> <span class="o">?</span> <span class="nx">setSelectionUser</span> <span class="o">:</span> <span class="nx">setSelection</span><span class="p">)(</span><span class="nx">clipPos</span><span class="p">(</span><span class="nx">from</span><span class="p">),</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">to</span> <span class="o">||</span> <span class="nx">from</span><span class="p">));</span>
      <span class="p">}),</span>
      <span class="nx">getLine</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="k">return</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">;},</span>
      <span class="nx">getLineHandle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="k">return</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">);},</span>
      <span class="nx">setLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">});</span>
      <span class="p">}),</span>
      <span class="nx">removeLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="nx">clipPos</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">}));</span>
      <span class="p">}),</span>
      <span class="nx">replaceRange</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">replaceRange</span><span class="p">),</span>
      <span class="nx">getRange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">getRange</span><span class="p">(</span><span class="nx">clipPos</span><span class="p">(</span><span class="nx">from</span><span class="p">),</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">to</span><span class="p">));},</span>

      <span class="nx">execCommand</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">commands</span><span class="p">[</span><span class="nx">cmd</span><span class="p">](</span><span class="nx">instance</span><span class="p">);},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Stuff used by commands, probably not much use to outside code.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">moveH</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">moveH</span><span class="p">),</span>
      <span class="nx">deleteH</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">deleteH</span><span class="p">),</span>
      <span class="nx">moveV</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">moveV</span><span class="p">),</span>
      <span class="nx">toggleOverwrite</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">overwrite</span> <span class="o">=</span> <span class="o">!</span><span class="nx">overwrite</span><span class="p">;},</span>

      <span class="nx">posFromIndex</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">off</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">lineNo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sz</span> <span class="o">&gt;</span> <span class="nx">off</span><span class="p">)</span> <span class="p">{</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">off</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
          <span class="nx">off</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
          <span class="o">++</span><span class="nx">lineNo</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">clipPos</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">});</span>
      <span class="p">},</span>
      <span class="nx">indexFromPos</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">index</span> <span class="o">+=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">index</span><span class="p">;</span>
      <span class="p">},</span>

      <span class="nx">operation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">){</span><span class="k">return</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">f</span><span class="p">)();},</span>
      <span class="nx">refresh</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">updateDisplay</span><span class="p">(</span><span class="kc">true</span><span class="p">);},</span>
      <span class="nx">getInputField</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">input</span><span class="p">;},</span>
      <span class="nx">getWrapperElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">wrapper</span><span class="p">;},</span>
      <span class="nx">getScrollerElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">scroller</span><span class="p">;},</span>
      <span class="nx">getGutterElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">gutter</span><span class="p">;}</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">getLineAt</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span> <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">-</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="nx">n</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">diff</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">setValue</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
      <span class="nx">updateLines</span><span class="p">(</span><span class="nx">top</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">},</span>
                  <span class="nx">splitLines</span><span class="p">(</span><span class="nx">code</span><span class="p">),</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">top</span><span class="p">);</span>
      <span class="nx">updateInput</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">getValue</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">text</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onMouseDown</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setShift</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Check whether this is a click in a widget</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nx">wrapper</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">==</span> <span class="nx">code</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nx">mover</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>See if this is a click in the gutter</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nx">wrapper</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">==</span> <span class="nx">gutterText</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onGutterClick</span><span class="p">)</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">onGutterClick</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">gutterText</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">showingFrom</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

      <span class="k">switch</span> <span class="p">(</span><span class="nx">e_button</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">gecko</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mac</span><span class="p">)</span> <span class="nx">onContextMenu</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="nx">setCursor</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">start</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>For button 1, if it was clicked inside the editor
(posFromMouse returning non-null), we have to adjust the
selection.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">==</span> <span class="nx">scroller</span><span class="p">)</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="k">return</span><span class="p">;}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">onFocus</span><span class="p">();</span>

      <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lastDoubleClick</span> <span class="o">&amp;&amp;</span> <span class="nx">lastDoubleClick</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">lastDoubleClick</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">start</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">focusInput</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">selectLine</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">lastClick</span> <span class="o">&amp;&amp;</span> <span class="nx">lastClick</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">lastClick</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">start</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">lastDoubleClick</span> <span class="o">=</span> <span class="p">{</span><span class="nx">time</span><span class="o">:</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pos</span><span class="o">:</span> <span class="nx">start</span><span class="p">};</span>
        <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">selectWordAt</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">lastClick</span> <span class="o">=</span> <span class="p">{</span><span class="nx">time</span><span class="o">:</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pos</span><span class="o">:</span> <span class="nx">start</span><span class="p">};</span> <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">going</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dragAndDrop</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">start</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Let the drag handler handle this.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">webkit</span><span class="p">)</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">up</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">targetDocument</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">webkit</span><span class="p">)</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">draggingText</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">up</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">clientX</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">clientY</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e2</span><span class="p">);</span>
            <span class="nx">setCursor</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">start</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="nx">focusInput</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}),</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">draggingText</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">setCursor</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">start</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">last</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">onFocus</span><span class="p">();</span>
          <span class="nx">last</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">;</span>
          <span class="nx">setSelectionUser</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">cur</span><span class="p">);</span>
          <span class="nx">updateInput</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">visible</span> <span class="o">=</span> <span class="nx">visibleLines</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">line</span> <span class="o">&gt;=</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">to</span> <span class="o">||</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
            <span class="nx">going</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">extend</span><span class="p">(</span><span class="nx">e</span><span class="p">);}),</span> <span class="mi">150</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">move</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">targetDocument</span><span class="p">,</span> <span class="s2">&quot;mousemove&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">going</span><span class="p">);</span>
        <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="nx">extend</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}),</span> <span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">up</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">targetDocument</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">going</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">)</span> <span class="nx">setSelectionUser</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">cur</span><span class="p">);</span>
        <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="nx">focusInput</span><span class="p">();</span>
        <span class="nx">updateInput</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">move</span><span class="p">();</span> <span class="nx">up</span><span class="p">();</span>
      <span class="p">}),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onDoubleClick</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nx">wrapper</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">==</span> <span class="nx">gutterText</span><span class="p">)</span> <span class="k">return</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">start</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">lastDoubleClick</span> <span class="o">=</span> <span class="p">{</span><span class="nx">time</span><span class="o">:</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">,</span> <span class="nx">pos</span><span class="o">:</span> <span class="nx">start</span><span class="p">};</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">selectWordAt</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onDrop</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pos</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">readOnly</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">files</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">FileReader</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">loadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">;</span>
          <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">read</span> <span class="o">==</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
	      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
	      <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
                <span class="nx">setSelectionUser</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
              <span class="p">})();</span>
	    <span class="p">}</span>
          <span class="p">};</span>
          <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="nx">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">loadFile</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="s2">&quot;Text&quot;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
	    <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
	    <span class="kd">var</span> <span class="nx">curFrom</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">curTo</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
	    <span class="nx">setSelectionUser</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">draggingText</span><span class="p">)</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">curFrom</span><span class="p">,</span> <span class="nx">curTo</span><span class="p">);</span>
	    <span class="nx">focusInput</span><span class="p">();</span>
	  <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onDragStart</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nx">getSelection</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>This will reset escapeElement</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">htmlEscape</span><span class="p">(</span><span class="nx">txt</span><span class="p">);</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">setDragImage</span><span class="p">(</span><span class="nx">escapeElement</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="s2">&quot;Text&quot;</span><span class="p">,</span> <span class="nx">txt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">handleKeyBinding</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">],</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">].</span><span class="nx">auto</span><span class="p">,</span> <span class="nx">bound</span><span class="p">,</span> <span class="nx">dropShift</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">altGraphKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">altKey</span><span class="p">)</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Alt-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">)</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Ctrl-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span><span class="p">)</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Cmd-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">bound</span> <span class="o">=</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="s2">&quot;Shift-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">extraKeys</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">)))</span> <span class="p">{</span>
        <span class="nx">dropShift</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">bound</span> <span class="o">=</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">extraKeys</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">bound</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">commands</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">(</span><span class="nx">bound</span><span class="p">))</span> <span class="nx">bound</span> <span class="o">=</span> <span class="nx">commands</span><span class="p">[</span><span class="nx">bound</span><span class="p">];</span>
        <span class="k">else</span> <span class="nx">bound</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">bound</span> <span class="o">||</span> <span class="o">!</span><span class="nx">isModifierKey</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bound</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dropShift</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prevShift</span> <span class="o">=</span> <span class="nx">shiftSelecting</span><span class="p">;</span>
        <span class="nx">shiftSelecting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">bound</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
        <span class="nx">shiftSelecting</span> <span class="o">=</span> <span class="nx">prevShift</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nx">bound</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">lastStoppedKey</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">onKeyDown</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">onFocus</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>IE does strange things with escape.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span> <span class="o">==</span> <span class="mi">27</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>
      <span class="nx">setShift</span><span class="p">(</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>First give onKeyEvent option a chance to handle this.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">handled</span> <span class="o">=</span> <span class="nx">handleKeyBinding</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">lastStoppedKey</span> <span class="o">=</span> <span class="nx">handled</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Opera has no cut event... we try to at least catch the key combo</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">handled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">mac</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">88</span><span class="p">)</span>
          <span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onKeyPress</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="nx">lastStoppedKey</span><span class="p">)</span> <span class="p">{</span><span class="nx">lastStoppedKey</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="k">return</span><span class="p">;}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">&amp;&amp;</span> <span class="nx">handleKeyBinding</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">electricChars</span> <span class="o">&amp;&amp;</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">electricChars</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">charCode</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">charCode</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span><span class="p">.</span><span class="nx">electricChars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">indentLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;smart&quot;</span><span class="p">);}),</span> <span class="mi">75</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">fastPoll</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onKeyUp</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="nx">shiftSelecting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onFocus</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">readOnly</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">focused</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onFocus</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onFocus</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
        <span class="nx">focused</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\bCodeMirror-focused\b/</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s2">&quot; CodeMirror-focused&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">leaveInputAlone</span><span class="p">)</span> <span class="nx">resetInput</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">slowPoll</span><span class="p">();</span>
      <span class="nx">restartBlink</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onBlur</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">focused</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onBlur</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onBlur</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
        <span class="nx">focused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot; CodeMirror-focused&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">blinker</span><span class="p">);</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">shiftSelecting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;},</span> <span class="mi">150</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Replace the range from from to to by the strings in newText.
Afterwards, set the selection to selFrom, selTo.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">updateLines</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">newText</span><span class="p">,</span> <span class="nx">selFrom</span><span class="p">,</span> <span class="nx">selTo</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">history</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">old</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">old</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span> <span class="p">});</span>
        <span class="nx">history</span><span class="p">.</span><span class="nx">addChange</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">old</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">undoDepth</span><span class="p">)</span> <span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nx">updateLinesNoUndo</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">newText</span><span class="p">,</span> <span class="nx">selFrom</span><span class="p">,</span> <span class="nx">selTo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">unredoHelper</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">change</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">replaced</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">change</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">change</span><span class="p">.</span><span class="nx">added</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">replaced</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span> <span class="p">});</span>
        <span class="nx">to</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">start</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">old</span><span class="o">:</span> <span class="nx">replaced</span><span class="p">});</span>
        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">change</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="nx">ch</span><span class="o">:</span> <span class="nx">editEnd</span><span class="p">(</span><span class="nx">replaced</span><span class="p">[</span><span class="nx">replaced</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">change</span><span class="p">.</span><span class="nx">old</span><span class="p">[</span><span class="nx">change</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">])});</span>
        <span class="nx">updateLinesNoUndo</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">end</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">},</span> <span class="nx">change</span><span class="p">.</span><span class="nx">old</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
        <span class="nx">updateInput</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">undo</span><span class="p">()</span> <span class="p">{</span><span class="nx">unredoHelper</span><span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span> <span class="nx">history</span><span class="p">.</span><span class="nx">undone</span><span class="p">);}</span>
    <span class="kd">function</span> <span class="nx">redo</span><span class="p">()</span> <span class="p">{</span><span class="nx">unredoHelper</span><span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">undone</span><span class="p">,</span> <span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">);}</span>

    <span class="kd">function</span> <span class="nx">updateLinesNoUndo</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">newText</span><span class="p">,</span> <span class="nx">selFrom</span><span class="p">,</span> <span class="nx">selTo</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">recomputeMaxLength</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">maxLineLength</span> <span class="o">=</span> <span class="nx">maxLine</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">maxLineLength</span><span class="p">)</span> <span class="p">{</span><span class="nx">recomputeMaxLength</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;}</span>
        <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">!=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">||</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">nlines</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">firstLine</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">lastLine</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>First adjust the line structure, taking some care to leave highlighting intact.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">newText</span><span class="p">[</span><span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>This is a whole-line replace. Treated specially to make
sure line objects move the way they are supposed to.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">prevLine</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">prevLine</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">prevLine</span><span class="p">.</span><span class="nx">fixMarkEnds</span><span class="p">(</span><span class="nx">lastLine</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">lastLine</span><span class="p">.</span><span class="nx">fixMarkStarts</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Line</span><span class="p">.</span><span class="nx">inheritMarks</span><span class="p">(</span><span class="nx">newText</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">prevLine</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nlines</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">nlines</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">added</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">firstLine</span> <span class="o">==</span> <span class="nx">lastLine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
          <span class="nx">firstLine</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">newText</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">lastLine</span> <span class="o">=</span> <span class="nx">firstLine</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">newText</span><span class="p">[</span><span class="nx">newText</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
          <span class="nx">firstLine</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">newText</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
          <span class="nx">firstLine</span><span class="p">.</span><span class="nx">fixMarkEnds</span><span class="p">(</span><span class="nx">lastLine</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
            <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Line</span><span class="p">.</span><span class="nx">inheritMarks</span><span class="p">(</span><span class="nx">newText</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">firstLine</span><span class="p">));</span>
          <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">lastLine</span><span class="p">);</span>
          <span class="nx">doc</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">firstLine</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">newText</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">lastLine</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="nx">firstLine</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">lastLine</span><span class="p">);</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">nlines</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">firstLine</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">newText</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">lastLine</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">newText</span><span class="p">[</span><span class="nx">newText</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">firstLine</span><span class="p">.</span><span class="nx">fixMarkEnds</span><span class="p">(</span><span class="nx">lastLine</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Line</span><span class="p">.</span><span class="nx">inheritMarks</span><span class="p">(</span><span class="nx">newText</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">firstLine</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nlines</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">nlines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">);</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">perLine</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">/</span> <span class="nx">charWidth</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">guess</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">perLine</span><span class="p">)</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">guess</span> <span class="o">!=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">guess</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">maxLineLength</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">maxLine</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">maxLineLength</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">maxWidth</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">recomputeMaxLength</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">recomputeMaxLength</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">maxLineLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">maxLine</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="nx">maxWidth</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">maxLineLength</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">maxLineLength</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">maxLine</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Add these lines to the work array, so that they will be
highlighted. Adjust work lines if lines were added/removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">newWork</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">lendiff</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">nlines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">work</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">work</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">task</span> <span class="o">&lt;</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="nx">newWork</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">task</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">task</span> <span class="o">&gt;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="nx">newWork</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">task</span> <span class="o">+</span> <span class="nx">lendiff</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">hlEnd</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">newText</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
      <span class="nx">highlightLines</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">hlEnd</span><span class="p">);</span>
      <span class="nx">newWork</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">hlEnd</span><span class="p">);</span>
      <span class="nx">work</span> <span class="o">=</span> <span class="nx">newWork</span><span class="p">;</span>
      <span class="nx">startWorker</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Remember that these lines changed, for updating the display</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">diff</span><span class="o">:</span> <span class="nx">lendiff</span><span class="p">});</span>
      <span class="kd">var</span> <span class="nx">changeObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">newText</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">textChanged</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">textChanged</span><span class="p">;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">next</span><span class="p">;</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">next</span><span class="p">)</span> <span class="p">{}</span>
        <span class="nx">cur</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">changeObj</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nx">textChanged</span> <span class="o">=</span> <span class="nx">changeObj</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Update the selection</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">updateLine</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">lendiff</span><span class="p">)</span> <span class="o">?</span> <span class="nx">n</span> <span class="o">:</span> <span class="nx">n</span> <span class="o">+</span> <span class="nx">lendiff</span><span class="p">;}</span>
      <span class="nx">setSelection</span><span class="p">(</span><span class="nx">selFrom</span><span class="p">,</span> <span class="nx">selTo</span><span class="p">,</span> <span class="nx">updateLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">updateLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Make sure the scroll-size div has the correct height.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">code</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">textHeight</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">paddingTop</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">from</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">to</span><span class="p">)</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="k">else</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
      <span class="nx">code</span> <span class="o">=</span> <span class="nx">splitLines</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">adjustPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">from</span><span class="p">))</span> <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">pos</span><span class="p">))</span> <span class="k">return</span> <span class="nx">end</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">code</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span>
          <span class="nx">ch</span> <span class="o">+=</span> <span class="nx">code</span><span class="p">[</span><span class="nx">code</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">?</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">};</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">end</span><span class="p">;</span>
      <span class="nx">replaceRange1</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">end1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">end</span> <span class="o">=</span> <span class="nx">end1</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">adjustPos</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">),</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">adjustPos</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">)};</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">replaceSelection</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">collapse</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">replaceRange1</span><span class="p">(</span><span class="nx">splitLines</span><span class="p">(</span><span class="nx">code</span><span class="p">),</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">collapse</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">end</span><span class="p">};</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">collapse</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">};</span>
        <span class="k">else</span> <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">end</span><span class="p">};</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">replaceRange1</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">computeSel</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">endch</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">code</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">:</span> <span class="nx">code</span><span class="p">[</span><span class="nx">code</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">newSel</span> <span class="o">=</span> <span class="nx">computeSel</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">code</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">endch</span><span class="p">});</span>
      <span class="nx">updateLines</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">newSel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">newSel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getRange</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">l1</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">l2</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">l1</span> <span class="o">==</span> <span class="nx">l2</span><span class="p">)</span> <span class="k">return</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">l1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="p">[</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">l1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)];</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">l1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">l2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">code</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span> <span class="p">});</span>
      <span class="nx">code</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">l2</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">code</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">getSelection</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">getRange</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Ensures slowPoll doesn&#39;t cancel fastPoll</span>
    <span class="kd">function</span> <span class="nx">slowPoll</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pollingFast</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">pollInterval</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">startOperation</span><span class="p">();</span>
        <span class="nx">readInput</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">slowPoll</span><span class="p">();</span>
        <span class="nx">endOperation</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">fastPoll</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">missed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">p</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">startOperation</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="nx">readInput</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">changed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">missed</span><span class="p">)</span> <span class="p">{</span><span class="nx">missed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nx">p</span><span class="p">);}</span>
        <span class="k">else</span> <span class="p">{</span><span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="nx">slowPoll</span><span class="p">();}</span>
        <span class="nx">endOperation</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nx">p</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Previnput is a hack to work with IME. If we reset the textarea
on every change, that breaks IME. So we look for changes
compared to the previous content instead. (Modern browsers have
events that indicate IME taking place, but these are not widely
supported or compatible enough yet to rely on.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">readInput</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">leaveInputAlone</span> <span class="o">||</span> <span class="o">!</span><span class="nx">focused</span> <span class="o">||</span> <span class="nx">hasSelection</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">text</span> <span class="o">==</span> <span class="nx">prevInput</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">shiftSelecting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">same</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">prevInput</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">same</span> <span class="o">&lt;</span> <span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="nx">prevInput</span><span class="p">[</span><span class="nx">same</span><span class="p">]</span> <span class="o">==</span> <span class="nx">text</span><span class="p">[</span><span class="nx">same</span><span class="p">])</span> <span class="o">++</span><span class="nx">same</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">same</span> <span class="o">&lt;</span> <span class="nx">prevInput</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevInput</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">same</span><span class="p">)};</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">overwrite</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span>
        <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">same</span><span class="p">))};</span>
      <span class="nx">replaceSelection</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">same</span><span class="p">),</span> <span class="s2">&quot;end&quot;</span><span class="p">);</span>
      <span class="nx">prevInput</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">resetInput</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">getSelection</span><span class="p">();</span>
        <span class="nx">input</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="nx">prevInput</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">focusInput</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">readOnly</span><span class="p">)</span> <span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">scrollEditorIntoView</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>IE returns bogus coordinates when the instance sits inside of an iframe and the cursor is hidden</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span> <span class="o">==</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">bottom</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">winH</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">||</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">top</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">&gt;</span> <span class="nx">winH</span><span class="p">)</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">scrollIntoView</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">scrollCursorIntoView</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">localCoords</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="o">:</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">scrollIntoView</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">yBot</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">scrollIntoView</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pl</span> <span class="o">=</span> <span class="nx">paddingLeft</span><span class="p">(),</span> <span class="nx">pt</span> <span class="o">=</span> <span class="nx">paddingTop</span><span class="p">(),</span> <span class="nx">lh</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">();</span>
      <span class="nx">y1</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">;</span> <span class="nx">y2</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">;</span> <span class="nx">x1</span> <span class="o">+=</span> <span class="nx">pl</span><span class="p">;</span> <span class="nx">x2</span> <span class="o">+=</span> <span class="nx">pl</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">screen</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">,</span> <span class="nx">screentop</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span> <span class="nx">scrolled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">&lt;</span> <span class="nx">screentop</span><span class="p">)</span> <span class="p">{</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">y1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="nx">lh</span><span class="p">);</span> <span class="nx">scrolled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">y2</span> <span class="o">&gt;</span> <span class="nx">screentop</span> <span class="o">+</span> <span class="nx">screen</span><span class="p">)</span> <span class="p">{</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">y2</span> <span class="o">+</span> <span class="nx">lh</span> <span class="o">-</span> <span class="nx">screen</span><span class="p">;</span> <span class="nx">scrolled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;}</span>

      <span class="kd">var</span> <span class="nx">screenw</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">,</span> <span class="nx">screenleft</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">gutterw</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fixedGutter</span> <span class="o">?</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&lt;</span> <span class="nx">screenleft</span> <span class="o">+</span> <span class="nx">gutterw</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="nx">x1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">x1</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">gutterw</span><span class="p">);</span>
        <span class="nx">scrolled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">x2</span> <span class="o">&gt;</span> <span class="nx">screenw</span> <span class="o">+</span> <span class="nx">screenleft</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nx">x2</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">screenw</span><span class="p">;</span>
        <span class="nx">scrolled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">x2</span> <span class="o">&gt;</span> <span class="nx">code</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">)</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">scrolled</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onScroll</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onScroll</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">visibleLines</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lh</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(),</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">-</span> <span class="nx">paddingTop</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">from_height</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">top</span> <span class="o">/</span> <span class="nx">lh</span><span class="p">));</span>
      <span class="kd">var</span> <span class="nx">to_height</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">((</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">)</span> <span class="o">/</span> <span class="nx">lh</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from_height</span><span class="p">),</span>
              <span class="nx">to</span><span class="o">:</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to_height</span><span class="p">)};</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Uses a set of changes plus the current scroll position to
determine which DOM updates have to be made, and makes the
updates.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">changes</span><span class="p">,</span> <span class="nx">suppressCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">showingFrom</span> <span class="o">=</span> <span class="nx">showingTo</span> <span class="o">=</span> <span class="nx">displayOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Compute the new visible window</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">visible</span> <span class="o">=</span> <span class="nx">visibleLines</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Bail out if the visible area is already rendered and nothing changed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span> <span class="o">!==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;=</span> <span class="nx">showingFrom</span> <span class="o">&amp;&amp;</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;=</span> <span class="nx">showingTo</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">visible</span><span class="p">.</span><span class="nx">from</span> <span class="o">-</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">to</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="mi">100</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">showingFrom</span> <span class="o">&lt;</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="nx">from</span> <span class="o">-</span> <span class="nx">showingFrom</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">showingFrom</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">showingTo</span> <span class="o">&gt;</span> <span class="nx">to</span> <span class="o">&amp;&amp;</span> <span class="nx">showingTo</span> <span class="o">-</span> <span class="nx">to</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="nx">to</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">showingTo</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Create a range of theoretically intact lines, and punch holes
in that using the change info.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">intact</span> <span class="o">=</span> <span class="nx">changes</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span>
        <span class="nx">computeIntact</span><span class="p">([{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">showingFrom</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">showingTo</span><span class="p">,</span> <span class="nx">domStart</span><span class="o">:</span> <span class="mi">0</span><span class="p">}],</span> <span class="nx">changes</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Clip off the parts that won't be visible</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">intactLines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span><span class="nx">range</span><span class="p">.</span><span class="nx">domStart</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">to</span><span class="p">)</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">intactLines</span> <span class="o">+=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">intactLines</span> <span class="o">==</span> <span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">intact</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">domStart</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">domStart</span><span class="p">;});</span>

      <span class="kd">var</span> <span class="nx">th</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(),</span> <span class="nx">gutterDisplay</span> <span class="o">=</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
      <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
      <span class="nx">patchDisplay</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">intact</span><span class="p">);</span>
      <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Position the mover div to align with the lines it's supposed
to be showing (which will cover the visible display)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">different</span> <span class="o">=</span> <span class="nx">from</span> <span class="o">!=</span> <span class="nx">showingFrom</span> <span class="o">||</span> <span class="nx">to</span> <span class="o">!=</span> <span class="nx">showingTo</span> <span class="o">||</span> <span class="nx">lastSizeC</span> <span class="o">!=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">+</span> <span class="nx">th</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>This is just a bogus formula that detects when the editor is
resized or the font size changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">different</span><span class="p">)</span> <span class="nx">lastSizeC</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">+</span> <span class="nx">th</span><span class="p">;</span>
      <span class="nx">showingFrom</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="nx">showingTo</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
      <span class="nx">displayOffset</span> <span class="o">=</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">);</span>
      <span class="nx">mover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="nx">displayOffset</span> <span class="o">*</span> <span class="nx">th</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="nx">code</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">th</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">paddingTop</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Since this is all rather error prone, it is honoured with the
only assertion in the whole file.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">showingTo</span> <span class="o">-</span> <span class="nx">showingFrom</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;BAD PATCH! &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">intact</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; size=&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">showingTo</span> <span class="o">-</span> <span class="nx">showingFrom</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot; nodes=&quot;</span> <span class="o">+</span> <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">maxWidth</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">curNode</span> <span class="o">=</span> <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">showingFrom</span><span class="p">,</span> <span class="nx">showingTo</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">curNode</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">/</span> <span class="nx">th</span><span class="p">)</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">!=</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span><span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span> <span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;}</span>
          <span class="p">}</span>
          <span class="nx">curNode</span> <span class="o">=</span> <span class="nx">curNode</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">maxWidth</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">maxWidth</span> <span class="o">=</span> <span class="nx">stringWidth</span><span class="p">(</span><span class="nx">maxLine</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">maxWidth</span> <span class="o">&gt;</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">maxWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Needed to prevent odd wrapping/hiding of widgets placed in here.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">code</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="nx">code</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">gutterDisplay</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">different</span> <span class="o">||</span> <span class="nx">gutterDirty</span><span class="p">)</span> <span class="nx">updateGutter</span><span class="p">();</span>
      <span class="nx">updateCursor</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">suppressCallback</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">computeIntact</span><span class="p">(</span><span class="nx">intact</span><span class="p">,</span> <span class="nx">changes</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">change</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">intact2</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">change</span><span class="p">.</span><span class="nx">diff</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l2</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">l2</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="nx">change</span><span class="p">.</span><span class="nx">diff</span><span class="p">)</span>
            <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">,</span>
                          <span class="nx">domStart</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">domStart</span><span class="p">});</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">||</span> <span class="nx">change</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span>
            <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">range</span><span class="p">);</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
              <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">domStart</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">domStart</span><span class="p">});</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span>
              <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">,</span>
                            <span class="nx">domStart</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">domStart</span> <span class="o">+</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">)});</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">intact</span> <span class="o">=</span> <span class="nx">intact2</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">intact</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">patchDisplay</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">intact</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>The first pass removes the DOM nodes that aren't intact.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">intact</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">killNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">tmp</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">domPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">curNode</span> <span class="o">=</span> <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">n</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">domStart</span> <span class="o">&gt;</span> <span class="nx">domPos</span><span class="p">)</span> <span class="p">{</span><span class="nx">curNode</span> <span class="o">=</span> <span class="nx">killNode</span><span class="p">(</span><span class="nx">curNode</span><span class="p">);</span> <span class="nx">domPos</span><span class="o">++</span><span class="p">;}</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span><span class="nx">curNode</span> <span class="o">=</span> <span class="nx">curNode</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span> <span class="nx">domPos</span><span class="o">++</span><span class="p">;}</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">curNode</span><span class="p">)</span> <span class="nx">curNode</span> <span class="o">=</span> <span class="nx">killNode</span><span class="p">(</span><span class="nx">curNode</span><span class="p">);</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>This pass fills in the lines that actually changed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">nextIntact</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">curNode</span> <span class="o">=</span> <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">sfrom</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sto</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">inSel</span> <span class="o">=</span> <span class="nx">sfrom</span> <span class="o">&lt;</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="nx">sto</span> <span class="o">&gt;=</span> <span class="nx">from</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">scratch</span> <span class="o">=</span> <span class="nx">targetDocument</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">),</span> <span class="nx">newElt</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ch1</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">ch2</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">inSel</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">ch1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sto</span> <span class="o">==</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span><span class="nx">inSel</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="nx">ch2</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">;}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sfrom</span> <span class="o">==</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sto</span> <span class="o">==</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span><span class="nx">ch1</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span> <span class="nx">ch2</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">;}</span>
          <span class="k">else</span> <span class="p">{</span><span class="nx">inSel</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">ch1</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">;}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nextIntact</span> <span class="o">&amp;&amp;</span> <span class="nx">nextIntact</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="nx">j</span><span class="p">)</span> <span class="nx">nextIntact</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nextIntact</span> <span class="o">||</span> <span class="nx">nextIntact</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="nx">scratch</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;pre&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
          <span class="k">else</span> <span class="nx">scratch</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">getHTML</span><span class="p">(</span><span class="nx">ch1</span><span class="p">,</span> <span class="nx">ch2</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">tabText</span><span class="p">);</span>
          <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">scratch</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">curNode</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">curNode</span> <span class="o">=</span> <span class="nx">curNode</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="o">++</span><span class="nx">j</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">updateGutter</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">hText</span> <span class="o">=</span> <span class="nx">mover</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">,</span> <span class="nx">hEditor</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
      <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hText</span> <span class="o">-</span> <span class="nx">hEditor</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">hEditor</span> <span class="o">:</span> <span class="nx">hText</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">showingFrom</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">showingFrom</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">showingTo</span><span class="p">,</span> <span class="nx">showingFrom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;pre&gt;&lt;/pre&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarker</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span> <span class="o">?</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">firstLineNumber</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">&amp;&amp;</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;%N%&quot;</span><span class="p">,</span> <span class="nx">text</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">text</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">text</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">;</span>
          <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="nx">marker</span> <span class="o">&amp;&amp;</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">style</span> <span class="o">?</span> <span class="s1">&#39;&lt;pre class=&quot;&#39;</span> <span class="o">+</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">style</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">:</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span><span class="p">),</span> <span class="nx">text</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;br/&gt;&amp;#160;&quot;</span><span class="p">);</span>
          <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="o">++</span><span class="nx">i</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
      <span class="nx">gutterText</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">minwidth</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="nx">firstNode</span> <span class="o">=</span> <span class="nx">gutterText</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">eltText</span><span class="p">(</span><span class="nx">firstNode</span><span class="p">),</span> <span class="nx">pad</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">pad</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">minwidth</span><span class="p">)</span> <span class="nx">pad</span> <span class="o">+=</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pad</span><span class="p">)</span> <span class="nx">firstNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">targetDocument</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">pad</span><span class="p">),</span> <span class="nx">firstNode</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
      <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">marginLeft</span> <span class="o">=</span> <span class="nx">gutter</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">updateCursor</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">head</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">lh</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">localCoords</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">wrapOff</span> <span class="o">=</span> <span class="nx">eltOffset</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">),</span> <span class="nx">lineOff</span> <span class="o">=</span> <span class="nx">eltOffset</span><span class="p">(</span><span class="nx">lineDiv</span><span class="p">);</span>
      <span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">lineOff</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">wrapOff</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">lineOff</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">wrapOff</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">setShift</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="nx">shiftSelecting</span> <span class="o">=</span> <span class="nx">shiftSelecting</span> <span class="o">||</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">shiftSelecting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">setSelectionUser</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sh</span> <span class="o">=</span> <span class="nx">shiftSelecting</span> <span class="o">&amp;&amp;</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">shiftSelecting</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sh</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">sh</span><span class="p">,</span> <span class="nx">from</span><span class="p">))</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">sh</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">sh</span><span class="p">))</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">sh</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">setSelection</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
      <span class="nx">userSelChange</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Update the selection. Last two args are only used by
updateLines, since they have to be expressed in the line
numbers before the update.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">setSelection</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">oldFrom</span><span class="p">,</span> <span class="nx">oldTo</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">goalColumn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">oldFrom</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span><span class="nx">oldFrom</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span> <span class="nx">oldTo</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">;}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">to</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">from</span><span class="p">))</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Skip over hidden lines.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">!=</span> <span class="nx">oldFrom</span><span class="p">)</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">skipHidden</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">oldFrom</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">!=</span> <span class="nx">oldTo</span><span class="p">)</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">skipHidden</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">oldTo</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">))</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">))</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Some ugly logic used to only mark the lines that actually did
see a change in selection as changed, rather than the whole
selected range.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span>
          <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">oldFrom</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">oldTo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="nx">oldFrom</span><span class="p">)</span>
            <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">oldFrom</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
          <span class="k">else</span>
            <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">oldFrom</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">oldTo</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="nx">oldTo</span><span class="p">)</span>
            <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">oldFrom</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">oldTo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
          <span class="k">else</span>
            <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">oldTo</span><span class="p">),</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
      <span class="nx">selectionChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">skipHidden</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">oldLine</span><span class="p">,</span> <span class="nx">oldCh</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">getNonHidden</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">lNo</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">lNo</span> <span class="o">!=</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">lNo</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">&gt;</span> <span class="nx">oldCh</span> <span class="o">||</span> <span class="nx">ch</span> <span class="o">&gt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">};</span>
          <span class="p">}</span>
          <span class="nx">lNo</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">&gt;=</span> <span class="nx">oldLine</span><span class="p">)</span> <span class="k">return</span> <span class="nx">getNonHidden</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="nx">getNonHidden</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">return</span> <span class="nx">getNonHidden</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="nx">getNonHidden</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">setCursor</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span> <span class="o">||</span> <span class="mi">0</span><span class="p">});</span>
      <span class="p">(</span><span class="nx">user</span> <span class="o">?</span> <span class="nx">setSelectionUser</span> <span class="o">:</span> <span class="nx">setSelection</span><span class="p">)(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">clipLine</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">));}</span>
    <span class="kd">function</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">&gt;=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">linelen</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">ch</span> <span class="o">&gt;</span> <span class="nx">linelen</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">linelen</span><span class="p">};</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
      <span class="k">else</span> <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">findPosH</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">end</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">findNextLine</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">line</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span> <span class="nx">l</span> <span class="o">!=</span> <span class="nx">e</span><span class="p">;</span> <span class="nx">l</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">lo</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lo</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">lo</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="kd">function</span> <span class="nx">moveOnce</span><span class="p">(</span><span class="nx">boundToLine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">==</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">boundToLine</span> <span class="o">&amp;&amp;</span> <span class="nx">findNextLine</span><span class="p">())</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">ch</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">)</span> <span class="nx">moveOnce</span><span class="p">();</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;column&quot;</span><span class="p">)</span> <span class="nx">moveOnce</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sawWord</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">moveOnce</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">isWordChar</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">ch</span><span class="p">)))</span> <span class="nx">sawWord</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sawWord</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="nx">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">moveOnce</span><span class="p">();}</span> <span class="k">break</span><span class="p">;}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">moveOnce</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">moveH</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">shiftSelecting</span> <span class="o">||</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">findPosH</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">);</span>
      <span class="nx">setCursor</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">deleteH</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">findPosH</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">),</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">findPosH</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">));</span>
      <span class="nx">userSelChange</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">goalColumn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">moveV</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">localCoords</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">goalColumn</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">goalColumn</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">)</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">dist</span> <span class="o">*</span> <span class="nx">dir</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">setCursor</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">target</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">goalColumn</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">selectWordAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">isWordChar</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">--</span><span class="nx">start</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">isWordChar</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">end</span><span class="p">)))</span> <span class="o">++</span><span class="nx">end</span><span class="p">;</span>
      <span class="nx">setSelectionUser</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">start</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">end</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">selectLine</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setSelectionUser</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">indentSelected</span><span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="k">return</span> <span class="nx">indentLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">indentLine</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">indentLine</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">how</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">how</span><span class="p">)</span> <span class="nx">how</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;smart&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mode</span><span class="p">.</span><span class="nx">indent</span><span class="p">)</span> <span class="nx">how</span> <span class="o">=</span> <span class="s2">&quot;prev&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="nx">curSpace</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indentation</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">),</span>
          <span class="nx">curSpaceString</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\s*/</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">indentation</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;prev&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">indentation</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;smart&quot;</span><span class="p">)</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">indent</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">curSpaceString</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">curSpace</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">indentUnit</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;subtract&quot;</span><span class="p">)</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">curSpace</span> <span class="o">-</span> <span class="nx">options</span><span class="p">.</span><span class="nx">indentUnit</span><span class="p">;</span>
      <span class="nx">indentation</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">indentation</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">indentation</span> <span class="o">-</span> <span class="nx">curSpace</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">diff</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">!=</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">!=</span> <span class="nx">n</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">indentString</span> <span class="o">=</span> <span class="nx">curSpaceString</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">indentString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">indentWithTabs</span><span class="p">)</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">indentation</span> <span class="o">/</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span> <span class="nx">i</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">;</span> <span class="nx">indentString</span> <span class="o">+=</span> <span class="s2">&quot;\t&quot;</span><span class="p">;}</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">indentation</span><span class="p">)</span> <span class="p">{</span><span class="o">++</span><span class="nx">pos</span><span class="p">;</span> <span class="nx">indentString</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="p">;}</span>
      <span class="p">}</span>

      <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">indentString</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">curSpaceString</span><span class="p">.</span><span class="nx">length</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">loadMode</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">mode</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">getMode</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mode</span><span class="p">);</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">});</span>
      <span class="nx">work</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">startWorker</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">gutterChanged</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">visible</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gutter</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span><span class="p">;</span>
      <span class="nx">gutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">visible</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">visible</span><span class="p">)</span> <span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">marginLeft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">wrappingChanged</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s2">&quot; CodeMirror-wrap&quot;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">perLine</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">/</span> <span class="nx">charWidth</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">guess</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">perLine</span><span class="p">)</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">guess</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">guess</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot; CodeMirror-wrap&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
        <span class="nx">maxWidth</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">maxLine</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">maxLine</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">maxLine</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">computeTabText</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>small change here below made by Davide Della Casa
Problem with that is that tabText itself is a span
which makes the function
below slow when the cursor moves accross lines with tabs
SO I've just replaced the tabText directly with two characters,
so moving the cursor and selecting and editing
accross lines with tabs is now fast and causes no glitches
on the other ongoing animations.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>for (var str = '<span class="cm-tab">', i = 0; i &lt; options.tabSize; ++i) str += " ";
return str + "</span>";</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="s2">&quot;\u25B6&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">tabsChanged</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">tabText</span> <span class="o">=</span> <span class="nx">computeTabText</span><span class="p">();</span>
      <span class="nx">updateDisplay</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">themeChanged</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">scroller</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s*cm-s-\w+/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">theme</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^|\s)\s*/g</span><span class="p">,</span> <span class="s2">&quot; cm-s-&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">TextMarker</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="p">[];</span> <span class="p">}</span>
    <span class="nx">TextMarker</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">min</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span> <span class="nx">max</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">mk</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mk</span> <span class="o">||</span> <span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">lineN</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="nx">min</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">lineN</span><span class="p">);</span> <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">max</span><span class="p">,</span> <span class="nx">lineN</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">mk</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">set</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">)</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">min</span> <span class="o">!=</span> <span class="kc">Infinity</span><span class="p">)</span>
        <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">min</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
    <span class="p">});</span>
    <span class="nx">TextMarker</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">mk</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">mark</span> <span class="o">=</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">set</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">from</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">from</span><span class="p">};</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">to</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span><span class="p">};</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">};</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">markText</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">from</span><span class="p">);</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">tm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextMarker</span><span class="p">();</span>
      <span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">).</span><span class="nx">addMark</span><span class="p">(</span><span class="k">new</span> <span class="nx">MarkedText</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">className</span><span class="p">,</span> <span class="nx">tm</span><span class="p">.</span><span class="nx">set</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="nx">add</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">className</span><span class="p">);</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">add</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">className</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="nx">add</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">className</span><span class="p">);</span>
        <span class="nx">add</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">className</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
      <span class="k">return</span> <span class="nx">tm</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">setBookmark</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">bm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bookmark</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
      <span class="nx">getLine</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">addMark</span><span class="p">(</span><span class="nx">bm</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">bm</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">addGutterMarker</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">line</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">clipLine</span><span class="p">(</span><span class="nx">line</span><span class="p">));</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarker</span> <span class="o">=</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">style</span><span class="o">:</span> <span class="nx">className</span><span class="p">};</span>
      <span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">removeGutterMarker</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">line</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">clipLine</span><span class="p">(</span><span class="nx">line</span><span class="p">));</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarker</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">changeLine</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">no</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">handle</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">clipLine</span><span class="p">(</span><span class="nx">handle</span><span class="p">));</span>
      <span class="k">else</span> <span class="nx">no</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">handle</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">no</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">no</span><span class="p">))</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">no</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
      <span class="k">else</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">setLineClass</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">changeLine</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">className</span> <span class="o">!=</span> <span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">line</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">className</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">setLineHidden</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">changeLine</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">no</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">!=</span> <span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">line</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="nx">hidden</span><span class="p">;</span>
          <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">hidden</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">hidden</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">no</span> <span class="o">||</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">no</span><span class="p">))</span>
            <span class="nx">setSelection</span><span class="p">(</span><span class="nx">skipHidden</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">),</span>
                         <span class="nx">skipHidden</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">));</span>
          <span class="k">return</span> <span class="p">(</span><span class="nx">gutterDirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">lineInfo</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">line</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
        <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarker</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">handle</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">markerText</span><span class="o">:</span> <span class="nx">marker</span> <span class="o">&amp;&amp;</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
              <span class="nx">markerClass</span><span class="o">:</span> <span class="nx">marker</span> <span class="o">&amp;&amp;</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">style</span><span class="p">,</span> <span class="nx">lineClass</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">className</span><span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">stringWidth</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">measure</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;pre&gt;&lt;span&gt;x&lt;/span&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
      <span class="nx">measure</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">measure</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">||</span> <span class="mi">10</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>These are used to go from pixel positions to character
positions, taking varying character widths into account.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">charFromX</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">line</span><span class="p">),</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">measure</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;pre&gt;&lt;span&gt;&quot;</span> <span class="o">+</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">getHTML</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">tabText</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">measure</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">toX</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Guess a suitable upper bound for our search.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">estimated</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">charWidth</span><span class="p">()));</span>
      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">estX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">estimated</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">estX</span> <span class="o">&lt;=</span> <span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">estimated</span> <span class="o">&lt;</span> <span class="nx">to</span><span class="p">)</span> <span class="nx">estimated</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">estimated</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">));</span>
        <span class="k">else</span> <span class="p">{</span><span class="nx">toX</span> <span class="o">=</span> <span class="nx">estX</span><span class="p">;</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">estimated</span><span class="p">;</span> <span class="k">break</span><span class="p">;}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">toX</span><span class="p">)</span> <span class="k">return</span> <span class="nx">to</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Try to guess a suitable lower bound as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">estimated</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">to</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">);</span> <span class="nx">estX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">estimated</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">estX</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">estimated</span><span class="p">;</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="nx">estX</span><span class="p">;}</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Do a binary search between these bounds.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">toX</span> <span class="o">-</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">fromX</span><span class="p">)</span> <span class="o">?</span> <span class="nx">from</span> <span class="o">:</span> <span class="nx">to</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">middle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">((</span><span class="nx">from</span> <span class="o">+</span> <span class="nx">to</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nx">middleX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">middle</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">middleX</span> <span class="o">&gt;</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">middle</span><span class="p">;</span> <span class="nx">toX</span> <span class="o">=</span> <span class="nx">middleX</span><span class="p">;}</span>
        <span class="k">else</span> <span class="p">{</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">middle</span><span class="p">;</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="nx">middleX</span><span class="p">;}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tempId</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mh">0xffffff</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">measureLine</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">extra</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Include extra text at the end to make sure the measured line is wrapped in the right way.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nx">extra</span> <span class="o">=</span> <span class="nx">htmlEscape</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">end</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ie</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span>
      <span class="p">}</span>
      <span class="nx">measure</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span> <span class="o">+</span> <span class="nx">line</span><span class="p">.</span><span class="nx">getHTML</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">tabText</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span> <span class="o">+</span>
        <span class="s1">&#39;&lt;span id=&quot;CodeMirror-temp-&#39;</span> <span class="o">+</span> <span class="nx">tempId</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">htmlEscape</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span> <span class="o">+</span>
        <span class="nx">extra</span> <span class="o">+</span> <span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">elt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;CodeMirror-temp-&quot;</span> <span class="o">+</span> <span class="nx">tempId</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">,</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Older IEs report zero offsets for spans directly after a wrap</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="nx">ch</span> <span class="o">&amp;&amp;</span> <span class="nx">top</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">backup</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">);</span>
        <span class="nx">backup</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">;</span>
        <span class="nx">elt</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">backup</span><span class="p">,</span> <span class="nx">elt</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
        <span class="nx">top</span> <span class="o">=</span> <span class="nx">backup</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">top</span><span class="o">:</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="nx">left</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">localCoords</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">inLineWrap</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">lh</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(),</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">lh</span> <span class="o">*</span> <span class="p">(</span><span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">inLineWrap</span> <span class="o">?</span> <span class="nx">displayOffset</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sp</span> <span class="o">=</span> <span class="nx">measureLine</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="nx">y</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">yBot</span><span class="o">:</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">lh</span><span class="p">};</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Coords must be lineSpace-local</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">th</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(),</span> <span class="nx">cw</span> <span class="o">=</span> <span class="nx">charWidth</span><span class="p">(),</span> <span class="nx">heightPos</span> <span class="o">=</span> <span class="nx">displayOffset</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">th</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">lineNo</span> <span class="o">=</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">heightPos</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lineNo</span> <span class="o">&gt;=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">lineNo</span><span class="p">),</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">tw</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">,</span> <span class="nx">innerOff</span> <span class="o">=</span> <span class="nx">tw</span> <span class="o">?</span> <span class="nx">heightPos</span> <span class="o">-</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">innerOff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
      <span class="kd">function</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sp</span> <span class="o">=</span> <span class="nx">measureLine</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">,</span> <span class="nx">len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tw</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">off</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">top</span> <span class="o">/</span> <span class="nx">th</span><span class="p">);</span>
          <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="p">(</span><span class="nx">off</span> <span class="o">-</span> <span class="nx">innerOff</span><span class="p">)</span> <span class="o">*</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">toX</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Guess a suitable upper bound for our search.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">estimated</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">((</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">innerOff</span> <span class="o">*</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">*</span> <span class="p">.</span><span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="nx">cw</span><span class="p">));</span>
      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">estX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">estimated</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">estX</span> <span class="o">&lt;=</span> <span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">estimated</span> <span class="o">&lt;</span> <span class="nx">to</span><span class="p">)</span> <span class="nx">estimated</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">estimated</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">));</span>
        <span class="k">else</span> <span class="p">{</span><span class="nx">toX</span> <span class="o">=</span> <span class="nx">estX</span><span class="p">;</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">estimated</span><span class="p">;</span> <span class="k">break</span><span class="p">;}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">toX</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">to</span><span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Try to guess a suitable lower bound as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">estimated</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">to</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">);</span> <span class="nx">estX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">estimated</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">estX</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">estimated</span><span class="p">;</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="nx">estX</span><span class="p">;}</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Do a binary search between these bounds.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="p">(</span><span class="nx">toX</span> <span class="o">-</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">fromX</span><span class="p">)</span> <span class="o">?</span> <span class="nx">from</span> <span class="o">:</span> <span class="nx">to</span><span class="p">};</span>
        <span class="kd">var</span> <span class="nx">middle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">((</span><span class="nx">from</span> <span class="o">+</span> <span class="nx">to</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nx">middleX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">middle</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">middleX</span> <span class="o">&gt;</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">middle</span><span class="p">;</span> <span class="nx">toX</span> <span class="o">=</span> <span class="nx">middleX</span><span class="p">;}</span>
        <span class="k">else</span> <span class="p">{</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">middle</span><span class="p">;</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="nx">middleX</span><span class="p">;}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">pageCoords</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">local</span> <span class="o">=</span> <span class="nx">localCoords</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="nx">off</span> <span class="o">=</span> <span class="nx">eltOffset</span><span class="p">(</span><span class="nx">lineSpace</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">off</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">local</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">off</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">local</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">yBot</span><span class="o">:</span> <span class="nx">off</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">local</span><span class="p">.</span><span class="nx">yBot</span><span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">cachedHeight</span><span class="p">,</span> <span class="nx">cachedHeightFor</span><span class="p">,</span> <span class="nx">measureText</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">textHeight</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">measureText</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">measureText</span> <span class="o">=</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">49</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">measureText</span> <span class="o">+=</span> <span class="s2">&quot;x&lt;br/&gt;&quot;</span><span class="p">;</span>
        <span class="nx">measureText</span> <span class="o">+=</span> <span class="s2">&quot;x&lt;/pre&gt;&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">offsetHeight</span> <span class="o">=</span> <span class="nx">lineDiv</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">offsetHeight</span> <span class="o">==</span> <span class="nx">cachedHeightFor</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cachedHeight</span><span class="p">;</span>
      <span class="nx">cachedHeightFor</span> <span class="o">=</span> <span class="nx">offsetHeight</span><span class="p">;</span>
      <span class="nx">measure</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">measureText</span><span class="p">;</span>
      <span class="nx">cachedHeight</span> <span class="o">=</span> <span class="nx">measure</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">/</span> <span class="mi">50</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">measure</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">cachedHeight</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">cachedWidth</span><span class="p">,</span> <span class="nx">cachedWidthFor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">charWidth</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">==</span> <span class="nx">cachedWidthFor</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cachedWidth</span><span class="p">;</span>
      <span class="nx">cachedWidthFor</span> <span class="o">=</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">cachedWidth</span> <span class="o">=</span> <span class="nx">stringWidth</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">paddingTop</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;}</span>
    <span class="kd">function</span> <span class="nx">paddingLeft</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">lineSpace</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;}</span>

    <span class="kd">function</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">liberal</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">offW</span> <span class="o">=</span> <span class="nx">eltOffset</span><span class="p">(</span><span class="nx">scroller</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Fails unpredictably on IE[67] when mouse is dragged around quickly.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">try</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">;</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">;</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>This is a mess of a heuristic to try and determine whether a
scroll-bar was clicked or not, and to return null if one was
(and !liberal).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">liberal</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">offW</span><span class="p">.</span><span class="nx">left</span> <span class="o">&gt;</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">||</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">offW</span><span class="p">.</span><span class="nx">top</span> <span class="o">&gt;</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">offL</span> <span class="o">=</span> <span class="nx">eltOffset</span><span class="p">(</span><span class="nx">lineSpace</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">offL</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">offL</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">onContextMenu</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pos</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Opera is difficult.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">||</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span>
        <span class="nx">operation</span><span class="p">(</span><span class="nx">setCursor</span><span class="p">)(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">oldCSS</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span><span class="p">;</span>
      <span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;absolute&quot;</span><span class="p">;</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="s2">&quot;position: fixed; width: 30px; height: 30px; top: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot;px; left: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px; z-index: 1000; background: white; &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);&quot;</span><span class="p">;</span>
      <span class="nx">leaveInputAlone</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">getSelection</span><span class="p">();</span>
      <span class="nx">focusInput</span><span class="p">();</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
      <span class="kd">function</span> <span class="nx">rehide</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newVal</span> <span class="o">=</span> <span class="nx">splitLines</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newVal</span> <span class="o">!=</span> <span class="nx">val</span><span class="p">)</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">replaceSelection</span><span class="p">)(</span><span class="nx">newVal</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">);</span>
        <span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;relative&quot;</span><span class="p">;</span>
        <span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="nx">oldCSS</span><span class="p">;</span>
        <span class="nx">leaveInputAlone</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">resetInput</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="nx">slowPoll</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">gecko</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e_stop</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">mouseup</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">mouseup</span><span class="p">();</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">rehide</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
        <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">rehide</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Cursor-blinking</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">restartBlink</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">blinker</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">blinker</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="p">(</span><span class="nx">on</span> <span class="o">=</span> <span class="o">!</span><span class="nx">on</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;hidden&quot;</span><span class="p">;</span>
      <span class="p">},</span> <span class="mi">650</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">matching</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;(&quot;</span><span class="o">:</span> <span class="s2">&quot;)&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="o">:</span> <span class="s2">&quot;(&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="o">:</span> <span class="s2">&quot;]&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="o">:</span> <span class="s2">&quot;[&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="o">:</span> <span class="s2">&quot;}&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="o">:</span> <span class="s2">&quot;{&lt;&quot;</span><span class="p">};</span>
    <span class="kd">function</span> <span class="nx">matchBrackets</span><span class="p">(</span><span class="nx">autoclear</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">head</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">inverted</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">head</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">head</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">matching</span><span class="p">[</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)])</span> <span class="o">||</span> <span class="nx">matching</span><span class="p">[</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="o">++</span><span class="nx">pos</span><span class="p">)];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">forward</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">forward</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">st</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">styles</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">off</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">off</span> <span class="o">-=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="k">break</span><span class="p">;}</span>

      <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)],</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/[(){}[\]]/</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">scan</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">forward</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">cur</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">forward</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">forward</span> <span class="o">?</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">!=</span> <span class="nx">e</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">d</span> <span class="o">*</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="k">continue</span><span class="p">;}</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">forward</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">te</span> <span class="o">=</span> <span class="nx">forward</span> <span class="o">?</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">!=</span> <span class="nx">te</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">pos</span><span class="o">+=</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;=</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">to</span> <span class="o">&amp;&amp;</span> <span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">cur</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">j</span><span class="p">)))</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">matching</span><span class="p">[</span><span class="nx">cur</span><span class="p">];</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">==</span> <span class="nx">forward</span><span class="p">)</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
              <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">return</span> <span class="p">{</span><span class="nx">pos</span><span class="o">:</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">match</span><span class="o">:</span> <span class="kc">false</span><span class="p">};</span>
              <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">pos</span><span class="o">:</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">match</span><span class="o">:</span> <span class="kc">true</span><span class="p">};</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">head</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">forward</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">100</span><span class="p">);</span> <span class="nx">i</span> <span class="o">!=</span> <span class="nx">e</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">head</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">scan</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="nx">forward</span> <span class="o">?</span> <span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">forward</span> <span class="o">?</span> <span class="nx">pos</span> <span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">found</span> <span class="o">=</span> <span class="p">{</span><span class="nx">pos</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">match</span><span class="o">:</span> <span class="kc">false</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">found</span><span class="p">.</span><span class="nx">match</span> <span class="o">?</span> <span class="s2">&quot;CodeMirror-matchingbracket&quot;</span> <span class="o">:</span> <span class="s2">&quot;CodeMirror-nonmatchingbracket&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">one</span> <span class="o">=</span> <span class="nx">markText</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">head</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">pos</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">head</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">},</span> <span class="nx">style</span><span class="p">),</span>
          <span class="nx">two</span> <span class="o">=</span> <span class="nx">found</span><span class="p">.</span><span class="nx">pos</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">markText</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">found</span><span class="p">.</span><span class="nx">pos</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">found</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">},</span> <span class="nx">style</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">clear</span> <span class="o">=</span> <span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">one</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span> <span class="nx">two</span> <span class="o">&amp;&amp;</span> <span class="nx">two</span><span class="p">.</span><span class="nx">clear</span><span class="p">();});</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">autoclear</span><span class="p">)</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">clear</span><span class="p">,</span> <span class="mi">800</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">bracketHighlighted</span> <span class="o">=</span> <span class="nx">clear</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Finds the line to start with when starting a parse. Tries to
find a line with a stateAfter, so that it can start with a
valid state. If that fails, it returns the line with the
smallest indentation, which tends to need the least context to
parse correctly.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">findStartLine</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">minindent</span><span class="p">,</span> <span class="nx">minline</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">search</span> <span class="o">=</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">lim</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span> <span class="nx">search</span> <span class="o">&gt;</span> <span class="nx">lim</span><span class="p">;</span> <span class="o">--</span><span class="nx">search</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">search</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span><span class="p">)</span> <span class="k">return</span> <span class="nx">search</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">indented</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indentation</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">minline</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">minindent</span> <span class="o">&gt;</span> <span class="nx">indented</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">minline</span> <span class="o">=</span> <span class="nx">search</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">minindent</span> <span class="o">=</span> <span class="nx">indented</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">minline</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">findStartLine</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">&amp;&amp;</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">start</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">stateAfter</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">startState</span><span class="p">(</span><span class="nx">mode</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">highlight</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">n</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">stateAfter</span><span class="p">)</span> <span class="nx">work</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">highlightLines</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">highlight</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">highlightWorker</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">workTime</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">foundWork</span> <span class="o">=</span> <span class="nx">work</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">work</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">showingFrom</span><span class="p">).</span><span class="nx">stateAfter</span><span class="p">)</span> <span class="kd">var</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">showingFrom</span><span class="p">;</span>
        <span class="k">else</span> <span class="kd">var</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">work</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">task</span> <span class="o">&gt;=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">findStartLine</span><span class="p">(</span><span class="nx">task</span><span class="p">),</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">&amp;&amp;</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">start</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">stateAfter</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">startState</span><span class="p">(</span><span class="nx">mode</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">unchanged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">compare</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">compareStates</span><span class="p">,</span> <span class="nx">realChange</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">i</span> <span class="o">=</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">bail</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">hadState</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span> <span class="o">&gt;</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">work</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
            <span class="nx">startWorker</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">workDelay</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">realChange</span><span class="p">)</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">bail</span> <span class="o">=</span> <span class="kc">true</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">highlight</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">changed</span><span class="p">)</span> <span class="nx">realChange</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">compare</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">hadState</span> <span class="o">&amp;&amp;</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">hadState</span><span class="p">,</span> <span class="nx">state</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">changed</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">||</span> <span class="o">!</span><span class="nx">hadState</span><span class="p">)</span> <span class="nx">unchanged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">unchanged</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">mode</span><span class="p">.</span><span class="nx">indent</span> <span class="o">||</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">indent</span><span class="p">(</span><span class="nx">hadState</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">indent</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
              <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="o">++</span><span class="nx">i</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">bail</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">realChange</span><span class="p">)</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">foundWork</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onHighlightComplete</span><span class="p">)</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">onHighlightComplete</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">startWorker</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">work</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">highlight</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">highlightWorker</span><span class="p">));</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Operations are used to wrap changes in such a way that each
change won't have to update the cursor and display (which would
be awkward, slow, and error-prone), but instead updates are
batched and then all combined and executed at once.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">startOperation</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">updateInput</span> <span class="o">=</span> <span class="nx">userSelChange</span> <span class="o">=</span> <span class="nx">textChanged</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">changes</span> <span class="o">=</span> <span class="p">[];</span> <span class="nx">selectionChanged</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="nx">callbacks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">endOperation</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">reScroll</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">updated</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">selectionChanged</span><span class="p">)</span> <span class="nx">reScroll</span> <span class="o">=</span> <span class="o">!</span><span class="nx">scrollCursorIntoView</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">updated</span> <span class="o">=</span> <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">changes</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">selectionChanged</span><span class="p">)</span> <span class="nx">updateCursor</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">gutterDirty</span><span class="p">)</span> <span class="nx">updateGutter</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">reScroll</span><span class="p">)</span> <span class="nx">scrollCursorIntoView</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">selectionChanged</span><span class="p">)</span> <span class="p">{</span><span class="nx">scrollEditorIntoView</span><span class="p">();</span> <span class="nx">restartBlink</span><span class="p">();}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">focused</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">leaveInputAlone</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="nx">updateInput</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="p">(</span><span class="nx">updateInput</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">selectionChanged</span><span class="p">)))</span>
        <span class="nx">resetInput</span><span class="p">(</span><span class="nx">userSelChange</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">selectionChanged</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">matchBrackets</span><span class="p">)</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">operation</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">bracketHighlighted</span><span class="p">)</span> <span class="p">{</span><span class="nx">bracketHighlighted</span><span class="p">();</span> <span class="nx">bracketHighlighted</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">matchBrackets</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}),</span> <span class="mi">20</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">tc</span> <span class="o">=</span> <span class="nx">textChanged</span><span class="p">,</span> <span class="nx">cbs</span> <span class="o">=</span> <span class="nx">callbacks</span><span class="p">;</span> <span class="c1">// these can be reset by callbacks</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">selectionChanged</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onCursorActivity</span><span class="p">)</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">onCursorActivity</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tc</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onChange</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">)</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">onChange</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">tc</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">cbs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">cbs</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">instance</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">updated</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">nestedOperation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nestedOperation</span><span class="o">++</span><span class="p">)</span> <span class="nx">startOperation</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);}</span>
        <span class="k">finally</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="nx">nestedOperation</span><span class="p">)</span> <span class="nx">endOperation</span><span class="p">();}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ext</span> <span class="k">in</span> <span class="nx">extensions</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">extensions</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">(</span><span class="nx">ext</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="o">!</span><span class="nx">instance</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">(</span><span class="nx">ext</span><span class="p">))</span>
        <span class="nx">instance</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extensions</span><span class="p">[</span><span class="nx">ext</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">instance</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// (end of function CodeMirror)</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>The default configuration options.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">mode</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">theme</span><span class="o">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="nx">indentUnit</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">indentWithTabs</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">tabSize</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nx">keyMap</span><span class="o">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="nx">extraKeys</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">electricChars</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">onKeyEvent</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">lineWrapping</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">lineNumbers</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">gutter</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">fixedGutter</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">firstLineNumber</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">readOnly</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">onChange</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">onCursorActivity</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">onGutterClick</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">onHighlightComplete</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">onUpdate</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">onFocus</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">onBlur</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">onScroll</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">matchBrackets</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">workTime</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="nx">workDelay</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">pollInterval</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="nx">undoDepth</span><span class="o">:</span> <span class="mi">40</span><span class="p">,</span>
    <span class="nx">tabindex</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nb">document</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">mac</span> <span class="o">=</span> <span class="sr">/Mac/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">win</span> <span class="o">=</span> <span class="sr">/Win/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Known modes, by name and by MIME</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">modes</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">mimeModes</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="nx">modes</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMIME</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mime</span><span class="p">,</span> <span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mimeModes</span><span class="p">[</span><span class="nx">mime</span><span class="p">]</span> <span class="o">=</span> <span class="nx">spec</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">getMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">spec</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">mimeModes</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">spec</span><span class="p">))</span>
      <span class="nx">spec</span> <span class="o">=</span> <span class="nx">mimeModes</span><span class="p">[</span><span class="nx">spec</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">spec</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>
      <span class="kd">var</span> <span class="nx">mname</span> <span class="o">=</span> <span class="nx">spec</span><span class="p">,</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">spec</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
      <span class="kd">var</span> <span class="nx">mname</span> <span class="o">=</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">spec</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">mfactory</span> <span class="o">=</span> <span class="nx">modes</span><span class="p">[</span><span class="nx">mname</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mfactory</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;No mode &quot;</span> <span class="o">+</span> <span class="nx">mname</span> <span class="o">+</span> <span class="s2">&quot; found, falling back to plain text.&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">getMode</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">mfactory</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">config</span> <span class="o">||</span> <span class="p">{});</span>
  <span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">listModes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">m</span> <span class="k">in</span> <span class="nx">modes</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">modes</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span> <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">list</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">listMIMEs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">m</span> <span class="k">in</span> <span class="nx">mimeModes</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mimeModes</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span> <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">mime</span><span class="o">:</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="nx">mimeModes</span><span class="p">[</span><span class="nx">m</span><span class="p">]});</span>
    <span class="k">return</span> <span class="nx">list</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">extensions</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">extensions</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineExtension</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">extensions</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">commands</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">commands</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">selectAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">setSelection</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">lineCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">});},</span>
    <span class="nx">killLine</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span> <span class="nx">sel</span> <span class="o">=</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sel</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">});</span>
      <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span> <span class="o">?</span> <span class="nx">to</span> <span class="o">:</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">deleteLine</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">l</span><span class="p">});},</span>
    <span class="nx">undo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">undo</span><span class="p">();},</span>
    <span class="nx">redo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">redo</span><span class="p">();},</span>
    <span class="nx">goDocStart</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">setCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);},</span>
    <span class="nx">goDocEnd</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">setSelection</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">lineCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);},</span>
    <span class="nx">goLineStart</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">setCursor</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);},</span>
    <span class="nx">goLineStartSmart</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">firstNonWS</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">text</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\S/</span><span class="p">));</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">setCursor</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;=</span> <span class="nx">firstNonWS</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">firstNonWS</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">goLineEnd</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">setSelection</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);},</span>
    <span class="nx">goLineUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">);},</span>
    <span class="nx">goLineDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">);},</span>
    <span class="nx">goPageUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">);},</span>
    <span class="nx">goPageDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">);},</span>
    <span class="nx">goCharLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">goCharRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">goColumnLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;column&quot;</span><span class="p">);},</span>
    <span class="nx">goColumnRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;column&quot;</span><span class="p">);},</span>
    <span class="nx">goWordLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">goWordRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">delCharLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">delCharRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">delWordLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">delWordRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">indentAuto</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">indentSelection</span><span class="p">(</span><span class="s2">&quot;smart&quot;</span><span class="p">);},</span>
    <span class="nx">indentMore</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">indentSelection</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">);},</span>
    <span class="nx">indentLess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">indentSelection</span><span class="p">(</span><span class="s2">&quot;subtract&quot;</span><span class="p">);},</span>
    <span class="nx">insertTab</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">);},</span>
    <span class="nx">transposeChars</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(),</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="o">+</span> <span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">newlineAndIndent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">);</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">indentLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">toggleOverwrite</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">toggleOverwrite</span><span class="p">();}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">keyMap</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">keyMap</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">basic</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineUp&quot;</span><span class="p">,</span> <span class="s2">&quot;Down&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineDown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;End&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Home&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStartSmart&quot;</span><span class="p">,</span> <span class="s2">&quot;PageUp&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageUp&quot;</span><span class="p">,</span> <span class="s2">&quot;PageDown&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageDown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Delete&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Tab&quot;</span><span class="o">:</span> <span class="s2">&quot;indentMore&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Tab&quot;</span><span class="o">:</span> <span class="s2">&quot;indentLess&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Enter&quot;</span><span class="o">:</span> <span class="s2">&quot;newlineAndIndent&quot;</span><span class="p">,</span> <span class="s2">&quot;Insert&quot;</span><span class="o">:</span> <span class="s2">&quot;toggleOverwrite&quot;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Note that the save and find-related commands aren't defined by
default. Unknown commands are simply ignored.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">pcDefault</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Ctrl-A&quot;</span><span class="o">:</span> <span class="s2">&quot;selectAll&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-D&quot;</span><span class="o">:</span> <span class="s2">&quot;deleteLine&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;undo&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Y&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Home&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Up&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-End&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Down&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Delete&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-S&quot;</span><span class="o">:</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-F&quot;</span><span class="o">:</span> <span class="s2">&quot;find&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findNext&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findPrev&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-F&quot;</span><span class="o">:</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-R&quot;</span><span class="o">:</span> <span class="s2">&quot;replaceAll&quot;</span><span class="p">,</span>
    <span class="nx">fallthrough</span><span class="o">:</span> <span class="s2">&quot;basic&quot;</span>
  <span class="p">};</span>
  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">macDefault</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Cmd-A&quot;</span><span class="o">:</span> <span class="s2">&quot;selectAll&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-D&quot;</span><span class="o">:</span> <span class="s2">&quot;deleteLine&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;undo&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Cmd-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Y&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cmd-Up&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-End&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Down&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordLeft&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Alt-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordLeft&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Alt-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Delete&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-S&quot;</span><span class="o">:</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-F&quot;</span><span class="o">:</span> <span class="s2">&quot;find&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cmd-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findNext&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Cmd-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findPrev&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Alt-F&quot;</span><span class="o">:</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Cmd-Alt-F&quot;</span><span class="o">:</span> <span class="s2">&quot;replaceAll&quot;</span><span class="p">,</span>
    <span class="nx">fallthrough</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;emacsy&quot;</span><span class="p">]</span>
  <span class="p">};</span>
  <span class="nx">keyMap</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mac</span> <span class="o">?</span> <span class="nx">keyMap</span><span class="p">.</span><span class="nx">macDefault</span> <span class="o">:</span> <span class="nx">keyMap</span><span class="p">.</span><span class="nx">pcDefault</span><span class="p">;</span>
  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">emacsy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Ctrl-F&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-B&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-P&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineUp&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-N&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineDown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Alt-F&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-B&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-A&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-E&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-V&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageUp&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-V&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageDown&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-D&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-H&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharLeft&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Alt-D&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-K&quot;</span><span class="o">:</span> <span class="s2">&quot;killLine&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-T&quot;</span><span class="o">:</span> <span class="s2">&quot;transposeChars&quot;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">extraMap</span><span class="p">,</span> <span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">ft</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ft</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">ft</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">fallthrough</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ft</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">map</span><span class="p">.</span><span class="nx">catchall</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">ft</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">ft</span><span class="p">]);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">ft</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">found</span> <span class="o">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">ft</span><span class="p">[</span><span class="nx">i</span><span class="p">]]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">extraMap</span> <span class="o">?</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">extraMap</span><span class="p">,</span> <span class="nx">map</span><span class="p">)</span> <span class="o">:</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">map</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">isModifierKey</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Ctrl&quot;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Alt&quot;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Shift&quot;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Mod&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">fromTextArea</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">textarea</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">)</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabindex</span> <span class="o">&amp;&amp;</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">tabindex</span><span class="p">)</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">tabindex</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">tabindex</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">save</span><span class="p">()</span> <span class="p">{</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Deplorable hack to make the submit method do the right thing.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">rmSubmit</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">,</span> <span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nx">save</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">realSubmit</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">wrappedSubmit</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">save</span><span class="p">();</span>
          <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">realSubmit</span><span class="p">;</span>
          <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
          <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">wrappedSubmit</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">wrappedSubmit</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">textarea</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">options</span><span class="p">);</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="nx">save</span><span class="p">;</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">getTextArea</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">textarea</span><span class="p">;</span> <span class="p">};</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">toTextArea</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">save</span><span class="p">();</span>
      <span class="nx">textarea</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">getWrapperElement</span><span class="p">());</span>
      <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rmSubmit</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
          <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">realSubmit</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">instance</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Utility functions for working with state. Exported because modes
sometimes need to do this.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span><span class="p">.</span><span class="nx">copyState</span><span class="p">)</span> <span class="k">return</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">copyState</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">nstate</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">concat</span><span class="p">([]);</span>
      <span class="nx">nstate</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nstate</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">copyState</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">startState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">startState</span> <span class="o">?</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">startState</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">)</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">startState</span> <span class="o">=</span> <span class="nx">startState</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>The character stream used by a mode's parser.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">StringStream</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">string</span> <span class="o">=</span> <span class="nx">string</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tabSize</span> <span class="o">=</span> <span class="nx">tabSize</span> <span class="o">||</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">StringStream</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">eol</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;},</span>
    <span class="nx">sol</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;},</span>
    <span class="nx">peek</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);},</span>
    <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="o">++</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">eat</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">match</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="kd">var</span> <span class="nx">ok</span> <span class="o">=</span> <span class="nx">ch</span> <span class="o">==</span> <span class="nx">match</span><span class="p">;</span>
      <span class="k">else</span> <span class="kd">var</span> <span class="nx">ok</span> <span class="o">=</span> <span class="nx">ch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">test</span> <span class="o">?</span> <span class="nx">match</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">:</span> <span class="nx">match</span><span class="p">(</span><span class="nx">ch</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span><span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span> <span class="k">return</span> <span class="nx">ch</span><span class="p">;}</span>
    <span class="p">},</span>
    <span class="nx">eatWhile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eat</span><span class="p">(</span><span class="nx">match</span><span class="p">)){}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">start</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">eatSpace</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="sr">/[\s\u00a0]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)))</span> <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">start</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">skipToEnd</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;},</span>
    <span class="nx">skipTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="nx">found</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;}</span>
    <span class="p">},</span>
    <span class="nx">backUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;},</span>
    <span class="nx">column</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">countColumn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);},</span>
    <span class="nx">indentation</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">countColumn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);},</span>
    <span class="nx">match</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">consume</span><span class="p">,</span> <span class="nx">caseInsensitive</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pattern</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">cased</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">caseInsensitive</span> <span class="o">?</span> <span class="nx">str</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">:</span> <span class="nx">str</span><span class="p">;}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cased</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">cased</span><span class="p">(</span><span class="nx">pattern</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">consume</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">&amp;&amp;</span> <span class="nx">consume</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">current</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);}</span>
  <span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">StringStream</span> <span class="o">=</span> <span class="nx">StringStream</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">MarkedText</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">className</span><span class="p">,</span> <span class="nx">set</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="nx">className</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="nx">set</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">MarkedText</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">attach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">detach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ix</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ix</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">ix</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">split</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">lenBefore</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;=</span> <span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">pos</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">lenBefore</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">lenBefore</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">MarkedText</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">dup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">MarkedText</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">clipTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fromOpen</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">toOpen</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">diff</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;=</span> <span class="nx">from</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">from</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">diff</span> <span class="o">:</span> <span class="nx">from</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">fromOpen</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">to</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span><span class="p">))</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">toOpen</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span><span class="p">))</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">isDead</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">sameSet</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span> <span class="o">==</span> <span class="nx">x</span><span class="p">.</span><span class="nx">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">Bookmark</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">Bookmark</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">attach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">detach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">line</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">split</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">lenBefore</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">)</span> <span class="o">+</span> <span class="nx">lenBefore</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">isDead</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">clipTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fromOpen</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">toOpen</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">diff</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">fromOpen</span> <span class="o">||</span> <span class="nx">from</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">toOpen</span> <span class="o">||</span> <span class="nx">to</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">sameSet</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">find</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">line</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">line</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">ch</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span><span class="p">};</span>
    <span class="p">},</span>
    <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">line</span><span class="p">.</span><span class="nx">marked</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">line</span><span class="p">.</span><span class="nx">marked</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">found</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Line objects. These hold state related to a line, including
highlighting info (the styles array).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">styles</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">styles</span> <span class="o">=</span> <span class="nx">styles</span> <span class="o">||</span> <span class="p">[</span><span class="nx">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">marked</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gutterMarker</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">Line</span><span class="p">.</span><span class="nx">inheritMarks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">orig</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ln</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span> <span class="nx">mk</span> <span class="o">=</span> <span class="nx">orig</span> <span class="o">&amp;&amp;</span> <span class="nx">orig</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mk</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">newmk</span> <span class="o">=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">marked</span> <span class="o">||</span> <span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">marked</span> <span class="o">=</span> <span class="p">[]),</span> <span class="nx">mark</span> <span class="o">=</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">nmark</span> <span class="o">=</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">dup</span><span class="p">();</span> <span class="nx">newmk</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">nmark</span><span class="p">);</span> <span class="nx">nmark</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">ln</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ln</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">Line</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Replace a piece of a line, keeping the styles around it intact.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">replace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to_</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">mk</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">,</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">to_</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">to_</span><span class="p">;</span>
      <span class="nx">copyStyles</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">st</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="nx">st</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">copyStyles</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">st</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">styles</span> <span class="o">=</span> <span class="nx">st</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="o">+</span> <span class="nx">text</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mk</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">mark</span> <span class="o">=</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">mark</span><span class="p">.</span><span class="nx">clipTo</span><span class="p">(</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">from</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">to_</span> <span class="o">==</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">diff</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">isDead</span><span class="p">())</span> <span class="p">{</span><span class="nx">mark</span><span class="p">.</span><span class="nx">detach</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Split a part off a line, keeping styles and markers intact.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">split</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">textBefore</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="p">[</span><span class="nx">textBefore</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span> <span class="nx">mk</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
      <span class="nx">copyStyles</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">st</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">taken</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Line</span><span class="p">(</span><span class="nx">textBefore</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">),</span> <span class="nx">st</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mk</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">mark</span> <span class="o">=</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">newmark</span> <span class="o">=</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">textBefore</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">newmark</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">taken</span><span class="p">.</span><span class="nx">marked</span><span class="p">)</span> <span class="nx">taken</span><span class="p">.</span><span class="nx">marked</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nx">taken</span><span class="p">.</span><span class="nx">marked</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newmark</span><span class="p">);</span> <span class="nx">newmark</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">taken</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">taken</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">append</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">mylen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">mk</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">marked</span><span class="p">,</span> <span class="nx">mymk</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">+=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
      <span class="nx">copyStyles</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mymk</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mymk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">mymk</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">mymk</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">mylen</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mk</span> <span class="o">&amp;&amp;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mymk</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span> <span class="o">=</span> <span class="nx">mymk</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">outer</span><span class="o">:</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">mark</span> <span class="o">=</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mark</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">mymk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">mymark</span> <span class="o">=</span> <span class="nx">mymk</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">mymark</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="nx">mylen</span> <span class="o">&amp;&amp;</span> <span class="nx">mymark</span><span class="p">.</span><span class="nx">sameSet</span><span class="p">(</span><span class="nx">mark</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">mymark</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">mylen</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mymark</span><span class="p">.</span><span class="nx">isDead</span><span class="p">())</span> <span class="p">{</span>
                  <span class="nx">mymark</span><span class="p">.</span><span class="nx">detach</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                  <span class="nx">mk</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">continue</span> <span class="nx">outer</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">mymk</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mark</span><span class="p">);</span>
          <span class="nx">mark</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
          <span class="nx">mark</span><span class="p">.</span><span class="nx">from</span> <span class="o">+=</span> <span class="nx">mylen</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">+=</span> <span class="nx">mylen</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">fixMarkEnds</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">mk</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">,</span> <span class="nx">omk</span> <span class="o">=</span> <span class="nx">other</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mk</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mark</span> <span class="o">=</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">close</span> <span class="o">=</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">close</span> <span class="o">&amp;&amp;</span> <span class="nx">omk</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">omk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">omk</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">sameSet</span><span class="p">(</span><span class="nx">mark</span><span class="p">))</span> <span class="p">{</span><span class="nx">close</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">break</span><span class="p">;}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">close</span><span class="p">)</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">fixMarkStarts</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">mk</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mk</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">mk</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">addMark</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mark</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">mark</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">marked</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mark</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">from</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">from</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);});</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Run the given mode's parser over a line, update the styles
array, which contains alternating fragments of text and CSS
classes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">highlight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StringStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">),</span> <span class="nx">st</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">curWord</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">prevWord</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">blankLine</span><span class="p">)</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">blankLine</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">eol</span><span class="p">())</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">token</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">substr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">style</span><span class="p">)</span>
          <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">substr</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">changed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">style</span> <span class="o">||</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">prevWord</span><span class="p">)))</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">;</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">style</span><span class="p">;</span>
          <span class="nx">prevWord</span> <span class="o">=</span> <span class="nx">curWord</span><span class="p">;</span> <span class="nx">curWord</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="p">];</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Give up when line is ridiculously long</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span><span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">prevWord</span><span class="p">)</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Short lines with simple highlights return null, and are
counted as changed by the driver because they are likely to
highlight the same way in various contexts.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">changed</span> <span class="o">||</span> <span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Fetch the parser token for a given character. Useful for hacks
that want to inspect the mode state (say, for completion).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">getTokenAt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StringStream</span><span class="p">(</span><span class="nx">txt</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">ch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">eol</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">token</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
              <span class="nx">end</span><span class="o">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span>
              <span class="nx">string</span><span class="o">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
              <span class="nx">className</span><span class="o">:</span> <span class="nx">style</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span>
              <span class="nx">state</span><span class="o">:</span> <span class="nx">state</span><span class="p">};</span>
    <span class="p">},</span>
    <span class="nx">indentation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tabSize</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">countColumn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">);},</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Produces an HTML fragment for the line, taking selection,
marking, and highlighting into account.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">getHTML</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sfrom</span><span class="p">,</span> <span class="nx">sto</span><span class="p">,</span> <span class="nx">includePre</span><span class="p">,</span> <span class="nx">tabText</span><span class="p">,</span> <span class="nx">endAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">first</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">includePre</span><span class="p">)</span>
        <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">?</span> <span class="s1">&#39;&lt;pre class=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="o">:</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">span</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">text</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Work around a bug where, in some compat modes, IE ignores leading spaces</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;\u00a0&quot;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="nx">first</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&lt;span class=&quot;&#39;</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">,</span> <span class="nx">htmlEscape</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t/g</span><span class="p">,</span> <span class="nx">tabText</span><span class="p">),</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&lt;span class=&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">,</span> <span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">,</span> <span class="nx">htmlEscape</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t/g</span><span class="p">,</span> <span class="nx">tabText</span><span class="p">),</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>else html.push(htmlEscape(text).replace(/\t/g, tabText));</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">allText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">marked</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sfrom</span> <span class="o">==</span> <span class="nx">sto</span><span class="p">)</span> <span class="nx">sfrom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">allText</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">endAt</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">len</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">endAt</span><span class="p">,</span> <span class="nx">len</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">allText</span> <span class="o">&amp;&amp;</span> <span class="nx">endAt</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
        <span class="nx">span</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nx">sfrom</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">sto</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s2">&quot;CodeMirror-selected&quot;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">marked</span> <span class="o">&amp;&amp;</span> <span class="nx">sfrom</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ch</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">+</span> <span class="nx">l</span> <span class="o">&gt;</span> <span class="nx">len</span><span class="p">)</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">-</span> <span class="nx">ch</span><span class="p">);</span>
          <span class="nx">ch</span> <span class="o">+=</span> <span class="nx">l</span><span class="p">;</span>
          <span class="nx">span</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">style</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;cm-&quot;</span> <span class="o">+</span> <span class="nx">style</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">markpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mark</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">nextMark</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">marked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">markpos</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">mark</span> <span class="o">=</span> <span class="p">(</span><span class="nx">markpos</span> <span class="o">&lt;</span> <span class="nx">marked</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="nx">marked</span><span class="p">[</span><span class="nx">markpos</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">nextMark</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">upto</span> <span class="o">=</span> <span class="nx">len</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">extraStyle</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sfrom</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sfrom</span> <span class="o">&gt;</span> <span class="nx">pos</span><span class="p">)</span> <span class="nx">upto</span> <span class="o">=</span> <span class="nx">sfrom</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sto</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">sto</span> <span class="o">&gt;</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">extraStyle</span> <span class="o">=</span> <span class="s2">&quot; CodeMirror-selected&quot;</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">sto</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">upto</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">upto</span><span class="p">,</span> <span class="nx">sto</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">mark</span> <span class="o">&amp;&amp;</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;=</span> <span class="nx">pos</span><span class="p">)</span> <span class="nx">nextMark</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">pos</span><span class="p">)</span> <span class="nx">upto</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">upto</span><span class="p">,</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">extraStyle</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">upto</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">upto</span><span class="p">,</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">appliedStyle</span> <span class="o">=</span> <span class="nx">style</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">extraStyle</span><span class="p">)</span> <span class="nx">appliedStyle</span> <span class="o">=</span> <span class="nx">style</span> <span class="o">?</span> <span class="nx">style</span> <span class="o">+</span> <span class="nx">extraStyle</span> <span class="o">:</span> <span class="nx">extraStyle</span><span class="p">;</span>
            <span class="nx">span</span><span class="p">(</span><span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">upto</span> <span class="o">?</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">upto</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">)</span> <span class="o">:</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">appliedStyle</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&gt;=</span> <span class="nx">upto</span><span class="p">)</span> <span class="p">{</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">upto</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">);</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">upto</span><span class="p">;</span> <span class="k">break</span><span class="p">;}</span>
            <span class="nx">pos</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span> <span class="nx">style</span> <span class="o">=</span> <span class="s2">&quot;cm-&quot;</span> <span class="o">+</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">sfrom</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">sto</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">span</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-selected&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">includePre</span><span class="p">)</span> <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">html</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">cleanUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">marked</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">detach</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Utility used by replace and split above</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">copyStyles</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">dest</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">to</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">part</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">part</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">from</span><span class="p">)</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">to</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">)),</span> <span class="nx">source</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&gt;=</span> <span class="nx">from</span><span class="p">)</span> <span class="nx">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">to</span><span class="p">)</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">to</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">),</span> <span class="nx">source</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">else</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">part</span><span class="p">,</span> <span class="nx">source</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Data structure that holds the sequence of lines.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">LeafChunk</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">height</span> <span class="o">+=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">height</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">LeafChunk</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">chunkSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">at</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">at</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">cleanUp</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">handlers</span><span class="p">)</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">collapse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span> <span class="p">[</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">insertHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">height</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">,</span> <span class="p">[</span><span class="nx">at</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">lines</span><span class="p">));</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">iterN</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">at</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">at</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">at</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">at</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">BranchChunk</span><span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">children</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">size</span> <span class="o">+=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span> <span class="nx">height</span> <span class="o">+=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="nx">ch</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">BranchChunk</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">chunkSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">at</span> <span class="o">&lt;</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">rm</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">sz</span> <span class="o">-</span> <span class="nx">at</span><span class="p">),</span> <span class="nx">oldHeight</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
          <span class="nx">child</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">rm</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">oldHeight</span> <span class="o">-</span> <span class="nx">child</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sz</span> <span class="o">==</span> <span class="nx">rm</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="nx">child</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">n</span> <span class="o">-=</span> <span class="nx">rm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="nx">at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">at</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">collapse</span><span class="p">(</span><span class="nx">lines</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="k">new</span> <span class="nx">LeafChunk</span><span class="p">(</span><span class="nx">lines</span><span class="p">)];</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">collapse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapse</span><span class="p">(</span><span class="nx">lines</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">height</span> <span class="o">+=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">height</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">insertHeight</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">insertHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">+=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">height</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">at</span> <span class="o">&lt;=</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">child</span><span class="p">.</span><span class="nx">insertHeight</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">lines</span> <span class="o">&amp;&amp;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">spilled</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">newleaf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LeafChunk</span><span class="p">(</span><span class="nx">spilled</span><span class="p">);</span>
              <span class="nx">child</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">newleaf</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">newleaf</span><span class="p">);</span>
              <span class="nx">newleaf</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">maybeSpill</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">at</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">maybeSpill</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">spilled</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">sibling</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BranchChunk</span><span class="p">(</span><span class="nx">spilled</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Become the parent node</span>
          <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BranchChunk</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
          <span class="nx">copy</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">me</span><span class="p">;</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">copy</span><span class="p">,</span> <span class="nx">sibling</span><span class="p">];</span>
          <span class="nx">me</span> <span class="o">=</span> <span class="nx">copy</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">size</span> <span class="o">-=</span> <span class="nx">sibling</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">sibling</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">myIndex</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">me</span><span class="p">);</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">myIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sibling</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">sibling</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">maybeSpill</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">iter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">iterN</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">op</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">iterN</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">at</span> <span class="o">&lt;</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">used</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">sz</span> <span class="o">-</span> <span class="nx">at</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">iterN</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">used</span><span class="p">,</span> <span class="nx">op</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">n</span> <span class="o">-=</span> <span class="nx">used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="nx">at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">at</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">getLineAt</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">n</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">no</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lines</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span> <span class="nx">chunk</span><span class="p">;</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">,</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">cur</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="nx">no</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">chunkSize</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">no</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">outer</span><span class="o">:</span> <span class="k">do</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="k">continue</span> <span class="nx">outer</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">h</span> <span class="o">-=</span> <span class="nx">ch</span><span class="p">;</span>
        <span class="nx">n</span> <span class="o">+=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">lh</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="nx">lh</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="nx">h</span> <span class="o">-=</span> <span class="nx">lh</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">n</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">outer</span><span class="o">:</span> <span class="k">do</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="k">continue</span> <span class="nx">outer</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">n</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
        <span class="nx">h</span> <span class="o">+=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">h</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">h</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">height</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">h</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>The history object 'chunks' changes that are made close together
and at almost the same time into bigger undoable units.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">History</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="p">[];</span> <span class="k">this</span><span class="p">.</span><span class="nx">undone</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>
  <span class="nx">History</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">addChange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">old</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">undone</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">,</span> <span class="nx">last</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">time</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="mi">400</span> <span class="o">||</span> <span class="o">!</span><span class="nx">last</span> <span class="o">||</span>
          <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">&gt;</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">added</span> <span class="o">||</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">&lt;</span> <span class="nx">start</span> <span class="o">-</span> <span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">+</span> <span class="nx">last</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">start</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="o">:</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">old</span><span class="o">:</span> <span class="nx">old</span><span class="p">});</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">oldoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span>
            <span class="nx">last</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">old</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
          <span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">+=</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
          <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">oldoff</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">-</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span><span class="p">;</span>
          <span class="nx">added</span> <span class="o">+=</span> <span class="nx">oldoff</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">-</span> <span class="nx">oldoff</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="nx">last</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">old</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">&lt;</span> <span class="nx">added</span><span class="p">)</span> <span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">=</span> <span class="nx">added</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">stopMethod</span><span class="p">()</span> <span class="p">{</span><span class="nx">e_stop</span><span class="p">(</span><span class="k">this</span><span class="p">);}</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Ensure an event has a stop method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">stop</span><span class="p">)</span> <span class="nx">event</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="nx">stopMethod</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">event</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="k">else</span> <span class="nx">e</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">e_stopPropagation</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="k">else</span> <span class="nx">e</span><span class="p">.</span><span class="nx">cancelBubble</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">e_stop</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">e_stopPropagation</span><span class="p">(</span><span class="nx">e</span><span class="p">);}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">e_stop</span> <span class="o">=</span> <span class="nx">e_stop</span><span class="p">;</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">e_preventDefault</span> <span class="o">=</span> <span class="nx">e_preventDefault</span><span class="p">;</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">e_stopPropagation</span> <span class="o">=</span> <span class="nx">e_stopPropagation</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">;}</span>
  <span class="kd">function</span> <span class="nx">e_button</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">)</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Event handler registration. If disconnect is true, it'll return a
function that unregisters the handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">disconnect</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">disconnect</span><span class="p">)</span> <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">node</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="kc">false</span><span class="p">);};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">wrapHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span><span class="nx">handler</span><span class="p">(</span><span class="nx">event</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">);};</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">wrapHandler</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">disconnect</span><span class="p">)</span> <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">node</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">wrapHandler</span><span class="p">);};</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Delayed</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;}</span>
  <span class="nx">Delayed</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span><span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);}};</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Detect drag-and-drop</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">dragAndDrop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>IE8 has ondragstart and ondrop properties, but doesn't seem to
actually support ondragstart the way it's supposed to work.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="sr">/MSIE [1-8]\b/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;draggable&quot;</span> <span class="k">in</span> <span class="nx">div</span><span class="p">;</span>
  <span class="p">}();</span>

  <span class="kd">var</span> <span class="nx">gecko</span> <span class="o">=</span> <span class="sr">/gecko\/\d{7}/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ie</span> <span class="o">=</span> <span class="sr">/MSIE \d/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">webkit</span> <span class="o">=</span> <span class="sr">/WebKit\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">lineSep</span> <span class="o">=</span> <span class="s2">&quot;\n&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Feature-detect whether newlines in textareas are converted to \r\n</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">te</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;textarea&quot;</span><span class="p">);</span>
    <span class="nx">te</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;foo\nbar&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">te</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;\r&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">lineSep</span> <span class="o">=</span> <span class="s2">&quot;\r\n&quot;</span><span class="p">;</span>
  <span class="p">}());</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Counts the column offset in a string, taking tabs into account.
Used mostly to find indentation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">countColumn</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">end</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/[^\s\u00a0]/</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">end</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;\t&quot;</span><span class="p">)</span> <span class="nx">n</span> <span class="o">+=</span> <span class="nx">tabSize</span> <span class="o">-</span> <span class="p">(</span><span class="nx">n</span> <span class="o">%</span> <span class="nx">tabSize</span><span class="p">);</span>
      <span class="k">else</span> <span class="o">++</span><span class="nx">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">computedStyle</span><span class="p">(</span><span class="nx">elt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">elt</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">)</span> <span class="k">return</span> <span class="nx">elt</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">elt</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Find the position of an element by following the offsetParent chain.
If screen==true, it returns screen (rather than page) coordinates.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">eltOffset</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">screen</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bod</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">skipBody</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ol</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">,</span> <span class="nx">ot</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Firefox reports weird inverted offsets when the body has a border.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="nx">bod</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">ol</span><span class="p">);</span> <span class="nx">y</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">ot</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">+=</span> <span class="nx">ol</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+=</span> <span class="nx">ot</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">screen</span> <span class="o">&amp;&amp;</span> <span class="nx">computedStyle</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">position</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">)</span>
        <span class="nx">skipBody</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">screen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">skipBody</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">bod</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nx">e</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span> <span class="nx">y</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">left</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">y</span><span class="p">};</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Use the faster and saner getBoundingClientRect method when possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">getBoundingClientRect</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">eltOffset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">screen</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Take the parts of bounding client rect that we are interested in so we are able to edit if need be,
since the returned value cannot be changed externally (they are kept in sync as the element moves within the page)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">try</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">box</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span> <span class="nx">box</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">box</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="nx">box</span><span class="p">.</span><span class="nx">left</span> <span class="p">};</span> <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">box</span> <span class="o">=</span> <span class="p">{</span><span class="nx">top</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">screen</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Get the toplevel scroll, working around browser differences.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">pageYOffset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
        <span class="nx">box</span><span class="p">.</span><span class="nx">top</span> <span class="o">+=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span> <span class="nx">box</span><span class="p">.</span><span class="nx">left</span> <span class="o">+=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">box</span><span class="p">.</span><span class="nx">top</span> <span class="o">+=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">pageYOffset</span><span class="p">;</span> <span class="nx">box</span><span class="p">.</span><span class="nx">left</span> <span class="o">+=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">pageXOffset</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">box</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Get a node's text content.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">eltText</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Operations on {line, ch} objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">line</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ch</span><span class="p">;}</span>
  <span class="kd">function</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">line</span> <span class="o">||</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">line</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ch</span><span class="p">);}</span>
  <span class="kd">function</span> <span class="nx">copyPos</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">x</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">x</span><span class="p">.</span><span class="nx">ch</span><span class="p">};}</span>

  <span class="kd">var</span> <span class="nx">escapeElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">);</span>
  <span class="kd">function</span> <span class="nx">htmlEscape</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">escapeElement</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">escapeElement</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Recent (late 2011) Opera betas insert bogus newlines at the start
of the textContent, so we strip those.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">htmlEscape</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;\na&quot;</span><span class="p">)</span>
    <span class="nx">htmlEscape</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">escapeElement</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">escapeElement</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Some IEs don't preserve tabs through innerHTML</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">htmlEscape</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;\t&quot;</span><span class="p">)</span>
    <span class="nx">htmlEscape</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">escapeElement</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">escapeElement</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">str</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">escapeElement</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">htmlEscape</span> <span class="o">=</span> <span class="nx">htmlEscape</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Used to position the cursor after an undo/redo by finding the
last edited character.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">editEnd</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">to</span><span class="p">)</span> <span class="k">return</span> <span class="nx">from</span> <span class="o">?</span> <span class="nx">from</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">from</span><span class="p">)</span> <span class="k">return</span> <span class="nx">to</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">,</span> <span class="o">--</span><span class="nx">j</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">j</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">elt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">)</span> <span class="k">return</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">elt</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">collection</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">elt</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">isWordChar</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sr">/\w/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">||</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>See if "".split is the broken IE version, if so, provide an
alternative way to split lines.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">splitLines</span> <span class="o">=</span> <span class="s2">&quot;\n\nb&quot;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">nl</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">while</span> <span class="p">((</span><span class="nx">nl</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">))</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">nl</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;\r&quot;</span> <span class="o">?</span> <span class="nx">nl</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">nl</span><span class="p">));</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">nl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">){</span><span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\r?\n/</span><span class="p">);};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">splitLines</span> <span class="o">=</span> <span class="nx">splitLines</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">hasSelection</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">te</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">te</span><span class="p">.</span><span class="nx">selectionStart</span> <span class="o">!=</span> <span class="nx">te</span><span class="p">.</span><span class="nx">selectionEnd</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">te</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">te</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">createRange</span><span class="p">();}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">range</span> <span class="o">||</span> <span class="nx">range</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">te</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">range</span><span class="p">.</span><span class="nx">compareEndPoints</span><span class="p">(</span><span class="s2">&quot;StartToEnd&quot;</span><span class="p">,</span> <span class="nx">range</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMode</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">token</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span><span class="nx">stream</span><span class="p">.</span><span class="nx">skipToEnd</span><span class="p">();}};</span>
  <span class="p">});</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMIME</span><span class="p">(</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">keyNames</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="o">:</span> <span class="s2">&quot;Enter&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="o">:</span> <span class="s2">&quot;Backspace&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="o">:</span> <span class="s2">&quot;Tab&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="o">:</span> <span class="s2">&quot;Enter&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="o">:</span> <span class="s2">&quot;Shift&quot;</span><span class="p">,</span> <span class="mi">17</span><span class="o">:</span> <span class="s2">&quot;Ctrl&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="o">:</span> <span class="s2">&quot;Alt&quot;</span><span class="p">,</span>
                  <span class="mi">19</span><span class="o">:</span> <span class="s2">&quot;Pause&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="o">:</span> <span class="s2">&quot;CapsLock&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="o">:</span> <span class="s2">&quot;Esc&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="o">:</span> <span class="s2">&quot;Space&quot;</span><span class="p">,</span> <span class="mi">33</span><span class="o">:</span> <span class="s2">&quot;PageUp&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="o">:</span> <span class="s2">&quot;PageDown&quot;</span><span class="p">,</span> <span class="mi">35</span><span class="o">:</span> <span class="s2">&quot;End&quot;</span><span class="p">,</span>
                  <span class="mi">36</span><span class="o">:</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="mi">37</span><span class="o">:</span> <span class="s2">&quot;Left&quot;</span><span class="p">,</span> <span class="mi">38</span><span class="o">:</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="mi">39</span><span class="o">:</span> <span class="s2">&quot;Right&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="o">:</span> <span class="s2">&quot;Down&quot;</span><span class="p">,</span> <span class="mi">44</span><span class="o">:</span> <span class="s2">&quot;PrintScrn&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="o">:</span> <span class="s2">&quot;Insert&quot;</span><span class="p">,</span>
                  <span class="mi">46</span><span class="o">:</span> <span class="s2">&quot;Delete&quot;</span><span class="p">,</span> <span class="mi">59</span><span class="o">:</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">91</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="mi">92</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="mi">93</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="mi">186</span><span class="o">:</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">187</span><span class="o">:</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">188</span><span class="o">:</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
                  <span class="mi">189</span><span class="o">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">190</span><span class="o">:</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">191</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">192</span><span class="o">:</span> <span class="s2">&quot;`&quot;</span><span class="p">,</span> <span class="mi">219</span><span class="o">:</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="mi">220</span><span class="o">:</span> <span class="s2">&quot;\\&quot;</span><span class="p">,</span> <span class="mi">221</span><span class="o">:</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="mi">222</span><span class="o">:</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="mi">63276</span><span class="o">:</span> <span class="s2">&quot;PageUp&quot;</span><span class="p">,</span>
                  <span class="mi">63277</span><span class="o">:</span> <span class="s2">&quot;PageDown&quot;</span><span class="p">,</span> <span class="mi">63275</span><span class="o">:</span> <span class="s2">&quot;End&quot;</span><span class="p">,</span> <span class="mi">63273</span><span class="o">:</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="mi">63234</span><span class="o">:</span> <span class="s2">&quot;Left&quot;</span><span class="p">,</span> <span class="mi">63232</span><span class="o">:</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="mi">63235</span><span class="o">:</span> <span class="s2">&quot;Right&quot;</span><span class="p">,</span>
                  <span class="mi">63233</span><span class="o">:</span> <span class="s2">&quot;Down&quot;</span><span class="p">,</span> <span class="mi">63302</span><span class="o">:</span> <span class="s2">&quot;Insert&quot;</span><span class="p">,</span> <span class="mi">63272</span><span class="o">:</span> <span class="s2">&quot;Delete&quot;</span><span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">keyNames</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">;</span>
  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Number keys</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Alphabetic keys</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Function keys</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">111</span><span class="p">]</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">63235</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">})();</span>

  <span class="k">return</span> <span class="nx">CodeMirror</span><span class="p">;</span>
<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 