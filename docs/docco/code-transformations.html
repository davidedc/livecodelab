<!DOCTYPE html>  <html> <head>   <title>code-transformations.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.js               </a>                                           <a class="source" href="background-painting.html">                 background-painting.js               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.js               </a>                                           <a class="source" href="blend-style.html">                 blend-style.js               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="colour-definitions.html">                 colour-definitions.js               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.js               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.js               </a>                                           <a class="source" href="draw-function-runner.html">                 draw-function-runner.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="events.html">                 events.js               </a>                                           <a class="source" href="globals.html">                 globals.js               </a>                                           <a class="source" href="graphic-primitives.html">                 graphic-primitives.js               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.js               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.js               </a>                                           <a class="source" href="math.html">                 math.js               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.js               </a>                                           <a class="source" href="renderer.html">                 renderer.js               </a>                                           <a class="source" href="simple-error-checker.html">                 simple-error-checker.js               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.js               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.js               </a>                                           <a class="source" href="ui.html">                 ui.js               </a>                                           <a class="source" href="url-router.html">                 url-router.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               code-transformations.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="comment">/*jslint maxerr: 200, browser: true, regexp: true, bitwise: true */</span>
<span class="comment">/*global autocoder, createCodeChecker */</span>


<span class="keyword">var</span> createCodeTransformer = <span class="function"><span class="keyword">function</span> <span class="params">(eventRouter, CoffeeCompiler, liveCodeLabCoreInstance)</span> {</span>

    <span class="string">'use strict'</span>;

    <span class="keyword">var</span> CodeTransformer = {},
        programHasBasicError = <span class="literal">false</span>,
        compiledOutput,
        listOfPossibleFunctions,
        preprocessingFunctions = {},
        CodeChecker = createCodeChecker();


    CodeTransformer.compiler = CoffeeCompiler;

    listOfPossibleFunctions = [
        <span class="string">"function"</span>,
        <span class="string">"alert"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Geometry</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"rect"</span>,
        <span class="string">"line"</span>,
        <span class="string">"box"</span>,
        <span class="string">"ball"</span>,
        <span class="string">"ballDetail"</span>,
        <span class="string">"peg"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Matrix manipulation</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"rotate"</span>,
        <span class="string">"move"</span>,
        <span class="string">"scale"</span>,
        <span class="string">"pushMatrix"</span>,
        <span class="string">"popMatrix"</span>,
        <span class="string">"resetMatrix"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Sound</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"bpm"</span>,
        <span class="string">"play"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Color and drawing styles</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"fill"</span>,
        <span class="string">"noFill"</span>,
        <span class="string">"stroke"</span>,
        <span class="string">"noStroke"</span>,
        <span class="string">"strokeSize"</span>,
        <span class="string">"animationStyle"</span>,
        <span class="string">"background"</span>,
        <span class="string">"simpleGradient"</span>,
        <span class="string">"color"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Lighting</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="comment">/*"ambient","reflect", "refract", */</span>
        <span class="string">"lights"</span>,
        <span class="string">"noLights"</span>,
        <span class="string">"ambientLight"</span>,
        <span class="string">"pointLight"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Calculations</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"abs"</span>,
        <span class="string">"ceil"</span>,
        <span class="string">"constrain"</span>,
        <span class="string">"dist"</span>,
        <span class="string">"exp"</span>,
        <span class="string">"floor"</span>,
        <span class="string">"lerp"</span>,
        <span class="string">"log"</span>,
        <span class="string">"mag"</span>,
        <span class="string">"map"</span>,
        <span class="string">"max"</span>,
        <span class="string">"min"</span>,
        <span class="string">"norm"</span>,
        <span class="string">"pow"</span>,
        <span class="string">"round"</span>,
        <span class="string">"sq"</span>,
        <span class="string">"sqrt"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Trigonometry</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"acos"</span>,
        <span class="string">"asin"</span>,
        <span class="string">"atan"</span>,
        <span class="string">"atan2"</span>,
        <span class="string">"cos"</span>,
        <span class="string">"degrees"</span>,
        <span class="string">"radians"</span>,
        <span class="string">"sin"</span>,
        <span class="string">"tan"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Random</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"random"</span>,
        <span class="string">"randomSeed"</span>,
        <span class="string">"noise"</span>,
        <span class="string">"noiseDetail"</span>,
        <span class="string">"noiseSeed"</span>,
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>do once</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="string">"addDoOnce"</span>,
        <span class="string">""</span>];

    <span class="comment">/**
     * The preprocessing functions are used to process the
     * code before it is sent through the coffee script
     * compiler
     *
     * Note
     * some replacements add a semicolon for the following reason:
     * coffeescript allows you to split arguments over multiple lines.
     * So if you have:
     *     rotate 0,0,1
     *     box
     * and you want to add a scale like so:
     *     scale 2,2,2
     *     rotate 0,0,1
     *     box
     * What happens is that as you are in the middle of typing:
     *     scale 2,
     *     rotate 0,0,1
     *     box
     * coffeescript takes the rotate as the second argument of scale
     * causing mayhem.
     * Instead, all is good if rotate is prepended with a semicolon.
     */</span>


    <span class="comment">/**
     * Stops ticked doOnce blocks from running
     *
     * doOnce statements which have a tick mark next to them
     * are not run. This is achieved by replacing the line with
     * the "doOnce" with "if false" or "//" depending on whether
     * the doOnce is a multiline or an inline one, like so:
     *      ✓doOnce -&gt;
     *        background 255
     *        fill 255,0,0
     *      ✓doOnce -&gt; ball
     * becomes:
     *      if false -&gt;
     *        background 255
     *        fill 255,0,0
     *      //doOnce -&gt; ball
     *
     * @param {string} code    the code to re-write
     *
     * @returns {string}
     */</span>
    preprocessingFunctions.removeTickedDoOnce = <span class="function"><span class="keyword">function</span> <span class="params">(code)</span> {</span>
        <span class="keyword">var</span> newCode;
        newCode = code.replace(<span class="regexp">/^(\s)*✓[ ]*doOnce[ ]*\-\&gt;[ ]*$/gm</span>, <span class="string">"$1if false"</span>);
        newCode = newCode.replace(<span class="regexp">/\u2713/g</span>, <span class="string">"//"</span>);
        <span class="keyword">return</span> newCode;
    };

    <span class="comment">/**
     * Some of the functions can be used with postfix notation
     *
     * e.g.
     *
     *      60 bpm
     *      red fill
     *      yellow stroke
     *      black background
     *
     * We need to switch this round before coffee script compilation
     */</span>
    preprocessingFunctions.postfixNotation = <span class="function"><span class="keyword">function</span> <span class="params">(code)</span> {</span>
        <span class="keyword">var</span> elaboratedSource;
        elaboratedSource = code.replace(<span class="regexp">/(\d+)[ ]+bpm(\s)/g</span>, <span class="string">"bpm $1$2"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([a-zA-Z]+)[ ]+fill(\s)/g</span>, <span class="string">"fill $1$2"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([a-zA-Z]+)[ ]+stroke(\s)/g</span>, <span class="string">"stroke $1$2"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([a-zA-Z]+)[ ]+background(\s)/g</span>, <span class="string">"background $1$2"</span>);
        <span class="keyword">return</span> elaboratedSource;
    };

    <span class="comment">/**
     * The times function is mangled by coffeescript
     *     (1).times -&gt;
     * But this isn't:
     *     (1+0).times -&gt;
     * So here is the little replace.
     *
     * TODO: you should be a little smarter about the substitution of the draw method
     * You can tell a method declaration because the line below is indented
     * so you should check that.
     *
     */</span>
    preprocessingFunctions.fixTimesFunctions = <span class="function"><span class="keyword">function</span> <span class="params">(code)</span> {</span>
        <span class="keyword">return</span> code.replace(<span class="regexp">/(\d+)\s+times[ ]*\-&gt;/g</span>, <span class="string">";( $1 + 0).times -&gt;"</span>);
    };

    <span class="comment">/**
     * Each doOnce block is made to start with an instruction that traces whether
     * the block has been run or not. This allows us to put back the tick where
     * necessary, so the doOnce block is not run again.
     * Example - let's say one pastes in this code:
     *     doOnce -&gt;
     *         background 255
     *         fill 255,0,0
     *
     *     doOnce -&gt; ball
     *
     * it becomes:
     *     (1+0).times -&gt;
     *         addDoOnce(1); background 255
     *         fill 255,0,0
     *
     *     ;addDoOnce(4);
     *     (1+0).times -&gt; ball
     *    
     * So: if there is at least one doOnce
     *     split the source in lines
     *     add line numbers tracing instructions so we can track which ones have been run
     *     regroup the lines into a single string again
     *
     */</span>
    preprocessingFunctions.addDoOnceTracing = <span class="function"><span class="keyword">function</span> <span class="params">(source)</span> {</span>
        <span class="keyword">var</span> sourceLines, i;
        <span class="keyword">if</span> (source.indexOf(<span class="string">'doOnce'</span>) &gt; -<span class="number">1</span>) {
            sourceLines = source.split(<span class="string">"\n"</span>);
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sourceLines.length; i += <span class="number">1</span>) {

</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>add the line number tracing instruction to inline case</p>             </td>             <td class="code">               <div class="highlight"><pre>                sourceLines[i] = sourceLines[i].replace(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*(.+)$/gm</span>, <span class="string">"$1;addDoOnce("</span> + i + <span class="string">"); (1+0).times -&gt; $2"</span>);

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>add the line number tracing instruction to multiline case</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="keyword">if</span> (sourceLines[i].match(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/gm</span>)) {
                    sourceLines[i] = sourceLines[i].replace(<span class="regexp">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/gm</span>, <span class="string">"$1(1+0).times -&gt;"</span>);
                    sourceLines[i + <span class="number">1</span>] = sourceLines[i + <span class="number">1</span>].replace(<span class="regexp">/^(\s*)(.+)$/gm</span>, <span class="string">"$1;addDoOnce("</span> + i + <span class="string">"); $2"</span>);
                }

            }
            source = sourceLines.join(<span class="string">"\n"</span>);
        }
        <span class="keyword">return</span> source;
    };


    CodeTransformer.updateCode = <span class="function"><span class="keyword">function</span> <span class="params">(updatedCodeAsString)</span> {</span>

        <span class="keyword">var</span> elaboratedSource, errResults;

        CodeTransformer.currentCodeString = updatedCodeAsString;
        
        <span class="keyword">if</span> (CodeTransformer.currentCodeString === <span class="string">''</span>){
					liveCodeLabCoreInstance.GraphicsCommands.resetTheSpinThingy = <span class="literal">true</span>;
					programHasBasicError = <span class="literal">false</span>;
					eventRouter.trigger(<span class="string">'clear-error'</span>);	
					liveCodeLabCoreInstance.DrawFunctionRunner.consecutiveFramesWithoutRunTimeError = <span class="number">0</span>;
					<span class="keyword">var</span> functionFromCompiledCode = <span class="keyword">new</span> Function(<span class="string">''</span>);
					liveCodeLabCoreInstance.DrawFunctionRunner.setDrawFunction(<span class="literal">null</span>);
					liveCodeLabCoreInstance.DrawFunctionRunner.lastStableDrawFunction = <span class="literal">null</span>;
					<span class="keyword">return</span> functionFromCompiledCode;
        }


        updatedCodeAsString = preprocessingFunctions.removeTickedDoOnce(updatedCodeAsString);

        <span class="comment">/**
         * The CodeChecker will check for unbalanced brackets
         * and unfinished strings
         *
         * If any errors are found then we quit compilation here
         * and display an error message
         */</span>

        errResults = CodeChecker.parse(updatedCodeAsString);

        <span class="keyword">if</span> (errResults.err === <span class="literal">true</span>) {
            eventRouter.trigger(<span class="string">'compile-time-error-thrown'</span>, errResults.message);
            <span class="keyword">return</span>;
        }


        elaboratedSource = updatedCodeAsString;

        elaboratedSource = preprocessingFunctions.postfixNotation(elaboratedSource);

        elaboratedSource = preprocessingFunctions.fixTimesFunctions(elaboratedSource);

        elaboratedSource = preprocessingFunctions.addDoOnceTracing(elaboratedSource);


        elaboratedSource = elaboratedSource.replace(<span class="regexp">/^(\s*)([a-z]+[a-zA-Z0-9]*)[ ]*$/gm</span>, <span class="string">"$1;$2()"</span>);

</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>this takes care of when a token that it's supposed to be
a function is inlined with something else e.g.
doOnce frame = 0; box
2 times -> box</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/;\s*([a-z]+[a-zA-Z0-9]*)[ ]*([;\n]+)/g</span>, <span class="string">";$1()$2"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>this takes care of when a token that it's supposed to be
a function is inlined like so:
2 times -> box</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/\-&gt;\s*([a-z]+[a-zA-Z0-9]*)[ ]*([;\n]+)/g</span>, <span class="string">";$1()$2"</span>);

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>draw() could just be called by mistake and it's likely
to be disastrous. User doesn't even have visibility of such method,
why should he/she call it?
TODO: call draw() something else that the user is not
likely to use by mistake and take away this check.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="keyword">if</span> (elaboratedSource.match(<span class="regexp">/[\s\+\;]+draw\s*\(/</span>) || <span class="literal">false</span>) {
            programHasBasicError = <span class="literal">true</span>;
            eventRouter.trigger(<span class="string">'compile-time-error-thrown'</span>, <span class="string">"You can't call draw()"</span>);
            <span class="keyword">return</span>;
        }


</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>we don't want if and for to undergo the same tratment as, say, box
so put those back to normal.</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/;(if)\(\)/g</span>, <span class="string">";$1"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/;(else)\(\)/g</span>, <span class="string">";$1"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/;(for)\(\)/g</span>, <span class="string">";$1"</span>);

        elaboratedSource = elaboratedSource.replace(<span class="regexp">/\/\//g</span>, <span class="string">"#"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Why do we have to match a non-digit non-letter?
because we have to make sure that the keyword is "on its own"
otherwise for example we interfere the replacements of "background" and "round"
Checking whether the keyword is "on its own" avoid those interferences.</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(scale)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(rotate)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(move)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(rect)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(line)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(bpm)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(play)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(pushMatrix)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(popMatrix)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(resetMatrix)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(fill)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(noFill)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(stroke)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(noStroke)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(strokeSize)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(animationStyle)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(simpleGradient)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(background)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(color)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>elaboratedSource =  elaboratedSource.replace(/([^a-zA-Z0-9])(ambient)(\s)+/g, "$1;$2$3" );
elaboratedSource =  elaboratedSource.replace(/([^a-zA-Z0-9])(reflect)(\s)+/g, "$1;$2$3" );
elaboratedSource =  elaboratedSource.replace(/([^a-zA-Z0-9])(refract)(\s)+/g, "$1;$2$3" );</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(lights)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(noLights)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(ambientLight)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(pointLight)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(ball)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(ballDetail)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(peg)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);

</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Calculation</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(abs)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(ceil)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(constrain)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(dist)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(exp)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(floor)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(lerp)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(log)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(mag)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(map)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(max)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(min)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(norm)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(pow)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(round)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(sq)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(sqrt)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Trigonometry</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(acos)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(asin)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(atan)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(atan2)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(cos)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(degrees)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(radians)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(sin)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(tan)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Random</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(random)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(randomSeed)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(noise)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(noiseDetail)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);
        elaboratedSource = elaboratedSource.replace(<span class="regexp">/([^a-zA-Z0-9])(noiseSeed)(\s)+/g</span>, <span class="string">"$1;$2$3"</span>);


</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>you'd think that semicolons are OK anywhere before any command
but coffee-script doesn't like some particular configurations - fixing those:
the semicolon mangles the first line of the function definitions:</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/-&gt;(\s+);/g</span>, <span class="string">"-&gt;$1"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>the semicolon mangles the first line of if statements</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/(\sif\s*.*\s*);/g</span>, <span class="string">"$1"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>the semicolon mangles the first line of else if statements</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/(\s);(else\s*if\s*.*\s*);/g</span>, <span class="string">"$1$2"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>the semicolon mangles the first line of else statements</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSource = elaboratedSource.replace(<span class="regexp">/(\s);(else.*\s*);/g</span>, <span class="string">"$1$2"</span>);

        <span class="keyword">try</span> {
            compiledOutput = CodeTransformer.compiler.compile(elaboratedSource, {
                bare: <span class="string">"on"</span>
            });
        } <span class="keyword">catch</span> (e) {
</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>coffescript compiler has caught a syntax error.
we are going to display the error and we WON'T register
the new code</p>             </td>             <td class="code">               <div class="highlight"><pre>            eventRouter.trigger(<span class="string">'compile-time-error-thrown'</span>, e);
            <span class="keyword">return</span>;
        }

        programHasBasicError = <span class="literal">false</span>;
        eventRouter.trigger(<span class="string">'clear-error'</span>);

</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>see here for the deepest examination ever of "eval"
http://perfectionkills.com/global-eval-what-are-the-options/
note that exceptions are caught by the window.onerror callback</p>             </td>             <td class="code">               <div class="highlight"><pre>        liveCodeLabCoreInstance.DrawFunctionRunner.consecutiveFramesWithoutRunTimeError = <span class="number">0</span>;

</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>You might want to change the frame count from the program
just like you can in Processing, but it turns out that when
you ASSIGN a value to the frame variable inside
the coffeescript code, the coffeescript to javascript translator
declares a <em>local</em> frame variable, so changes to the frame
count get lost from one frame to the next.
TODO: There must be a way to tell coffeescript to accept
some variables as global, for the time being let's put
the cheap hack in place i.e. remove any local declaration that the
coffeescript to javascript translator inserts.</p>             </td>             <td class="code">               <div class="highlight"><pre>        compiledOutput = compiledOutput.replace(<span class="regexp">/var frame/</span>, <span class="string">";"</span>);

        <span class="keyword">var</span> functionFromCompiledCode = <span class="keyword">new</span> Function(compiledOutput);
        liveCodeLabCoreInstance.DrawFunctionRunner.setDrawFunction(functionFromCompiledCode);
        <span class="keyword">return</span> functionFromCompiledCode;

    };

    CodeTransformer.addCheckMarksAndUpdateCodeAndNotifyChange = <span class="function"><span class="keyword">function</span> <span class="params">(CodeTransformer, doOnceOccurrencesLineNumbers)</span> {</span>

        <span class="keyword">var</span> elaboratedSource,
            elaboratedSourceByLine,
            iteratingOverSource,
            drawFunction;

</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>if we are here, the following has happened: someone has added an element
to the doOnceOccurrencesLineNumbers array. This can only have happened
when a doOnce block is run, because we manipulate each doOnce block
so that in its first line the line number of the block is pushed into
the doOnceOccurrencesLineNumbers array.
So, the doOnceOccurrencesLineNumbers array contains all and only the lines
of each doOnce block that has been run. Which could be more than one, because
when we start the program we could have more than one doOnce that has
to run.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        elaboratedSource = CodeTransformer.currentCodeString;

</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>we know the line number of each doOnce block that has been run
so we go there and add a tick next to each doOnce to indicate
that it has been run.</p>             </td>             <td class="code">               <div class="highlight"><pre>        elaboratedSourceByLine = elaboratedSource.split(<span class="string">"\n"</span>);
        <span class="keyword">for</span> (iteratingOverSource = <span class="number">0</span>; iteratingOverSource &lt; doOnceOccurrencesLineNumbers.length; iteratingOverSource += <span class="number">1</span>) {
            elaboratedSourceByLine[doOnceOccurrencesLineNumbers[iteratingOverSource]] = elaboratedSourceByLine[doOnceOccurrencesLineNumbers[iteratingOverSource]].replace(<span class="regexp">/^(\s*)doOnce([ ]*\-&gt;[ ]*.*)$/gm</span>, <span class="string">"$1\u2713doOnce$2"</span>);
        }
        elaboratedSource = elaboratedSourceByLine.join(<span class="string">"\n"</span>);

</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>puts the new code (where the doOnce that have been executed have
tickboxes put back) in the editor. Which will trigger a re-registration
of the new code.</p>             </td>             <td class="code">               <div class="highlight"><pre>        eventRouter.trigger(<span class="string">'code-updated-by-livecodelab'</span>, elaboratedSource);

</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>we want to avoid that another frame is run with the old
code, as this would mean that the
runOnce code is run more than once,
so we need to register the new code.
TODO: ideally we don't want to register the
new code by getting the code from codemirror again
because we don't know what that entails. We should
just pass the code we already have.
Also updateCode() may split the source code by line, so we can
avoid that since we've just split it, we could pass
the already split code.</p>             </td>             <td class="code">               <div class="highlight"><pre>        drawFunction = CodeTransformer.updateCode(elaboratedSource);
        <span class="keyword">return</span> drawFunction;
    };

    <span class="keyword">return</span> CodeTransformer;

};

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 