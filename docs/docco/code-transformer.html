<!DOCTYPE html>  <html> <head>   <title>code-transformer.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.coffee               </a>                                           <a class="source" href="autocoder.html">                 autocoder.coffee               </a>                                           <a class="source" href="lexer.html">                 lexer.coffee               </a>                                           <a class="source" href="background-painter.html">                 background-painter.coffee               </a>                                           <a class="source" href="big-cursor.html">                 big-cursor.coffee               </a>                                           <a class="source" href="blend-controls.html">                 blend-controls.coffee               </a>                                           <a class="source" href="code-transformer.html">                 code-transformer.coffee               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.coffee               </a>                                           <a class="source" href="colour-literals.html">                 colour-literals.coffee               </a>                                           <a class="source" href="editor.html">                 editor.coffee               </a>                                           <a class="source" href="event-router.html">                 event-router.coffee               </a>                                           <a class="source" href="globals.html">                 globals.coffee               </a>                                           <a class="source" href="graphics-commands.html">                 graphics-commands.coffee               </a>                                           <a class="source" href="init.html">                 init.coffee               </a>                                           <a class="source" href="lights-commands.html">                 lights-commands.coffee               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.coffee               </a>                                           <a class="source" href="math.html">                 math.coffee               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.coffee               </a>                                           <a class="source" href="parser.html">                 parser.coffee               </a>                                           <a class="source" href="program-loader.html">                 program-loader.coffee               </a>                                           <a class="source" href="program-runner.html">                 program-runner.coffee               </a>                                           <a class="source" href="renderer.html">                 renderer.coffee               </a>                                           <a class="source" href="samplebank.html">                 samplebank.coffee               </a>                                           <a class="source" href="sound-system.html">                 sound-system.coffee               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.coffee               </a>                                           <a class="source" href="threejs-system.html">                 threejs-system.coffee               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.coffee               </a>                                           <a class="source" href="ui.html">                 ui.coffee               </a>                                           <a class="source" href="url-router.html">                 url-router.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               code-transformer.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Although LiveCodeLab is ultimately running Javascript code behind the scenes,
the user uses a simpler syntax which is basically coffeescript with a
little bit of extra sugar.
CodeTransformer takes care of translating this simplified syntax to
Javascript. Also note that CodeTransformer might return a program
that substituted the program passed as input.
This is because doOnce statements get transformed by pre-prending a
tick once they are run, which prevents them from being run again.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">CodeTransformer</span>
  <span class="nv">currentCodeString: </span><span class="kc">null</span>
  
  <span class="nv">constructor: </span><span class="nf">(@eventRouter, @CoffeeCompiler, @liveCodeLabCoreInstance) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This list is not used anywhere for the time being.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">listOfPossibleFunctions = </span><span class="p">[</span>
      <span class="s">&quot;function&quot;</span>
      <span class="s">&quot;alert&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Geometry</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;rect&quot;</span>
      <span class="s">&quot;line&quot;</span>
      <span class="s">&quot;box&quot;</span>
      <span class="s">&quot;ball&quot;</span>
      <span class="s">&quot;ballDetail&quot;</span>
      <span class="s">&quot;peg&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Matrix manipulation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;rotate&quot;</span>
      <span class="s">&quot;move&quot;</span>
      <span class="s">&quot;scale&quot;</span>
      <span class="s">&quot;pushMatrix&quot;</span>
      <span class="s">&quot;popMatrix&quot;</span>
      <span class="s">&quot;resetMatrix&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Sound</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;bpm&quot;</span>
      <span class="s">&quot;play&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Color and drawing styles</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;fill&quot;</span>
      <span class="s">&quot;noFill&quot;</span>
      <span class="s">&quot;stroke&quot;</span>
      <span class="s">&quot;noStroke&quot;</span>
      <span class="s">&quot;strokeSize&quot;</span>
      <span class="s">&quot;animationStyle&quot;</span>
      <span class="s">&quot;background&quot;</span>
      <span class="s">&quot;simpleGradient&quot;</span>
      <span class="s">&quot;colorMode&quot;</span>
      <span class="s">&quot;color&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Lighting
"ambient""reflect" "refract"</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;lights&quot;</span>
      <span class="s">&quot;noLights&quot;</span>
      <span class="s">&quot;ambientLight&quot;</span>
      <span class="s">&quot;pointLight&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Calculations</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;abs&quot;</span>
      <span class="s">&quot;ceil&quot;</span>
      <span class="s">&quot;constrain&quot;</span>
      <span class="s">&quot;dist&quot;</span>
      <span class="s">&quot;exp&quot;</span>
      <span class="s">&quot;floor&quot;</span>
      <span class="s">&quot;lerp&quot;</span>
      <span class="s">&quot;log&quot;</span>
      <span class="s">&quot;mag&quot;</span>
      <span class="s">&quot;map&quot;</span>
      <span class="s">&quot;max&quot;</span>
      <span class="s">&quot;min&quot;</span>
      <span class="s">&quot;norm&quot;</span>
      <span class="s">&quot;pow&quot;</span>
      <span class="s">&quot;round&quot;</span>
      <span class="s">&quot;sq&quot;</span>
      <span class="s">&quot;sqrt&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Trigonometry</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;acos&quot;</span>
      <span class="s">&quot;asin&quot;</span>
      <span class="s">&quot;atan&quot;</span>
      <span class="s">&quot;atan2&quot;</span>
      <span class="s">&quot;cos&quot;</span>
      <span class="s">&quot;degrees&quot;</span>
      <span class="s">&quot;radians&quot;</span>
      <span class="s">&quot;sin&quot;</span>
      <span class="s">&quot;tan&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Random</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;random&quot;</span>
      <span class="s">&quot;randomSeed&quot;</span>
      <span class="s">&quot;noise&quot;</span>
      <span class="s">&quot;noiseDetail&quot;</span>
      <span class="s">&quot;noiseSeed&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>do once</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="s">&quot;addDoOnce&quot;</span>
    <span class="p">]</span>


  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Stops ticked doOnce blocks from running
#
doOnce statements which have a tick mark next to them
are not run. This is achieved by replacing the line with
the "doOnce" with "if false" or "//" depending on whether
the doOnce is a multiline or an inline one, like so:
#
    ✓doOnce ->
    background 255
    fill 255,0,0
    ✓doOnce -> ball
    becomes:
    if false ->
    background 255
    fill 255,0,0
    //doOnce -> ball
#
@param {string} code    the code to re-write
#
@returns {string}</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">removeTickedDoOnce: </span><span class="nf">(code) -&gt;</span>
    <span class="nv">newCode = </span><span class="kc">undefined</span>
    <span class="nv">newCode = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\s)*✓[ ]*doOnce[ ]*\-\&gt;[ ]*$/gm</span><span class="p">,</span> <span class="s">&quot;$1if false&quot;</span><span class="p">)</span>
    <span class="nv">newCode = </span><span class="nx">newCode</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\u2713/g</span><span class="p">,</span> <span class="s">&quot;//&quot;</span><span class="p">)</span>
    <span class="nx">newCode</span>

  <span class="nv">addTracingInstructionsToDoOnceBlocks: </span><span class="nf">(code) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>ADDING TRACING INSTRUCTION TO THE DOONCE BLOCKS
each doOnce block is made to start with an instruction that traces whether
the block has been run or not. This allows us to put back the tick where
necessary, so the doOnce block is not run again.
Example - let's say one pastes in this code:</p>

<pre><code> doOnce -&gt;
   background 255
   fill 255,0,0

 doOnce -&gt; ball
</code></pre>

<p>it becomes:</p>

<pre><code> (1+0).times -&gt;
   addDoOnce(1); background 255
   fill 255,0,0

 ;addDoOnce(4);
 (1+0).times -&gt; ball
</code></pre>

<p>So: if there is at least one doOnce
  split the source in lines
  add line numbers tracing instructions so we can track which
  ones have been run regroup the lines into a single string again</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">elaboratedSourceByLine = </span><span class="kc">undefined</span>
    <span class="nv">iteratingOverSource = </span><span class="kc">undefined</span>
    <span class="k">if</span> <span class="nx">code</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&quot;doOnce&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
      </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>alert("a doOnce is potentially executable");</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">elaboratedSourceByLine = </span><span class="nx">code</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>alert('splitting: ' + elaboratedSourceByLine.length );</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">iteratingOverSource</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">elaboratedSourceByLine</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
        </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>alert('iterating: ' + iteratingOverSource );</p>             </td>             <td class="code">               <div class="highlight"><pre>        </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>add the line number tracing instruction to inline case</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">]</span> <span class="o">=</span>
          <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span>
            <span class="sr">/^(\s*)doOnce[ ]*\-&gt;[ ]*(.+)$/g</span><span class="p">,</span>
            <span class="s">&quot;$1;addDoOnce(&quot;</span> <span class="o">+</span> <span class="nx">iteratingOverSource</span> <span class="o">+</span> <span class="s">&quot;); (1+0).times -&gt; $2&quot;</span><span class="p">)</span>
        </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>add the line number tracing instruction to multiline case</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/g</span><span class="p">)</span>
          </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>alert('doOnce multiline!');</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">]</span> <span class="o">=</span>
            <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span>
              <span class="sr">/^(\s*)doOnce[ ]*\-&gt;[ ]*$/g</span><span class="p">,</span> <span class="s">&quot;$1(1+0).times -&gt;&quot;</span><span class="p">)</span>
          <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
            <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span>
              <span class="sr">/^(\s*)(.+)$/g</span><span class="p">,</span> <span class="s">&quot;$1;addDoOnce(&quot;</span> <span class="o">+</span> <span class="nx">iteratingOverSource</span> <span class="o">+</span> <span class="s">&quot;); $2&quot;</span><span class="p">)</span>
      <span class="nv">code = </span><span class="nx">elaboratedSourceByLine</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>alert('soon after replacing doOnces'+code);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">code</span>

  <span class="nv">doesProgramContainStringsOrComments: </span><span class="nf">(code) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>make a copy of the string because we are going to
slice it in the process.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">copyOfcode = </span><span class="nx">code</span>
    <span class="nv">characterBeingExamined = </span><span class="kc">undefined</span>
    <span class="nv">nextCharacterBeingExamined = </span><span class="kc">undefined</span>
    <span class="k">while</span> <span class="nx">copyOfcode</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">characterBeingExamined = </span><span class="nx">copyOfcode</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nv">nextCharacterBeingExamined = </span><span class="nx">copyOfcode</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;&#39;&quot;</span> <span class="o">or</span>
          <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;\&quot;&quot;</span> <span class="o">or</span>
          <span class="p">(</span><span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;/&quot;</span> <span class="o">and</span>
            <span class="p">(</span><span class="nx">nextCharacterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span> <span class="o">or</span>
            <span class="nx">nextCharacterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;/&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">true</span>
      <span class="nv">copyOfcode = </span><span class="nx">copyOfcode</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="nv">stripCommentsAndCheckBasicSyntax: </span><span class="nf">(code) -&gt;</span>
    <span class="nv">codeWithoutComments = </span><span class="kc">undefined</span>
    <span class="nv">codeWithoutStringsOrComments = </span><span class="kc">undefined</span>
    </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>check whether the program potentially
contains strings or comments
if it doesn't then we can do some
simple syntactic checks that are likely
to be much faster than attempting a
coffescript to javascript translation</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>let's do a quick check:
these groups of characters should be in even number:
", ', (), {}, []
Note that this doesn't check nesting, so for example
[{]} does pass the test.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@doesProgramContainStringsOrComments</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>OK the program contains comments and/or strings
so this is what we are going to do:
first we remove all the comments for good
then we create a version without the strings
so we can perform some basic syntax checking.
Note that when we remove the comments we also need to
take into account strings because otherwise we mangle a line like
print "frame/100 //"
where we need to now that that single comment is actually the content
of a string.
modified from Processing.js (search for: "masks strings and regexs")
this is useful to remove all comments but keeping all the strings
the difference is that here I don't treat regular expressions.
Note that string take precedence over comments i.e.
is a string, not half a string with a quote in a comment
get rid of the comments for good.
note the use of coffeescripts' "block regular expressions" here,
and note that there is no need to escape "/" with "\/",
see https://github.com/jashkenas/coffee-script/issues/2358</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
        <span class="sr">///</span>
<span class="sr">        (&quot;(?:[^&quot;\\\n]|\\.)*&quot;)|</span>
<span class="sr">        (&#39;(?:[^&#39;\\\n]|\\.)*&#39;)|</span>
<span class="sr">        (//[^\n]*\n)|</span>
<span class="sr">        (/\*(?:(?!\*/)(?:.|\n))*\*/)</span>
<span class="sr">        ///g</span><span class="p">,</span>
          <span class="nf">(all, quoted, aposed, singleComment, comment) -&gt;</span>
            <span class="nv">numberOfLinesInMultilineComment = </span><span class="kc">undefined</span>
            <span class="nv">rebuiltNewLines = </span><span class="kc">undefined</span>
            <span class="nv">cycleToRebuildNewLines = </span><span class="kc">undefined</span>
            </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>strings are kept as they are</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">quoted</span>  <span class="k">if</span> <span class="nx">quoted</span>
            <span class="k">return</span> <span class="nx">aposed</span>  <span class="k">if</span> <span class="nx">aposed</span>
            </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>preserve the line because
the doOnce mechanism needs to retrieve
the line where it was</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="s">&quot;\n&quot;</span>  <span class="k">if</span> <span class="nx">singleComment</span>
            </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>eliminate multiline comments preserving the lines</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">numberOfLinesInMultilineComment = </span><span class="nx">comment</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="nv">rebuiltNewLines = </span><span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="nx">cycleToRebuildNewLines</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">numberOfLinesInMultilineComment</span><span class="p">]</span>
              <span class="nv">rebuiltNewLines = </span><span class="nx">rebuiltNewLines</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span>
            <span class="nx">rebuiltNewLines</span>
      <span class="p">)</span>
      <span class="nv">codeWithoutComments = </span><span class="nx">code</span>
      </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>in the version we use for syntax checking we delete all the strings</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">codeWithoutStringsOrComments =</span>
        <span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(&quot;(?:[^&quot;\\\n]|\\.)*&quot;)|(&#39;(?:[^&#39;\\\n]|\\.)*&#39;)/g</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">codeWithoutStringsOrComments = </span><span class="nx">code</span>
    <span class="nv">aposCount = </span><span class="mi">0</span>
    <span class="nv">quoteCount = </span><span class="mi">0</span>
    <span class="nv">roundBrackCount = </span><span class="mi">0</span>
    <span class="nv">curlyBrackCount = </span><span class="mi">0</span>
    <span class="nv">squareBrackCount = </span><span class="mi">0</span>
    <span class="nv">characterBeingExamined = </span><span class="kc">undefined</span>
    <span class="nv">reasonOfBasicError = </span><span class="kc">undefined</span>
    <span class="k">while</span> <span class="nx">codeWithoutStringsOrComments</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">characterBeingExamined = </span><span class="nx">codeWithoutStringsOrComments</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;&#39;&quot;</span>
        <span class="nx">aposCount</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;\&quot;&quot;</span>
        <span class="nx">quoteCount</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;(&quot;</span> <span class="o">or</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;)&quot;</span>
        <span class="nx">roundBrackCount</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;{&quot;</span> <span class="o">or</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;}&quot;</span>
        <span class="nx">curlyBrackCount</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;[&quot;</span> <span class="o">or</span> <span class="nx">characterBeingExamined</span> <span class="o">is</span> <span class="s">&quot;]&quot;</span>
        <span class="nx">squareBrackCount</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="nv">codeWithoutStringsOrComments = </span><span class="nx">codeWithoutStringsOrComments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>according to jsperf, the fastest way to check if number is even/odd</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">aposCount</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">quoteCount</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">roundBrackCount</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">or</span>
        <span class="nx">curlyBrackCount</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">squareBrackCount</span> <span class="o">&amp;</span> <span class="mi">1</span>
      <span class="nv">programHasBasicError = </span><span class="kc">true</span>
      <span class="nv">reasonOfBasicError = </span><span class="s">&quot;Missing &#39;&quot;</span>  <span class="k">if</span> <span class="nx">aposCount</span> <span class="o">&amp;</span> <span class="mi">1</span>
      <span class="nv">reasonOfBasicError = </span><span class="s">&quot;Missing \&quot;&quot;</span>  <span class="k">if</span> <span class="nx">quoteCount</span> <span class="o">&amp;</span> <span class="mi">1</span>
      <span class="nv">reasonOfBasicError = </span><span class="s">&quot;Unbalanced ()&quot;</span>  <span class="k">if</span> <span class="nx">roundBrackCount</span> <span class="o">&amp;</span> <span class="mi">1</span>
      <span class="nv">reasonOfBasicError = </span><span class="s">&quot;Unbalanced {}&quot;</span>  <span class="k">if</span> <span class="nx">curlyBrackCount</span> <span class="o">&amp;</span> <span class="mi">1</span>
      <span class="nv">reasonOfBasicError = </span><span class="s">&quot;Unbalanced []&quot;</span>  <span class="k">if</span> <span class="nx">squareBrackCount</span> <span class="o">&amp;</span> <span class="mi">1</span>
      <span class="nx">@eventRouter</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;compile-time-error-thrown&quot;</span><span class="p">,</span> <span class="nx">reasonOfBasicError</span>
      <span class="k">return</span> <span class="kc">null</span>
    </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>no comments or strings were found, just return the same string
that was passed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">code</span>

  </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Some of the functions can be used with postfix notation
#
e.g.
#
    60 bpm
    red fill
    yellow stroke
    black background
#
We need to switch this round before coffee script compilation</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">adjustPostfixNotations: </span><span class="nf">(code) -&gt;</span>
    <span class="nv">elaboratedSource = </span><span class="kc">undefined</span>
    <span class="nv">elaboratedSource = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\d+)[ ]+bpm(\s)/g</span><span class="p">,</span> <span class="s">&quot;bpm $1$2&quot;</span><span class="p">)</span>
    <span class="nv">elaboratedSource = </span><span class="nx">elaboratedSource</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([a-zA-Z]+)[ ]+fill(\s)/g</span><span class="p">,</span> <span class="s">&quot;fill $1$2&quot;</span><span class="p">)</span>
    <span class="nv">elaboratedSource = </span><span class="nx">elaboratedSource</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
      <span class="sr">/([a-zA-Z]+)[ ]+stroke(\s)/g</span><span class="p">,</span> <span class="s">&quot;stroke $1$2&quot;</span><span class="p">)</span>
    <span class="nv">elaboratedSource = </span><span class="nx">elaboratedSource</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
      <span class="sr">/([a-zA-Z]+)[ ]+background(\s)/g</span><span class="p">,</span> <span class="s">&quot;background $1$2&quot;</span><span class="p">)</span>
    <span class="nx">elaboratedSource</span>

  <span class="nv">updateCode: </span><span class="nf">(code) -&gt;</span>
    <span class="nv">elaboratedSource = </span><span class="kc">undefined</span>
    <span class="nv">errResults = </span><span class="kc">undefined</span>
    <span class="nv">characterBeingExamined = </span><span class="kc">undefined</span>
    <span class="nv">nextCharacterBeingExamined = </span><span class="kc">undefined</span>
    <span class="nv">aposCount = </span><span class="kc">undefined</span>
    <span class="nv">quoteCount = </span><span class="kc">undefined</span>
    <span class="nv">roundBrackCount = </span><span class="kc">undefined</span>
    <span class="nv">curlyBrackCount = </span><span class="kc">undefined</span>
    <span class="nv">squareBrackCount = </span><span class="kc">undefined</span>
    <span class="nv">elaboratedSourceByLine = </span><span class="kc">undefined</span>
    <span class="nv">iteratingOverSource = </span><span class="kc">undefined</span>
    <span class="nv">reasonOfBasicError = </span><span class="kc">undefined</span>
    <span class="vi">@currentCodeString = </span><span class="nx">code</span>
    <span class="k">if</span> <span class="nx">@currentCodeString</span> <span class="o">is</span> <span class="s">&quot;&quot;</span>
      <span class="vi">@liveCodeLabCoreInstance.graphicsCommands.resetTheSpinThingy = </span><span class="kc">true</span>
      <span class="nv">programHasBasicError = </span><span class="kc">false</span>
      <span class="nx">@eventRouter</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;clear-error&quot;</span>
      <span class="vi">@liveCodeLabCoreInstance.drawFunctionRunner.consecutiveFramesWithoutRunTimeError = </span><span class="mi">0</span>
      <span class="nv">functionFromCompiledCode = </span><span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">drawFunctionRunner</span><span class="p">.</span><span class="nx">setDrawFunction</span> <span class="kc">null</span>
      <span class="vi">@liveCodeLabCoreInstance.drawFunctionRunner.lastStableDrawFunction = </span><span class="kc">null</span>
      <span class="k">return</span> <span class="nx">functionFromCompiledCode</span>
    <span class="nv">code = </span><span class="nx">@removeTickedDoOnce</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>////////////////// Newer code checks</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>The CodeChecker will check for unbalanced brackets
and unfinished strings
#
If any errors are found then we quit compilation here
and display an error message</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>errResults = CodeChecker.parse(code);</p>

<p>if (errResults.err === true) {
    @eventRouter.trigger('compile-time-error-thrown', errResults.message);
    return;
}</p>

<p>elaboratedSource = code;
elaboratedSource = preprocessingFunctions.adjustPostfixNotations(elaboratedSource);
elaboratedSource = preprocessingFunctions.fixTimesFunctions(elaboratedSource);
elaboratedSource = preprocessingFunctions.addDoOnceTracing(elaboratedSource);</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>//////////////// Older code checks</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nv">code = </span><span class="nx">@stripCommentsAndCheckBasicSyntax</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">code</span> <span class="o">is</span> <span class="kc">null</span>
    <span class="nv">elaboratedSource = </span><span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>allow some common command forms can be used in postfix notation, e.g.
  60 bpm
  red fill
  yellow stroke
  black background</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">@adjustPostfixNotations</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>little trick. This is mangled up in the translation from coffeescript
(1).times ->
But this isn't:
(1+0).times ->
So here is the little replace.
TODO:
you should be a little smarter about the substitution of the draw method
You can tell a method declaration because the line below is indented
so you should check that.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\d+)\s+times[ ]*\-&gt;/g</span><span class="p">,</span> <span class="s">&quot;;( $1 + 0).times -&gt;&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>code =  code.replace(
  /^([a-z]+[a-zA-Z0-9]+)\s*$/gm, "$1 = ->" );
some replacements add a semicolon for the
following reason: coffeescript allows you to split arguments
over multiple lines.
So if you have:
  rotate 0,0,1
  box
and you want to add a scale like so:
  scale 2,2,2
  rotate 0,0,1
  box
What happens is that as you are in the middle of typing:
  scale 2,
  rotate 0,0,1
  box
coffeescript takes the rotate as the second argument of scale
causing mayhem.
Instead, all is good if rotate is prepended with a semicolon.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Each doBlock, when run, pushes its own line number to a particular
array. It leaves traces of which doOnce block has been run and
where exactly it is so that we can go back and mark it with a tick
(which prevents a second run to happen, as the tickmarks expand into
line comments).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">@addTracingInstructionsToDoOnceBlocks</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>adding () to single tokens left on their own</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\s*)([a-z]+[a-zA-Z0-9]*)[ ]*$/gm</span><span class="p">,</span> <span class="s">&quot;$1;$2()&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>this takes care of when a token that it's supposed to be
a function is inlined with something else with a semicolon:
doOnce frame = 0; box</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;\s*([a-z]+[a-zA-Z0-9]*)[ ]*([;\n]+)/g</span><span class="p">,</span> <span class="s">&quot;;$1()$2&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>this takes care of when a token that it's supposed to be
a function is inlined like with times like so:
2 times -> box</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\-&gt;\s*([a-z]+[a-zA-Z0-9]*)[ ]*([;\n]+)/g</span><span class="p">,</span> <span class="s">&quot;;$1()$2&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>draw() could just be called by mistake and it's likely
to be disastrous. User doesn't even have visibility of such method,
why should he/she call it?
TODO: call draw() something else that the user is not
likely to use by mistake and take away this check.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">code</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[\s\+\;]+draw\s*\(/</span><span class="p">)</span> <span class="o">or</span> <span class="kc">false</span>
      <span class="nv">programHasBasicError = </span><span class="kc">true</span>
      <span class="nx">@eventRouter</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;compile-time-error-thrown&quot;</span><span class="p">,</span> <span class="s">&quot;You can&#39;t call draw()&quot;</span>
      <span class="k">return</span>
    </pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>we don't want if and for to undergo the same tratment as, say, box
so put those back to normal.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;(if)\(\)/g</span><span class="p">,</span> <span class="s">&quot;;$1&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;(else)\(\)/g</span><span class="p">,</span> <span class="s">&quot;;$1&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;(for)\(\)/g</span><span class="p">,</span> <span class="s">&quot;;$1&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/\//g</span><span class="p">,</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Why do we have to match a non-digit non-letter?
because we have to make sure that the keyword is "on its own"
otherwise we interfere the replacements of "background" and "round"
Checking whether the keyword is "on its own" avoid those interferences.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(scale)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(rotate)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(move)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(rect)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(line)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(bpm)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(play)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(pushMatrix)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(popMatrix)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(resetMatrix)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(fill)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(noFill)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(stroke)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(noStroke)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(strokeSize)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(animationStyle)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(simpleGradient)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(background)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(colorMode)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(color)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>code =  code.replace(/([^a-zA-Z0-9])(ambient)(\s)+/g, "$1;$2$3" );
code =  code.replace(/([^a-zA-Z0-9])(reflect)(\s)+/g, "$1;$2$3" );
code =  code.replace(/([^a-zA-Z0-9])(refract)(\s)+/g, "$1;$2$3" );</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(lights)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(noLights)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(ambientLight)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(pointLight)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(ball)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(ballDetail)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(peg)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Calculation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(abs)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(ceil)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(constrain)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(dist)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(exp)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(floor)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(lerp)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(log)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(mag)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(map)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(max)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(min)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(norm)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(pow)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(round)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(sq)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(sqrt)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Trigonometry</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(acos)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(asin)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(atan)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(atan2)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(cos)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(degrees)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(radians)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(sin)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(tan)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Random</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(random)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(randomSeed)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(noise)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(noiseDetail)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^a-zA-Z0-9])(noiseSeed)(\s)+/g</span><span class="p">,</span> <span class="s">&quot;$1;$2$3&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>you'd think that semicolons are OK anywhere before any command
but coffee-script doesn't like some configurations - fixing those:
the semicolon mangles the first line of the function definitions:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-&gt;(\s+);/g</span><span class="p">,</span> <span class="s">&quot;-&gt;$1&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>the semicolon mangles the first line of if statements</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\sif\s*.*\s*);/g</span><span class="p">,</span> <span class="s">&quot;$1&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>the semicolon mangles the first line of else if statements</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\s);(else\s*if\s*.*\s*);/g</span><span class="p">,</span> <span class="s">&quot;$1$2&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>the semicolon mangles the first line of else statements</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\s);(else.*\s*);/g</span><span class="p">,</span> <span class="s">&quot;$1$2&quot;</span><span class="p">)</span>
    <span class="k">try</span>
      <span class="nv">compiledOutput = </span><span class="nx">@CoffeeCompiler</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span>
        <span class="nv">bare: </span><span class="s">&quot;on&quot;</span>
      <span class="p">)</span>
    <span class="k">catch</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>coffescript compiler has caught a syntax error.
we are going to display the error and we WON'T register
the new code</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@eventRouter</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;compile-time-error-thrown&quot;</span><span class="p">,</span> <span class="nx">e</span>
      <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>alert compiledOutput</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">programHasBasicError = </span><span class="kc">false</span>
    <span class="nx">@eventRouter</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;clear-error&quot;</span>
    
    <span class="vi">@liveCodeLabCoreInstance.drawFunctionRunner.consecutiveFramesWithoutRunTimeError = </span><span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>You might want to change the frame count from the program
just like you can in Processing, but it turns out that when
you ASSIGN a value to the frame variable inside
the coffeescript code, the coffeescript to javascript translator
declares a <em>local</em> frame variable, so changes to the frame
count get lost from one frame to the next.
TODO: There must be a way to tell coffeescript to accept
some variables as global, for the time being let's put
the cheap hack in place i.e. remove any local declaration that the
coffeescript to javascript translator inserts.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">compiledOutput = </span><span class="nx">compiledOutput</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/var frame/</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>elegant way to not use eval</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">functionFromCompiledCode = </span><span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="nx">compiledOutput</span><span class="p">)</span>
    <span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">drawFunctionRunner</span><span class="p">.</span><span class="nx">setDrawFunction</span> <span class="nx">functionFromCompiledCode</span>
    <span class="nx">functionFromCompiledCode</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>this function is used externally after the code has been
run, so we need to attach it to the CodeTransformer object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addCheckMarksAndUpdateCodeAndNotifyChange: </span><span class="o">\</span>
      <span class="nf">(CodeTransformer, doOnceOccurrencesLineNumbers) -&gt;</span>
    <span class="nv">elaboratedSource = </span><span class="kc">undefined</span>
    <span class="nv">elaboratedSourceByLine = </span><span class="kc">undefined</span>
    <span class="nv">iteratingOverSource = </span><span class="kc">undefined</span>
    <span class="nv">drawFunction = </span><span class="kc">undefined</span>
    </pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>if we are here, the following has happened: someone has added an element
to the doOnceOccurrencesLineNumbers array. This can only have happened
when a doOnce block is run, because we manipulate each doOnce block
so that in its first line the line number of the block is pushed into
the doOnceOccurrencesLineNumbers array.
So, the doOnceOccurrencesLineNumbers array contains all and only the lines
of each doOnce block that has been run. Which could be more than one,
because when we start the program we could have more than one
doOnce that has to run.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">elaboratedSource = </span><span class="nx">@currentCodeString</span>
    </pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>we know the line number of each doOnce block that has been run
so we go there and add a tick next to each doOnce to indicate
that it has been run.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">elaboratedSourceByLine = </span><span class="nx">elaboratedSource</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">iteratingOverSource</span> <span class="k">in</span> <span class="nx">doOnceOccurrencesLineNumbers</span>
      <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">]</span> <span class="o">=</span>
        <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span>
          <span class="sr">/^(\s*)doOnce([ ]*\-&gt;[ ]*.*)$/gm</span><span class="p">,</span> <span class="s">&quot;$1✓doOnce$2&quot;</span><span class="p">)</span>
    <span class="nv">elaboratedSource = </span><span class="nx">elaboratedSourceByLine</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>puts the new code (where the doOnce that have been executed have
tickboxes put back) in the editor. Which will trigger a re-registration
of the new code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@eventRouter</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;code-updated-by-livecodelab&quot;</span><span class="p">,</span> <span class="nx">elaboratedSource</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>alert elaboratedSource
we want to avoid that another frame is run with the old
code, as this would mean that the
runOnce code is run more than once,
so we need to register the new code.
TODO: ideally we don't want to register the
new code by getting the code from codemirror again
because we don't know what that entails. We should
just pass the code we already have.
Also updateCode() may split the source code by line, so we can
avoid that since we've just split it, we could pass
the already split code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">drawFunction = </span><span class="nx">@updateCode</span><span class="p">(</span><span class="nx">elaboratedSource</span><span class="p">)</span>
    <span class="nx">drawFunction</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 