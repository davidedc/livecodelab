<!DOCTYPE html>  <html> <head>   <title>graphics-commands.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.coffee               </a>                                           <a class="source" href="autocoder.html">                 autocoder.coffee               </a>                                           <a class="source" href="lexer.html">                 lexer.coffee               </a>                                           <a class="source" href="background-painter.html">                 background-painter.coffee               </a>                                           <a class="source" href="big-cursor.html">                 big-cursor.coffee               </a>                                           <a class="source" href="blend-controls.html">                 blend-controls.coffee               </a>                                           <a class="source" href="code-transformer.html">                 code-transformer.coffee               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.coffee               </a>                                           <a class="source" href="colour-literals.html">                 colour-literals.coffee               </a>                                           <a class="source" href="editor.html">                 editor.coffee               </a>                                           <a class="source" href="event-router.html">                 event-router.coffee               </a>                                           <a class="source" href="globals.html">                 globals.coffee               </a>                                           <a class="source" href="graphics-commands.html">                 graphics-commands.coffee               </a>                                           <a class="source" href="init.html">                 init.coffee               </a>                                           <a class="source" href="lights-commands.html">                 lights-commands.coffee               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.coffee               </a>                                           <a class="source" href="math.html">                 math.coffee               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.coffee               </a>                                           <a class="source" href="parser.html">                 parser.coffee               </a>                                           <a class="source" href="program-loader.html">                 program-loader.coffee               </a>                                           <a class="source" href="program-runner.html">                 program-runner.coffee               </a>                                           <a class="source" href="renderer.html">                 renderer.coffee               </a>                                           <a class="source" href="samplebank.html">                 samplebank.coffee               </a>                                           <a class="source" href="sound-system.html">                 sound-system.coffee               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.coffee               </a>                                           <a class="source" href="threejs-system.html">                 threejs-system.coffee               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.coffee               </a>                                           <a class="source" href="ui.html">                 ui.coffee               </a>                                           <a class="source" href="url-router.html">                 url-router.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               graphics-commands.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Please reference the colour-functions.js file for all colour-related
functions and lights-functions.js for lights, which use a similar
structure for caching and counting of light instances.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>Fundamentals</h1>

<p>There are a couple of fundamentals of LiveCodeLab and a couple of
complications of Three.js that shape the way
graphic primitives work in this file.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>LiveCodeLab uses immediate mode graphics</h2>

<p>First off, like Processing, LiveCodeLab shies away from "retained" graphics
and instead uses "immediate mode" graphics.
For context, "immediate mode" graphics means that when the user uses a
graphic primitive, he is
NOT given a handle that he can use to modify properties of that element at a
later stage, contrarily to flash, DOM, CSS, openGL and Three.JS
(to different degrees).
Retained graphic modes keep structures in memory that make easy for example
to do event handling (which object did I click?), hierarchy management
(parent/child relationships, container/content, etc), property tweaking
(change property X of object Y), and sometimes animation ( CoreAnimation from
Apple for example), collision/overlap detection. Note that openGL is retained
in that there are handles to geometry and textures, but little else is given
(no events, no input, no physics/overlap/collision/animation).
Also, retained graphics mode usually is smart about updating
only minimal parts of the screen that need updating rather than redrawing the
whole screen (again, openGL doesn't do that apart from basic frustum culling,
but for example there is nothing to detect occlusions and avoid painting
occluded objects).
There are a few drawbacks in retained modes: a) programs that manage
handles are more lengthy than programs that don't
b) they are often not needed for example in
2d sprites-based videogames c) most importantly,
they require deeper understanding of the underlying
model (e.g. which property can I change?
What are those called?
How do I change parent/child relationship?
How do events bubble up and where should I catch them?).
Processing and LiveCodeLab go for immediate mode.
Once the primitive is invoked, it
becomes pixels and there is no built-in way to do input/event/hierarchies...
Rather, there are a few properties that are set as a global state and apply
to all objects. Examples are "fill" and "stroke".</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Relationship between objects, meshes, geometry, materials...</h2>

<p>A Three.js object (or to be more precise, Object3D) can be a line or a mesh.
A line is a line, a mesh can be anything else depending on what the geometry
of the mesh is. There are more possible types such as particles, etc. but
they are not currently used in LiveCodeLab.
An object needs one more thing: a material.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Caching of objects</h2>

<p>Once created, objects are kept cached together with all possible materials
that can be associated with it. Each object has to have its own set of
materials because one can decide to draw one object in solid fill, one in
normal color, one with an ambient light (i.e. lambert material), etc.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Objects are kept in the scene</h2>

<p>Once an object is added to the scene, it's never removed. Rather, it's hidden
if it's not used, but it's never removed. This is because adding/removing
objects from the scene is rather expensive. Note that Mr Doob mentioned via
email that subsequent versions of three.js have improved performance a lot,
so it's worth trying another approach.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>Strokes are managed via separate objects for stroke and fill</h2>

<p>There is a particular flag in Three.js materials for drawing wireframes.
But materials cannot be combined, i.e. only one is associated at any time
with a geometry. So one can either draw a wireframe or a fill. In previous
versions of Three.js more than one material could be associated, but that has
been deprecated, see https://github.com/mrdoob/three.js/issues/751 and
instead a createMultiMaterialObject utility was put in place, which basically
creates multiple objects one for each material, see
https://github.com/mrdoob/three.js/blob/dev/src/extras/SceneUtils.js#L29
So the solution here is to create two disting objects.
One for the fills and one, slightly "larger", for the strokes. In that way,
the strokes are visible "in front" of the fills, and the fills cover the
strokes "at the back"</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>The order of materials matters</h2>

<p>When an object is created, it must be first rendered with the most complex
material, because internally in Three.js/WebGL memory is allocated only once.
So a special mechanism is put in place by which new objects are drawn with
the normalMaterial with scale 0, so they are rendered but they are invisible.
In the next frame (i.e. after the first render) the correct material is used.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>"Spinning"</h2>

<p>"Spinning" applies to all objects added to an empty frame: it makes all
objects spin for a few frames. This has been implemented for two reasons
a) cosmetic
b) the user is likely to first use "box", and without spinning that
  would look like a boring square that appears without animation.
Spinning gives many more cues:
the environment is 3d, the lighting is special by default and all faces have
primary colors, things animate. Without spinning, all those cues need to be
further explained and demonstra ted.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">GraphicsCommands</span>

  <span class="nv">primitiveTypes: </span><span class="p">{}</span>
  <span class="nv">minimumBallDetail: </span><span class="mi">2</span>
  <span class="nv">maximumBallDetail: </span><span class="mi">30</span>
  <span class="nv">doFill: </span><span class="kc">true</span>
  <span class="nv">doStroke: </span><span class="kc">true</span>
  <span class="nv">reflectValue: </span><span class="mi">1</span>
  <span class="nv">refractValue: </span><span class="mf">0.98</span>
  <span class="nv">currentStrokeAlpha: </span><span class="kc">undefined</span>
  <span class="nv">currentStrokeColor: </span><span class="kc">undefined</span>
  <span class="nv">geometriesBank: </span><span class="p">[]</span>
  <span class="nv">SPIN_DURATION_IN_FRAMES: </span><span class="mi">30</span>
  <span class="nv">currentFillAlpha: </span><span class="kc">undefined</span>
  <span class="nv">currentFillColor: </span><span class="kc">undefined</span>
  <span class="nv">objectPools: </span><span class="p">[]</span>
  <span class="nv">ballDetLevel: </span><span class="mi">8</span>
  <span class="nv">currentStrokeSize: </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>For each pool we have a count of how many of those entries
are actually used in the current frame.
This is so that we can go through the scene graph
and hide the unused objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">objectsUsedInFrameCounts: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>the "spinthingy" is because we want
users who type "box" to see that it's actually
a 3d environment. So the first few primitives
spin for a few moments when they are created.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doTheSpinThingy: </span><span class="kc">true</span>
  <span class="nv">resetTheSpinThingy: </span><span class="kc">false</span>
  <span class="nv">defaultNormalFill: </span><span class="kc">true</span>
  <span class="nv">defaultNormalStroke: </span><span class="kc">true</span>
  
  <span class="nv">constructor: </span><span class="nf">(@liveCodeLabCore_three, @liveCodeLabCoreInstance) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">line = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@line</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">rect = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@rect</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">box = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@box</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">peg = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@peg</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">ball = </span><span class="nf">(a,b,c) =&gt;</span> <span class="nx">@ball</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">ballDetail = </span><span class="nf">(a) =&gt;</span> <span class="nx">@ballDetail</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">fill = </span><span class="nf">(a,b,c,d) =&gt;</span> <span class="nx">@fill</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">noFill = </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">@noFill</span><span class="p">()</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">stroke = </span><span class="nf">(a,b,c,d) =&gt;</span> <span class="nx">@stroke</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">noStroke = </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">@noStroke</span><span class="p">()</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">strokeSize = </span><span class="nf">(a) =&gt;</span> <span class="nx">@strokeSize</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    
    <span class="vi">@primitiveTypes.ambientLight = </span><span class="mi">0</span>
    <span class="vi">@primitiveTypes.line = </span><span class="mi">1</span>
    <span class="vi">@primitiveTypes.rect = </span><span class="mi">2</span>
    <span class="vi">@primitiveTypes.box = </span><span class="mi">3</span>
    <span class="vi">@primitiveTypes.peg = </span><span class="mi">4</span>
    <span class="vi">@primitiveTypes.ball = </span><span class="mi">5</span>
    </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>apparently in Coffeescript I can't initialise fields in the section
before the constructor, so initialising them here in the constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">line</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">rect</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">box</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">peg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>creating ball pools</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">@maximumBallDetail</span> <span class="o">-</span> <span class="nx">@minimumBallDetail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
      <span class="nx">@objectPools</span><span class="p">[</span><span class="nx">@primitiveTypes</span><span class="p">.</span><span class="nx">ball</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    
    <span class="nx">Since</span> <span class="nx">you</span> <span class="nx">can</span><span class="s">&#39;t change the geometry of an object once it&#39;</span><span class="nx">s</span> <span class="nx">created</span><span class="p">,</span> <span class="nx">we</span> <span class="nx">keep</span>
    <span class="nx">around</span> <span class="nx">a</span> <span class="nx">pool</span> <span class="k">of</span> <span class="nx">objects</span> <span class="k">for</span> <span class="nx">each</span> <span class="nx">mesh</span> <span class="nx">type</span><span class="p">.</span> <span class="nx">There</span> <span class="o">is</span> <span class="nx">one</span> <span class="nx">pool</span> <span class="k">for</span> <span class="nx">lines</span><span class="p">,</span>
    <span class="nx">one</span> <span class="k">for</span> <span class="nx">rectangles</span><span class="p">,</span> <span class="nx">one</span> <span class="k">for</span> <span class="nx">boxes</span><span class="p">.</span> <span class="nx">There</span> <span class="o">is</span> <span class="nx">one</span> <span class="nx">pool</span> <span class="k">for</span> <span class="nx">each</span> <span class="nx">detail</span> <span class="nx">level</span>
    <span class="k">of</span> <span class="nx">balls</span> <span class="p">(</span><span class="nx">since</span> <span class="nx">they</span> <span class="nx">are</span> <span class="nx">different</span><span class="p">)</span> <span class="nx">meshes</span><span class="p">.</span> <span class="nx">For</span> <span class="nx">the</span> <span class="nx">time</span> <span class="nx">being</span> <span class="nx">there</span> <span class="o">is</span>
    <span class="kc">no</span> <span class="nx">detail</span> <span class="nx">level</span> <span class="k">for</span> <span class="nx">cylinders</span> <span class="nx">so</span> <span class="nx">there</span> <span class="o">is</span> <span class="nx">only</span> <span class="nx">one</span> <span class="nx">pool</span> <span class="k">for</span> <span class="nx">cylinders</span><span class="p">.</span>

    <span class="nx">For</span> <span class="nx">how</span> <span class="nx">the</span> <span class="nx">mechanism</span> <span class="nx">works</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">all</span> <span class="nx">pooled</span> <span class="nx">objects</span> <span class="nx">end</span> <span class="nx">up</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">scene</span>
    <span class="nx">graph</span><span class="p">.</span>  <span class="nx">The</span> <span class="nx">scene</span> <span class="nx">graph</span> <span class="o">is</span> <span class="nx">traversed</span> <span class="nx">at</span> <span class="nx">each</span> <span class="nx">frame</span> <span class="o">and</span> <span class="nx">only</span> <span class="nx">the</span> <span class="nx">used</span>
    <span class="nx">objects</span> <span class="nx">are</span> <span class="nx">marked</span> <span class="nx">as</span> <span class="nx">visible</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">other</span> <span class="nx">unused</span> <span class="nx">objects</span> <span class="nx">are</span> <span class="nx">hidden</span><span class="p">.</span> <span class="nx">This</span>
    <span class="o">is</span> <span class="nx">because</span> <span class="nx">adding</span><span class="o">/</span><span class="nx">removing</span> <span class="nx">objects</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">scene</span> <span class="o">is</span> <span class="nx">expensive</span><span class="p">.</span> <span class="nx">Note</span> <span class="nx">that</span>
    <span class="k">this</span> <span class="nx">might</span> <span class="nx">have</span> <span class="nx">changed</span> <span class="nx">with</span> <span class="nx">more</span> <span class="nx">recent</span> <span class="nx">versions</span> <span class="k">of</span> <span class="nx">Three</span><span class="p">.</span><span class="nx">js</span> <span class="k">of</span>
    <span class="nx">the</span> <span class="nx">past</span> <span class="mi">4</span> <span class="nx">months</span><span class="p">.</span>

    <span class="nx">All</span> <span class="nx">object</span> <span class="nx">pools</span> <span class="nx">start</span> <span class="nx">empty</span><span class="p">.</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="nx">each</span> <span class="nx">ball</span> <span class="nx">detail</span> <span class="nx">level</span> <span class="nx">must</span> <span class="nx">have</span>
    <span class="nx">its</span> <span class="k">own</span> <span class="nx">pool</span><span class="p">,</span> <span class="nx">because</span> <span class="nx">you</span> <span class="nx">can</span><span class="s">&#39;t change the geometry of an object.</span>
<span class="s">    If one doesn&#39;</span><span class="nx">t</span> <span class="nx">like</span> <span class="nx">the</span> <span class="nx">idea</span> <span class="k">of</span> <span class="nx">creating</span> <span class="nx">dozens</span> <span class="k">of</span> <span class="nx">empty</span> <span class="nx">arrays</span> <span class="nx">that</span>
    <span class="nx">won</span><span class="s">&#39;t ever be used (since probably only a few ball detail levels will</span>
<span class="s">    be used in a session) then one could leave all these arrays undefined</span>
<span class="s">    and define them at runtime only when needed.</span>
<span class="s">    </span>
<span class="s">    </span>
<span class="s">    @geometriesBank[@primitiveTypes.line] = new @liveCodeLabCore_three.Geometry()</span>
<span class="s">    @geometriesBank[@primitiveTypes.line].vertices.push \</span>
<span class="s">      new @liveCodeLabCore_three.Vector3(0, -0.5, 0)</span>
<span class="s">    @geometriesBank[@primitiveTypes.line].vertices.push \</span>
<span class="s">      new @liveCodeLabCore_three.Vector3(0, 0.5, 0)</span>
<span class="s">    @geometriesBank[@primitiveTypes.rect] = new @liveCodeLabCore_three.PlaneGeometry(1, 1)</span>
<span class="s">    @geometriesBank[@primitiveTypes.box] = new @liveCodeLabCore_three.CubeGeometry(1, 1, 1)</span>
<span class="s">    @geometriesBank[@primitiveTypes.peg] =</span>
<span class="s">      new @liveCodeLabCore_three.CylinderGeometry(0.5, 0.5, 1, 32)</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    for i in [0...(@maximumBallDetail - @minimumBallDetail + 1)]</span>
<span class="s">      @geometriesBank[@primitiveTypes.ball + i] =</span>
<span class="s">        new @liveCodeLabCore_three.SphereGeometry(</span>
<span class="s">          1, @minimumBallDetail + i, @minimumBallDetail + i)</span>
<span class="s">    </span>
<span class="s">  </span>
<span class="s">  createObjectIfNeededAndDressWithCorrectMaterial: (</span>
<span class="s">    a, b, c, primitiveProperties, strokeTime, colorToBeUsed,</span>
<span class="s">    alphaToBeUsed, applyDefaultNormalColor) -&gt;</span>
<span class="s">    objectIsNew = false</span>
<span class="s">    pooledObjectWithMaterials = undefined</span>
<span class="s">    theAngle = undefined</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    primitiveID = primitiveProperties.primitiveType + primitiveProperties.detailLevel</span>
<span class="s">    objectPool = @objectPools[primitiveID]</span>
<span class="s">    pooledObjectWithMaterials = objectPool[@objectsUsedInFrameCounts[primitiveID]]</span>
<span class="s">    if not pooledObjectWithMaterials?</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      pooledObjectWithMaterials =</span>
<span class="s">        </span>

<span class="s">#DIVIDER</span>
<span class="s">        lineMaterial: undefined</span>
<span class="s">        </span>

<span class="s">#DIVIDER</span>
<span class="s">        basicMaterial: undefined</span>
<span class="s">        </span>

<span class="s">#DIVIDER</span>
<span class="s">        lambertMaterial: undefined</span>
<span class="s">        </span>

<span class="s">#DIVIDER</span>
<span class="s">        normalMaterial: undefined</span>
<span class="s">        threejsObject3D: (</span>
<span class="s">          new primitiveProperties.threeObjectConstructor(</span>
<span class="s">            @geometriesBank[primitiveID]</span>
<span class="s">          )</span>
<span class="s">        )</span>
<span class="s">        initialSpinCountdown: @SPIN_DURATION_IN_FRAMES</span>

<span class="s">      objectIsNew = true</span>
<span class="s">      objectPool.push pooledObjectWithMaterials</span>
<span class="s">    if primitiveProperties.primitiveType is @primitiveTypes.line</span>
<span class="s">      if not pooledObjectWithMaterials.lineMaterial?</span>
<span class="s">        pooledObjectWithMaterials.lineMaterial =</span>
<span class="s">          new @liveCodeLabCore_three.LineBasicMaterial()</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      if @currentStrokeColor is angleColor or @defaultNormalStroke</span>
<span class="s">        theAngle =</span>
<span class="s">          pooledObjectWithMaterials.threejsObject3D.matrix.multiplyVector3(</span>
<span class="s">            new @liveCodeLabCore_three.Vector3(0, 1, 0)).normalize()</span>
<span class="s">        pooledObjectWithMaterials.lineMaterial.color.setHex(</span>
<span class="s">          color(</span>
<span class="s">            ((theAngle.x + 1) / 2) * 255,</span>
<span class="s">            ((theAngle.y + 1) / 2) * 255,</span>
<span class="s">            ((theAngle.z + 1) / 2) * 255</span>
<span class="s">          )</span>
<span class="s">        )</span>
<span class="s">      else</span>
<span class="s">        pooledObjectWithMaterials.lineMaterial.color.setHex @currentStrokeColor</span>
<span class="s">      pooledObjectWithMaterials.lineMaterial.linewidth =</span>
<span class="s">        @currentStrokeSize</span>
<span class="s">      pooledObjectWithMaterials.threejsObject3D.material =</span>
<span class="s">        pooledObjectWithMaterials.lineMaterial</span>
<span class="s">    else if objectIsNew or (</span>
<span class="s">      colorToBeUsed is angleColor or applyDefaultNormalColor</span>
<span class="s">    )</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      if not pooledObjectWithMaterials.normalMaterial?</span>
<span class="s">        pooledObjectWithMaterials.normalMaterial =</span>
<span class="s">          new @liveCodeLabCore_three.MeshNormalMaterial()</span>
<span class="s">      pooledObjectWithMaterials.threejsObject3D.material =</span>
<span class="s">        pooledObjectWithMaterials.normalMaterial</span>
<span class="s">    else unless @liveCodeLabCoreInstance.lightSystem.lightsAreOn</span>
<span class="s">      if not pooledObjectWithMaterials.basicMaterial?</span>
<span class="s">        pooledObjectWithMaterials.basicMaterial =</span>
<span class="s">          new @liveCodeLabCore_three.MeshBasicMaterial()</span>
<span class="s">      pooledObjectWithMaterials.basicMaterial.color.setHex colorToBeUsed</span>
<span class="s">      pooledObjectWithMaterials.threejsObject3D.material =</span>
<span class="s">        pooledObjectWithMaterials.basicMaterial</span>
<span class="s">    else</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      if not pooledObjectWithMaterials.lambertMaterial?</span>
<span class="s">        pooledObjectWithMaterials.lambertMaterial =</span>
<span class="s">          new @liveCodeLabCore_three.MeshLambertMaterial()</span>
<span class="s">      pooledObjectWithMaterials.lambertMaterial.color.setHex colorToBeUsed</span>
<span class="s">      pooledObjectWithMaterials.threejsObject3D.material =</span>
<span class="s">        pooledObjectWithMaterials.lambertMaterial</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.material.side =</span>
<span class="s">      primitiveProperties.sidedness</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.material.opacity = alphaToBeUsed</span>
<span class="s">    if alphaToBeUsed &lt; 1</span>
<span class="s">      pooledObjectWithMaterials.threejsObject3D.material.transparent = true</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.material.wireframe = strokeTime</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.material.wireframeLinewidth =</span>
<span class="s">      @currentStrokeSize</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.material.reflectivity = @reflectValue</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.material.refractionRatio = @refractValue</span>
<span class="s">    if @resetTheSpinThingy</span>
<span class="s">      pooledObjectWithMaterials.initialSpinCountdown = @SPIN_DURATION_IN_FRAMES</span>
<span class="s">      @resetTheSpinThingy = false</span>
<span class="s">      @doTheSpinThingy = true</span>
<span class="s">    if @doTheSpinThingy</span>
<span class="s">      pooledObjectWithMaterials.initialSpinCountdown -= 1</span>
<span class="s">    if pooledObjectWithMaterials.initialSpinCountdown is -1</span>
<span class="s">      @doTheSpinThingy = false</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.primitiveType =</span>
<span class="s">      primitiveProperties.primitiveType</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.detailLevel =</span>
<span class="s">      primitiveProperties.detailLevel</span>
<span class="s">    @objectsUsedInFrameCounts[primitiveID] += 1</span>
<span class="s">    if @doTheSpinThingy and</span>
<span class="s">        pooledObjectWithMaterials.initialSpinCountdown &gt; 0</span>
<span class="s">      @liveCodeLabCoreInstance.matrixCommands.pushMatrix()</span>
<span class="s">      @liveCodeLabCoreInstance.matrixCommands.rotate \</span>
<span class="s">        pooledObjectWithMaterials.initialSpinCountdown / 50</span>
<span class="s">    </span>
<span class="s">    </span>
<span class="s">    see</span>
<span class="s">    https://github.com/mrdoob/three.js/wiki/Using-Matrices-&amp;-Object3Ds-in-THREE</span>
<span class="s">    for info on how this works.</span>
<span class="s">    Around 11% of the time is spent doing matrix multiplications, which</span>
<span class="s">    happens every time there is a scale or rotate or move.</span>
<span class="s">    </span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.matrixAutoUpdate = false</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.matrix.copy \</span>
<span class="s">      @liveCodeLabCoreInstance.matrixCommands.getWorldMatrix()</span>
<span class="s">    pooledObjectWithMaterials.threejsObject3D.matrixWorldNeedsUpdate = true</span>
<span class="s">    if @doTheSpinThingy and</span>
<span class="s">        pooledObjectWithMaterials.initialSpinCountdown &gt; 0</span>
<span class="s">      @liveCodeLabCoreInstance.matrixCommands.popMatrix()</span>
<span class="s">    if objectIsNew</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      pooledObjectWithMaterials.threejsObject3D.matrix.scale \</span>
<span class="s">        new @liveCodeLabCore_three.Vector3(0.0001, 0.0001, 0.0001)</span>
<span class="s">    else if a isnt 1 or b isnt 1 or c isnt 1</span>
<span class="s">      if strokeTime</span>

<span class="s">#DIVIDER</span>
<span class="s">        pooledObjectWithMaterials.threejsObject3D.matrix.scale \</span>
<span class="s">          new @liveCodeLabCore_three.Vector3(a + 0.001, b + 0.001, c + 0.001)</span>
<span class="s">      else</span>
<span class="s">        pooledObjectWithMaterials.threejsObject3D.matrix.scale \</span>
<span class="s">          new @liveCodeLabCore_three.Vector3(a, b, c)</span>
<span class="s">    @liveCodeLabCoreInstance.threeJsSystem.scene.add \</span>
<span class="s">      pooledObjectWithMaterials.threejsObject3D  if objectIsNew</span>

<span class="s">  commonPrimitiveDrawingLogic: (a, b, c, primitiveProperties) -&gt;</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    if not a?</span>
<span class="s">      a = 1</span>
<span class="s">      b = 1</span>
<span class="s">      c = 1</span>
<span class="s">    else if not b?</span>
<span class="s">      b = a</span>
<span class="s">      c = a</span>
<span class="s">    else c = 1 if not c?</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    return  if not @doStroke and (</span>
<span class="s">      not @doFill or not primitiveProperties.canFill</span>
<span class="s">    )</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    if (</span>
<span class="s">      primitiveProperties.canFill and @doFill and</span>
<span class="s">      (@currentStrokeSize is 0 or not @doStroke or</span>
<span class="s">        (@currentStrokeSize &lt;= 1 and</span>
<span class="s">         not @defaultNormalFill and</span>
<span class="s">         not @defaultNormalStroke and</span>
<span class="s">         @currentStrokeColor is @currentFillColor and</span>
<span class="s">         @currentFillAlpha is 1 and @currentStrokeAlpha is 1)</span>
<span class="s">      )</span>
<span class="s">    ) or (</span>
<span class="s">      @currentStrokeSize &lt;= 1 and @defaultNormalFill and @defaultNormalStroke</span>
<span class="s">    )</span>
<span class="s">      @createObjectIfNeededAndDressWithCorrectMaterial(</span>
<span class="s">        a, b, c, primitiveProperties,</span>
<span class="s">        false, @currentFillColor, @currentFillAlpha,</span>
<span class="s">        @defaultNormalFill</span>
<span class="s">      )</span>
<span class="s">    else if (not @doFill or not primitiveProperties.canFill) and @doStroke</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      @createObjectIfNeededAndDressWithCorrectMaterial(</span>
<span class="s">        a, b, c, primitiveProperties, true,</span>
<span class="s">        @currentStrokeColor, @currentStrokeAlpha,</span>
<span class="s">        @defaultNormalStroke</span>
<span class="s">      )</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    else</span>
<span class="s">      @createObjectIfNeededAndDressWithCorrectMaterial(</span>
<span class="s">        a, b, c, primitiveProperties, true,</span>
<span class="s">        @currentStrokeColor, @currentStrokeAlpha,</span>
<span class="s">        @defaultNormalStroke</span>
<span class="s">      )</span>
<span class="s">      @createObjectIfNeededAndDressWithCorrectMaterial(</span>
<span class="s">        a, b, c, primitiveProperties, false,</span>
<span class="s">        @currentFillColor, @currentFillAlpha,</span>
<span class="s">        @defaultNormalFill</span>
<span class="s">      )</span>

<span class="s">  reset: -&gt;</span>
<span class="s">    @fill 0xFFFFFFFF</span>
<span class="s">    @stroke 0xFFFFFFFF</span>
<span class="s">    @currentStrokeSize = 1</span>
<span class="s">    @defaultNormalFill = true</span>
<span class="s">    @defaultNormalStroke = true</span>
<span class="s">    @ballDetLevel =</span>
<span class="s">      @liveCodeLabCoreInstance.threeJsSystem.ballDefaultDetLevel</span>
<span class="s">    @objectsUsedInFrameCounts\</span>
<span class="s">      [@primitiveTypes.ambientLight] = 0</span>
<span class="s">    @objectsUsedInFrameCounts[@primitiveTypes.line] = 0</span>
<span class="s">    @objectsUsedInFrameCounts[@primitiveTypes.rect] = 0</span>
<span class="s">    @objectsUsedInFrameCounts[@primitiveTypes.box] = 0</span>
<span class="s">    @objectsUsedInFrameCounts[@primitiveTypes.peg] = 0</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    for i in [0...(@maximumBallDetail - @minimumBallDetail + 1)]</span>
<span class="s">      @objectsUsedInFrameCounts[@primitiveTypes.ball + i] = 0</span>

<span class="s">  </span>

<span class="s">#DIVIDER</span>
<span class="s">  line: (a, b, c) -&gt;</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    if @liveCodeLabCoreInstance.lightSystem.lightsAreOn</span>
<span class="s">      rememberIfThereWasAFill = @doFill</span>
<span class="s">      rememberPreviousStrokeSize = @currentStrokeSize</span>
<span class="s">      @currentStrokeSize = 2  if @currentStrokeSize &lt; 2</span>
<span class="s">      a = 1 if not a?</span>
<span class="s">      @rect 0, a, 0</span>
<span class="s">      @doFill = rememberIfThereWasAFill</span>
<span class="s">      @currentStrokeSize = rememberPreviousStrokeSize</span>
<span class="s">      return</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    primitiveProperties =</span>
<span class="s">      canFill: false</span>
<span class="s">      primitiveType: @primitiveTypes.line</span>
<span class="s">      sidedness: @liveCodeLabCore_three.FrontSide</span>
<span class="s">      threeObjectConstructor: @liveCodeLabCore_three.Line</span>
<span class="s">      detailLevel: 0</span>

<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    @commonPrimitiveDrawingLogic a, b, c, primitiveProperties</span>

<span class="s">  rect: (a, b, c) -&gt;</span>

<span class="s">#DIVIDER</span>
<span class="s">    primitiveProperties =</span>
<span class="s">      canFill: true</span>
<span class="s">      primitiveType: @primitiveTypes.rect</span>
<span class="s">      sidedness: @liveCodeLabCore_three.DoubleSide</span>
<span class="s">      threeObjectConstructor: @liveCodeLabCore_three.Mesh</span>
<span class="s">      detailLevel: 0</span>

<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    @commonPrimitiveDrawingLogic a, b, c, primitiveProperties</span>

<span class="s">  box: (a, b, c) -&gt;</span>

<span class="s">#DIVIDER</span>
<span class="s">    primitiveProperties =</span>
<span class="s">      canFill: true</span>
<span class="s">      primitiveType: @primitiveTypes.box</span>
<span class="s">      sidedness: @liveCodeLabCore_three.FrontSide</span>
<span class="s">      threeObjectConstructor: @liveCodeLabCore_three.Mesh</span>
<span class="s">      detailLevel: 0</span>

<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    @commonPrimitiveDrawingLogic a, b, c, primitiveProperties</span>

<span class="s">  peg: (a, b, c) -&gt;</span>

<span class="s">#DIVIDER</span>
<span class="s">    primitiveProperties =</span>
<span class="s">      canFill: true</span>
<span class="s">      primitiveType: @primitiveTypes.peg</span>
<span class="s">      sidedness: @liveCodeLabCore_three.FrontSide</span>
<span class="s">      threeObjectConstructor: @liveCodeLabCore_three.Mesh</span>
<span class="s">      detailLevel: 0</span>

<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    @commonPrimitiveDrawingLogic a, b, c, primitiveProperties</span>

<span class="s">  ballDetail: (a) -&gt;</span>
<span class="s">    return if not a?</span>
<span class="s">    a = 2  if a &lt; 2</span>
<span class="s">    a = 30  if a &gt; 30</span>
<span class="s">    @ballDetLevel = Math.round(a)</span>

<span class="s">  ball: (a, b, c) -&gt;</span>

<span class="s">#DIVIDER</span>
<span class="s">    primitiveProperties =</span>
<span class="s">      canFill: true</span>
<span class="s">      primitiveType: @primitiveTypes.ball</span>
<span class="s">      sidedness: @liveCodeLabCore_three.FrontSide</span>
<span class="s">      threeObjectConstructor: @liveCodeLabCore_three.Mesh</span>
<span class="s">      detailLevel: @ballDetLevel - @minimumBallDetail</span>

<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    @commonPrimitiveDrawingLogic a, b, c, primitiveProperties</span>

<span class="s">  </span>

<span class="s">#DIVIDER</span>
<span class="s">  fill: (r, g, b, a) -&gt;</span>

<span class="s">#DIVIDER</span>
<span class="s">    @doFill = true</span>
<span class="s">    if r isnt angleColor</span>
<span class="s">      @defaultNormalFill = false</span>
<span class="s">      @currentFillColor = color(r, g, b)</span>
<span class="s">      @currentFillAlpha = alphaZeroToOne(color(r, g, b, a))</span>
<span class="s">    else</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      @defaultNormalFill = true</span>
<span class="s">      @currentFillColor = angleColor</span>
<span class="s">      if not b? and not g?</span>
<span class="s">        @currentFillAlpha = g / @liveCodeLabCoreInstance.colourFunctions.colorModeA</span>
<span class="s">      else</span>
<span class="s">        @currentFillAlpha = 1</span>

<span class="s">  </span>
<span class="s">  </span>
<span class="s">  The noFill() function disables filling geometry.</span>
<span class="s">  If both &lt;b&gt;noStroke()&lt;/b&gt; and &lt;b&gt;noFill()&lt;/b&gt;</span>
<span class="s">  are called, no shapes will be drawn to the screen.</span>
<span class="s">  </span>
<span class="s">  @see #fill()</span>
<span class="s">  </span>
<span class="s">  noFill: -&gt;</span>
<span class="s">    @doFill = false</span>
<span class="s">    @defaultNormalFill = false</span>

<span class="s">  </span>
<span class="s">  </span>
<span class="s">  The stroke() function sets the color used to</span>
<span class="s">  draw lines and borders around shapes.</span>
<span class="s">  This color is either specified in terms</span>
<span class="s">  of the RGB or HSB color depending on the</span>
<span class="s">  current &lt;b&gt;colorMode()&lt;/b&gt; (the default color space is RGB, with each</span>
<span class="s">  value in the range from 0 to 255).</span>
<span class="s">  &lt;br&gt;&lt;br&gt;When using hexadecimal notation to specify a color, use &quot;#&quot; or</span>
<span class="s">  &quot;0x&quot; before the values (e.g. #CCFFAA, 0xFFCCFFAA). The # syntax uses six</span>
<span class="s">  digits to specify a color (the way colors are specified in HTML and CSS).</span>
<span class="s">  When using the hexadecimal notation starting with &quot;0x&quot;, the hexadecimal</span>
<span class="s">  value must be specified with eight characters; the first two characters</span>
<span class="s">  define the alpha component and the remainder the red, green, and blue</span>
<span class="s">  components.</span>
<span class="s">  &lt;br&gt;&lt;br&gt;The value for the parameter &quot;gray&quot; must be less than or equal</span>
<span class="s">  to the current maximum value as specified by &lt;b&gt;colorMode()&lt;/b&gt;.</span>
<span class="s">  The default maximum value is 255.</span>
<span class="s">  </span>
<span class="s">  @param {int|float} gray    number specifying value between white and black</span>
<span class="s">  @param {int|float} value1  red or hue value</span>
<span class="s">  @param {int|float} value2  green or saturation value</span>
<span class="s">  @param {int|float} value3  blue or brightness value</span>
<span class="s">  @param {int|float} alpha   opacity of the stroke</span>
<span class="s">  @param {Color} color       any value of the color datatype</span>
<span class="s">  @param {int} hex           color value in hex notation</span>
<span class="s">                             (i.e. #FFCC00 or 0xFFFFCC00)</span>
<span class="s">  </span>
<span class="s">  @see #fill()</span>
<span class="s">  @see #noStroke()</span>
<span class="s">  @see #tint()</span>
<span class="s">  @see #background()</span>
<span class="s">  @see #colorMode()</span>
<span class="s">  </span>
<span class="s">  stroke: (r, g, b, a) -&gt;</span>

<span class="s">#DIVIDER</span>
<span class="s">    @doStroke = true</span>
<span class="s">    if r isnt angleColor</span>
<span class="s">      @defaultNormalStroke = false</span>
<span class="s">      @currentStrokeColor = color(r, g, b)</span>
<span class="s">      @currentStrokeAlpha = alphaZeroToOne(color(r, g, b, a))</span>
<span class="s">    else</span>
<span class="s">      </span>

<span class="s">#DIVIDER</span>
<span class="s">      @defaultNormalStroke = true</span>
<span class="s">      @currentStrokeColor = angleColor</span>
<span class="s">      if not b? and not g?</span>
<span class="s">        @currentStrokeAlpha = g / @liveCodeLabCoreInstance.colourFunctions.colorModeA</span>
<span class="s">      else</span>
<span class="s">        @currentStrokeAlpha = 1</span>

<span class="s">  </span>
<span class="s">  </span>
<span class="s">  The noStroke() function disables drawing the stroke (outline).</span>
<span class="s">  If both &lt;b&gt;noStroke()&lt;/b&gt; and &lt;b&gt;noFill()&lt;/b&gt; are called, no shapes</span>
<span class="s">  will be drawn to the screen.</span>
<span class="s">  </span>
<span class="s">  @see #stroke()</span>
<span class="s">  </span>
<span class="s">  noStroke: -&gt;</span>
<span class="s">    @doStroke = false</span>

<span class="s">  strokeSize: (a) -&gt;</span>

<span class="s">#DIVIDER</span>
<span class="s">    if not a?</span>
<span class="s">      a = 1</span>
<span class="s">    else a = 0  if a &lt; 0</span>
<span class="s">    @currentStrokeSize = a</span>

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>creating ball geometries</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>the primitiveID is used to index three arrays:
  array of caches (pools) of objects
  array of caches (pools) of geometries
  counters of how many objects of that type have been used in the
  current frame.
Note that primitives that have an associated detail
level span across multiple IDs, because geometries at
different details levels are different.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>each pooled object contains a geometry, and all the materials it could
ever need.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The line material is specifically made for lines. So for lines
we have to simulate manually the effect that the other materials
have on the solids.
Note that we can tell here whether the lineMaterial (or all the
others) will ever be needed for this object, because as mentioned
lines will ever only have the lineMaterial for example, and cubes
won't ever have the lineMaterial, but this initialisation costs
nothing and makes the code cleaner.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>The basic material is for simple solid fill without lighting</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>The Lambert material is for fill with lighting</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>The normalMaterial is the trippy fill with each side of the cube
being a bright color (the default one).
Note that the first time we render an object we need to
render it with the material that takes the
bigger buffer space, otherwise the
more complicated materials won't show
up, see:
https://github.com/mrdoob/three.js/issues/1051
so we always need to create a normal material
and render that material first, in case
the user will ever want to use it.
Another workaround would be to create an object
for each different type of material.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>associating normal material to threejs' Object3D</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>the first time we render a an object we need to
render it with the material that takes the
bigger buffer space, see:
https://github.com/mrdoob/three.js/issues/1051
Another workaround would be to create a pooled object
for each different type of material.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>lights are on</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>not all of these properties apply in all cases (for example sidedness
doesn't apply to lines), but setting these properties in those cases
has no ill effect and we are factoring out here as many initialisations
as possible to make the code cleaner.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>if the object is new it means that the normal material
is applied to it, no matter what the current settings of fill
and lights are. So we make objects invisible in their very first
frame to avoid it flashing briefly in completely the wrong colour
by setting the scale to almost zero. The object will still go through
the rendering step, so the memory for the material is initialised
correctly.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>wireframes are built via separate objects with geometries that are
ever so slight larger than the "fill" object, so there
is no z-fighting and the stroke is drawn neatly on top of the fill
constant 0.001 below is to avoid z-fighting</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>b and c are not functional in some geometric
primitives, but we handle them here in all cases
to make the code uniform and unifiable</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Simple case - if there is no fill and
no stroke then there is nothing to do.
Also, even if we aren'd under a noFill command spell, some geometries
inherently don't have a fill, so we return if there is no stroke either.
(right now that applies only lines).</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>if we are under the influence of a noFill command OR
the wireframe is not going to be visible on top of the
fill then don't draw the stroke, only draw the fill</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>only doing the stroke</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>doing both the fill and the stroke</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>initialising ball counts</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>TODO Note that lines have a "solid fill" mode
and something similar to the normalMaterial mode
but there is no equivalent to the lambert material
mode.
That could be done by somehow mixing the color of
an ambient light to the color of the stroke
(although which ambient light do you pick if there
is more than one?)</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>lines can only have one material, which is LineBasicMaterial
which doesn't react to lights (as opposed to MeshLambertMaterial, which
only applies to meshes).
So in order to get lights to react to light we have to actually draw the
wireframe of a rectangle with one of the sides being zero length.
Since the stroke and the fill are drawn with two different objects and the
fill is not needed, we temporarily switch off the fill and then
put it back to whichever value it was.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>end of primitive-specific initialisations:</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Modified from Processing.js</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Three.js needs two integers to define an RGBA: the rgb as a 24 bit integer
and the alpha (from zero to one).
Now the thing is that the color gan be given in different
shapes:
  red, green, blue, alpha
  integerOfColor, alpha
  integerForGreyScale, alpha
  the three abobe without the alpha
So the helper functions color and alphaZeroToOne, taken from Processing.js
take care of that disambiguation.
The only complication is that there is a special color called
angleColor that is used to dress the geometries with the normal material.
So in that case, again, there are two forms of invokation
  angleColor
  angleColor, alpha</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>we keep track of the "normal fill" flag and the fill color
separately because
we can do some smart optimisation later
and not draw the wireframe is it happens to be the same color as
the fill</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>see comment on fill method above
for some comments on how this method works.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>we keep track of the "normal stroke" flag and the stroke color
separately because
we can do some smart optimisation later
and not draw the wireframe is it happens to be the same color as
the fill</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>note that either Three.js of the graphic card limit the size
of the stroke. This is because openGL strokes are VERY crude
(the cap is not even square, it's worse than that:
http://twolivesleft.com/Codea/LineCapShear.png )
So it's limited to 10. In some graphic cards this doesn't even have
any effect.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 