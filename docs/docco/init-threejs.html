<!DOCTYPE html>  <html> <head>   <title>init-threejs.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.js               </a>                                           <a class="source" href="background-painting.html">                 background-painting.js               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.js               </a>                                           <a class="source" href="blend-style.html">                 blend-style.js               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="colour-definitions.html">                 colour-definitions.js               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.js               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.js               </a>                                           <a class="source" href="draw-function-runner.html">                 draw-function-runner.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="events.html">                 events.js               </a>                                           <a class="source" href="globals.html">                 globals.js               </a>                                           <a class="source" href="graphic-primitives.html">                 graphic-primitives.js               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.js               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.js               </a>                                           <a class="source" href="math.html">                 math.js               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.js               </a>                                           <a class="source" href="renderer.html">                 renderer.js               </a>                                           <a class="source" href="simple-error-checker.html">                 simple-error-checker.js               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.js               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.js               </a>                                           <a class="source" href="ui.html">                 ui.js               </a>                                           <a class="source" href="url-router.html">                 url-router.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               init-threejs.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="comment">/*jslint browser: true, devel: true */</span>

<span class="keyword">var</span> createThreeJsSystem = <span class="function"><span class="keyword">function</span> <span class="params">(Detector, THREEx, blendedThreeJsSceneCanvas, forceCanvasRenderer, testMode, liveCodeLabCore_THREE)</span> {</span>

    <span class="string">'use strict'</span>;

    <span class="keyword">var</span> ThreeJsSystem = {},
        pointLight;

    ThreeJsSystem.isWebGLUsed = <span class="literal">false</span>;

    ThreeJsSystem.composer = {};

    ThreeJsSystem.forceCanvasRenderer = forceCanvasRenderer;

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>if we've not been passed a canvas, then create a new one and make it
as big as the browser window content.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="keyword">if</span> (!blendedThreeJsSceneCanvas) {
			blendedThreeJsSceneCanvas = document.createElement(<span class="string">'canvas'</span>);
		  blendedThreeJsSceneCanvas.width = window.innerWidth;
		  blendedThreeJsSceneCanvas.height = window.innerHeight;
		}
		ThreeJsSystem.blendedThreeJsSceneCanvas = blendedThreeJsSceneCanvas;

    <span class="keyword">if</span> (!ThreeJsSystem.forceCanvasRenderer &amp;&amp; Detector.webgl) {
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Webgl init.
We allow for a bigger ball detail. <br />
Also the WebGL context allows us to use the Three JS composer and the
postprocessing effects, which use shaders.</p>             </td>             <td class="code">               <div class="highlight"><pre>        ThreeJsSystem.ballDefaultDetLevel = <span class="number">16</span>;

		    ThreeJsSystem.blendedThreeJsSceneCanvasContext = ThreeJsSystem.blendedThreeJsSceneCanvas.getContext(<span class="string">'experimental-webgl'</span>);
        ThreeJsSystem.renderer = <span class="keyword">new</span> liveCodeLabCore_THREE.WebGLRenderer({
            canvas: ThreeJsSystem.blendedThreeJsSceneCanvas,
            preserveDrawingBuffer: testMode, <span class="comment">// to allow screenshot</span>
            antialias: <span class="literal">false</span>,
            premultipliedAlpha: <span class="literal">false</span>
        });

        ThreeJsSystem.isWebGLUsed = <span class="literal">true</span>;

    } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Canvas init.
Note that the canvas init requires two extra canvases in order to achieve
the motion blur (as we need to keep the previous frame). Basically we have
to do manually what the WebGL solution achieves through the Three.js composer
and postprocessing/shaders.</p>             </td>             <td class="code">               <div class="highlight"><pre>        ThreeJsSystem.ballDefaultDetLevel = <span class="number">6</span>;

        ThreeJsSystem.currentFrameThreeJsSceneCanvas = document.createElement(<span class="string">'canvas'</span>);
        ThreeJsSystem.currentFrameThreeJsSceneCanvas.width = ThreeJsSystem.blendedThreeJsSceneCanvas.width;
        ThreeJsSystem.currentFrameThreeJsSceneCanvas.height = ThreeJsSystem.blendedThreeJsSceneCanvas.height;
        ThreeJsSystem.currentFrameThreeJsSceneCanvasContext = ThreeJsSystem.currentFrameThreeJsSceneCanvas.getContext(<span class="string">'2d'</span>);

        ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvas =
        	document.createElement(<span class="string">'canvas'</span>);
        ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvas.width =
        	ThreeJsSystem.blendedThreeJsSceneCanvas.width;
        ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvas.height =
        	ThreeJsSystem.blendedThreeJsSceneCanvas.height;
        ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvasContext =
        	ThreeJsSystem.previousFrameThreeJSSceneRenderForBlendingCanvas.getContext(<span class="string">'2d'</span>);

		    ThreeJsSystem.blendedThreeJsSceneCanvasContext = ThreeJsSystem.blendedThreeJsSceneCanvas.getContext(<span class="string">'2d'</span>);

        ThreeJsSystem.renderer = <span class="keyword">new</span> liveCodeLabCore_THREE.CanvasRenderer({
            canvas: ThreeJsSystem.currentFrameThreeJsSceneCanvas,
            antialias: <span class="literal">true</span>, <span class="comment">// to get smoother output</span>
            preserveDrawingBuffer: testMode <span class="comment">// to allow screenshot</span>
        });

    }



    ThreeJsSystem.renderer.setSize(ThreeJsSystem.blendedThreeJsSceneCanvas.width, ThreeJsSystem.blendedThreeJsSceneCanvas.height);
    ThreeJsSystem.scene = <span class="keyword">new</span> liveCodeLabCore_THREE.Scene();
    ThreeJsSystem.scene.matrixAutoUpdate = <span class="literal">false</span>;

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>put a camera in the scene</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJsSystem.camera = <span class="keyword">new</span> liveCodeLabCore_THREE.PerspectiveCamera(<span class="number">35</span>, ThreeJsSystem.blendedThreeJsSceneCanvas.width / ThreeJsSystem.blendedThreeJsSceneCanvas.height, <span class="number">1</span>, <span class="number">10000</span>);
    ThreeJsSystem.camera.position.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>);
    ThreeJsSystem.scene.add(ThreeJsSystem.camera);

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>transparently support window resize</p>             </td>             <td class="code">               <div class="highlight"><pre>    THREEx.WindowResize.bind(ThreeJsSystem.renderer, ThreeJsSystem.camera);

    ThreeJsSystem.buildPostprocessingChain = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> renderTargetParameters,
            renderTarget,
            effectSaveTarget,
            fxaaPass,
            screenPass,
            renderModel;

        renderTargetParameters = {
            format: liveCodeLabCore_THREE.RGBAFormat,
            stencilBuffer: <span class="literal">true</span>
        };

        renderTarget = <span class="keyword">new</span> liveCodeLabCore_THREE.WebGLRenderTarget(ThreeJsSystem.blendedThreeJsSceneCanvas.width / ThreeJsSystem.blendedThreeJsSceneCanvas.height, renderTargetParameters);
        effectSaveTarget = <span class="keyword">new</span> liveCodeLabCore_THREE.SavePass(<span class="keyword">new</span> liveCodeLabCore_THREE.WebGLRenderTarget(ThreeJsSystem.blendedThreeJsSceneCanvas.width / ThreeJsSystem.blendedThreeJsSceneCanvas.height, renderTargetParameters));
        effectSaveTarget.clear = <span class="literal">false</span>;

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Uncomment the three lines containing "fxaaPass" below to try a fast
antialiasing filter. Commented below because of two reasons: a) it's slow
b) it blends in some black pixels, so it only looks good in dark backgrounds
The problem of blending with black pixels is the same problem of the
motionBlur leaving a black trail - tracked in github with
https://github.com/davidedc/livecodelab/issues/22</p>             </td>             <td class="code">               <div class="highlight"><pre>        
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>fxaaPass = new liveCodeLabCore<em>THREE.ShaderPass(liveCodeLabCore</em>THREE.ShaderExtras.fxaa);
fxaaPass.uniforms.resolution.value.set(1 / window.innerWidth, 1 / window.innerHeight);</p>             </td>             <td class="code">               <div class="highlight"><pre>
        ThreeJsSystem.effectBlend = <span class="keyword">new</span> liveCodeLabCore_THREE.ShaderPass(liveCodeLabCore_THREE.ShaderExtras.blend, <span class="string">"tDiffuse1"</span>);
        screenPass = <span class="keyword">new</span> liveCodeLabCore_THREE.ShaderPass(liveCodeLabCore_THREE.ShaderExtras.screen);

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>motion blur</p>             </td>             <td class="code">               <div class="highlight"><pre>        ThreeJsSystem.effectBlend.uniforms.tDiffuse2.value = effectSaveTarget.renderTarget;
        ThreeJsSystem.effectBlend.uniforms.mixRatio.value = <span class="number">0</span>;

        renderModel = <span class="keyword">new</span> liveCodeLabCore_THREE.RenderPass(ThreeJsSystem.scene, ThreeJsSystem.camera);

        ThreeJsSystem.composer = <span class="keyword">new</span> liveCodeLabCore_THREE.EffectComposer(ThreeJsSystem.renderer, renderTarget);

        ThreeJsSystem.composer.addPass(renderModel);
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>ThreeJsSystem.composer.addPass(fxaaPass);</p>             </td>             <td class="code">               <div class="highlight"><pre>        ThreeJsSystem.composer.addPass(ThreeJsSystem.effectBlend);
        ThreeJsSystem.composer.addPass(effectSaveTarget);
        ThreeJsSystem.composer.addPass(screenPass);
        screenPass.renderToScreen = <span class="literal">true</span>;
    };

    <span class="keyword">if</span> (ThreeJsSystem.isWebGLUsed) {
        ThreeJsSystem.buildPostprocessingChain();
    }




    <span class="keyword">return</span> ThreeJsSystem;

};

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 