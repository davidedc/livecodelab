<!DOCTYPE html>  <html> <head>   <title>livecodelab-core.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.js               </a>                                           <a class="source" href="background-painting.html">                 background-painting.js               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.js               </a>                                           <a class="source" href="blend-style.html">                 blend-style.js               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="colour-definitions.html">                 colour-definitions.js               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.js               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.js               </a>                                           <a class="source" href="draw-function-runner.html">                 draw-function-runner.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="events.html">                 events.js               </a>                                           <a class="source" href="globals.html">                 globals.js               </a>                                           <a class="source" href="graphic-primitives.html">                 graphic-primitives.js               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.js               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.js               </a>                                           <a class="source" href="math.html">                 math.js               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.js               </a>                                           <a class="source" href="renderer.html">                 renderer.js               </a>                                           <a class="source" href="simple-error-checker.html">                 simple-error-checker.js               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.js               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.js               </a>                                           <a class="source" href="ui.html">                 ui.js               </a>                                           <a class="source" href="url-router.html">                 url-router.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               livecodelab-core.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>a LiveCodeLabCore instance packs together the following pieces:
 - TimeKeeper
 - THREE
 - ThreeJsSystem
 - MatrixCommands
 - BlendControls
 - SoundSystem
 - ColourFunctions
 - BackgroundPainter
 - GraphicsCommands
 - LightSystem 
 - DrawFunctionRunner
 - CodeTransformer
 - Renderer
 - AnimationLoop</p>

<p>LiveCodeLab is built one piece at a time, and the arguments in the constructor
tell how they interlock/interact:</p>

<ul>
<li>A constructor with no arguments (or where the arguments are just passed
by the caller of the very createLiveCodeLabCore function we are in),
such as createColourFunctions, is a piece
that does not need any other piece at construction time and it doesn't interact
with any of the other pieces at run time.</li>
<li>A constructor with arguments other than "liveCodeLabCoreInstance"
(such as ThreeJsSystem) only needs the pieces passed at construction time for its
own construction, and it can only interact with such pieces at runtime.</li>
<li>A constructor which contains the "liveCodeLabCoreInstance" argument, such as
CodeTransformer, might or might not need other pieces for its own construction
(if they are passed as arguments in addition to the "liveCodeLabCoreInstance" argument)
but it does interact at runtime with other pieces not passed in the constructor
argument.</li>
</ul>

<p>So, for determining the order of the constructors, one can just look at the
dependencies dictated by the arguments other than the "liveCodeLabCoreInstance"
argument. The "liveCodeLabCoreInstance" doesn't create dependencies at creation time,
it's just used by the pieces to reference other pieces that they need to interact to
at runtime.</p>

<p>It might well be that at runtime piece A interacts with piece B and viceversa.
This is why runtime interactions are not restricted to pieces passed
as arguments at construction
time, because one would need to pass constructed piece A to the constructor of piece B
and viceversa, which is obviously impossible. This is why the runtime interactions
happen through the mother of all pieces, i.e. "liveCodeLabCoreInstance" itself.</p>

<p>To determine which pieces any single piece interacts with at runtime, one
has to check all the parameters passed to the constructor. The passed pieces are likely
to mean that there is an interaction at runtime. If the "mother"
"liveCodeLabCoreInstance" is passed to the constructor, then one case to look for
all "liveCodeLabCoreInstance" occurrences and see which of its children are
accessed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="keyword">var</span> createLiveCodeLabCore = <span class="function"><span class="keyword">function</span> <span class="params">(blendedThreeJsSceneCanvas, canvasForBackground, forceCanvasRenderer, eventRouter, stats )</span> {</span>

    <span class="string">'use strict'</span>;

    <span class="keyword">var</span> liveCodeLabCoreInstance = {};

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>//////////////////////////////////////////////
Phase 1 - initialise all the fields first
//////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="keyword">if</span> (!canvasForBackground) {
      canvasForBackground = document.createElement(<span class="string">'canvas'</span>); 
    }
    liveCodeLabCoreInstance.canvasForBackground = canvasForBackground; 

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>the canvas background for the time being is only going to contain
gradients, so we can get away with creating a really tiny canvas and
stretch it. The advantage is that the fill operations are a lot faster.
We should try to use CSS instead of canvas, as in some browsers canvas
is not accelerated just as well as CSS.
backGroundFraction specifies what fraction of the window the background canvas
is going to be.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">var</span> backGroundFraction = <span class="number">1</span>/<span class="number">15</span>; 
    liveCodeLabCoreInstance.canvasForBackground.width = Math.floor(window.innerWidth * backGroundFraction); 
    liveCodeLabCoreInstance.canvasForBackground.height = Math.floor(window.innerHeight * backGroundFraction); 

    liveCodeLabCoreInstance.backgroundSceneContext = liveCodeLabCoreInstance.canvasForBackground.getContext(<span class="string">'2d'</span>); 

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>THREE is a global defined in three.min.js and used in ShaderPass, ShaderExtras, SavePass, RenderPass, MaskPass
The difference between THREE and the ThreeJsSystem initialised later is that
a) THREE is the raw Three.js system without for example the blend options.
b) ThreeJsSystem contains some convenience fields and abstractions, for example
   it keeps the renderer (whether it's canvas-based or WebGL based) in a
   "renderer" field.
Several fields/methids in ThreeJsSystem are just conveniency mappings into
the raw THREE object.
But often in LiveCodeLab there are direct reference to THREE fields/methods.
So, ThreeJsSystem provides some abstraction without attempting to be a complete
abstraction layer.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    liveCodeLabCoreInstance.THREE = THREE;

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>//////////////////////////////////////////////
Phase 2 - initialise all the pieces that don't
have any dependencies for construction
note that the "liveCodeLabCoreInstance" doesn't
count because it's only used for interactions at
runtime. Same for the arguments that come
directly from the caller of this createLiveCodeLabCore
function we are in.
//////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>
    liveCodeLabCoreInstance.TimeKeeper = createTimeKeeper();

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>this one below also interacts with ThreeJsSystem at runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.BlendControls = createBlendControls(liveCodeLabCoreInstance); 

    liveCodeLabCoreInstance.ColourFunctions = createColourFunctions(); 

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>this one below also interacts with ThreeJsSystem and BlendControls at runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.Renderer = createRenderer(liveCodeLabCoreInstance); 

    liveCodeLabCoreInstance.SoundSystem = createSoundSystem(eventRouter, buzz, createBowser(), createSampleBank(buzz)); <span class="comment">// $ </span>

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>this one below also interacts with ColourFunctions, backgroundSceneContext,
canvasForBackground at runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.BackgroundPainter = createBackgroundPainter(eventRouter, liveCodeLabCoreInstance); <span class="comment">// $ </span>

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>this one below also interacts with CodeTransformer at runtime.</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.DrawFunctionRunner = createDrawFunctionRunner(eventRouter, liveCodeLabCoreInstance); 

</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>this one also interacts with GraphicsCommands, DrawFunctionRunner at runtime.</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.CodeTransformer = createCodeTransformer(eventRouter, CoffeeScript, liveCodeLabCoreInstance); <span class="comment">// autocoder </span>

</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>this one below also interacts with TimeKeeper, MatrixCommands, BlendControls,
   SoundSystem,
   BackgroundPainter, GraphicsCommands, LightSystem, DrawFunctionRunner,
   CodeTransformer, Renderer
...at runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.AnimationLoop = createAnimationLoop(eventRouter, stats, liveCodeLabCoreInstance); 

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>//////////////////////////////////////////////
Phase 3 - initialise all the pieces that do
have dependencies with other pieces
for their construction.
Note again that the "liveCodeLabCoreInstance" doesn't
count because it's only used for interactions at
runtime.
If the other dependencies forms a cycle, something
is wrong.
//////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>this one below doesn't interact with any other piece at runtime.</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.ThreeJsSystem = createThreeJsSystem(Detector, THREEx, blendedThreeJsSceneCanvas, forceCanvasRenderer, liveCodeLabCoreInstance.THREE);

</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>this one below interacts with TimeKeeper at runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.MatrixCommands = createMatrixCommands(liveCodeLabCoreInstance.THREE, liveCodeLabCoreInstance);

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>this one below also interacts with ColourFunctions, LightSystem, MatrixCommands
ThreeJsSystem at runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.GraphicsCommands = createGraphicsCommands(liveCodeLabCoreInstance.THREE, liveCodeLabCoreInstance); <span class="comment">// color, LightSystem, MatrixCommands, ThreeJsSystem, colorModeA, redF, greenF, blueF, alphaZeroToOne </span>

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>this one below also interacts with THREE,
ThreeJsSystem, ColourFunctions at runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    liveCodeLabCoreInstance.LightSystem = createLightSystem(liveCodeLabCoreInstance.GraphicsCommands, liveCodeLabCoreInstance); 

</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>//////////////////////////////////////////////
Phase 4 - Grouped together here all the
methods. Most of the time they just delegate
to another piece.
//////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>
    liveCodeLabCoreInstance.paintARandomBackground = <span class="keyword">function</span>(){
      liveCodeLabCoreInstance.BackgroundPainter.paintARandomBackground();
    };

    liveCodeLabCoreInstance.startAnimationLoop = <span class="keyword">function</span>(){
</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>there is nothing special about starting the animation loop,
it's just a call to animate(), which then creates its own request
for the next frame. Abstracting a bit though, it's clearer this way.</p>             </td>             <td class="code">               <div class="highlight"><pre>     liveCodeLabCoreInstance.AnimationLoop.animate();
    };
    
    liveCodeLabCoreInstance.runLastWorkingDrawFunction = <span class="keyword">function</span>() {
      liveCodeLabCoreInstance.DrawFunctionRunner.reinstateLastWorkingDrawFunction();
    };

    liveCodeLabCoreInstance.loadAndTestAllTheSounds = <span class="keyword">function</span>() {
      liveCodeLabCoreInstance.SoundSystem.loadAndTestAllTheSounds();
    };
    
    liveCodeLabCoreInstance.playStartupSound = <span class="keyword">function</span>() {
      liveCodeLabCoreInstance.SoundSystem.playStartupSound();
    };
    
    liveCodeLabCoreInstance.isAudioSupported = <span class="keyword">function</span>() {
      liveCodeLabCoreInstance.SoundSystem.isAudioSupported();
    };

    liveCodeLabCoreInstance.updateCode = <span class="keyword">function</span>(updatedCode){
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>alert('updatedCode: ' + updatedCode);</p>             </td>             <td class="code">               <div class="highlight"><pre>       liveCodeLabCoreInstance.CodeTransformer.updateCode(updatedCode);
        <span class="keyword">if</span> (updatedCode !== <span class="string">''</span> &amp;&amp; liveCodeLabCoreInstance.dozingOff) {
					liveCodeLabCoreInstance.dozingOff = <span class="literal">false</span>;
					liveCodeLabCoreInstance.AnimationLoop.animate();
</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>console.log('waking up');</p>             </td>             <td class="code">               <div class="highlight"><pre>					eventRouter.trigger(<span class="string">'livecodelab-waking-up'</span>);
        }
    }

    <span class="keyword">return</span> liveCodeLabCoreInstance;
};

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 