<!DOCTYPE html>  <html> <head>   <title>program-runner.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-loop.html">                 animation-loop.coffee               </a>                                           <a class="source" href="autocoder.html">                 autocoder.coffee               </a>                                           <a class="source" href="lexer.html">                 lexer.coffee               </a>                                           <a class="source" href="background-painter.html">                 background-painter.coffee               </a>                                           <a class="source" href="big-cursor.html">                 big-cursor.coffee               </a>                                           <a class="source" href="blend-controls.html">                 blend-controls.coffee               </a>                                           <a class="source" href="code-transformer.html">                 code-transformer.coffee               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.coffee               </a>                                           <a class="source" href="colour-literals.html">                 colour-literals.coffee               </a>                                           <a class="source" href="editor.html">                 editor.coffee               </a>                                           <a class="source" href="event-router.html">                 event-router.coffee               </a>                                           <a class="source" href="globals.html">                 globals.coffee               </a>                                           <a class="source" href="graphics-commands.html">                 graphics-commands.coffee               </a>                                           <a class="source" href="init.html">                 init.coffee               </a>                                           <a class="source" href="lights-commands.html">                 lights-commands.coffee               </a>                                           <a class="source" href="livecodelab-core.html">                 livecodelab-core.coffee               </a>                                           <a class="source" href="math.html">                 math.coffee               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.coffee               </a>                                           <a class="source" href="parser.html">                 parser.coffee               </a>                                           <a class="source" href="program-loader.html">                 program-loader.coffee               </a>                                           <a class="source" href="program-runner.html">                 program-runner.coffee               </a>                                           <a class="source" href="renderer.html">                 renderer.coffee               </a>                                           <a class="source" href="samplebank.html">                 samplebank.coffee               </a>                                           <a class="source" href="sound-system.html">                 sound-system.coffee               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.coffee               </a>                                           <a class="source" href="threejs-system.html">                 threejs-system.coffee               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.coffee               </a>                                           <a class="source" href="ui.html">                 ui.coffee               </a>                                           <a class="source" href="url-router.html">                 url-router.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               program-runner.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>ProgramRunner manages the running function as it runs. E.g. this is not a
translation step, this is managing things such as the actually running of the
latest "stable" function and keeping track of when a function appears
to be stable, and reinstating the last stable function if the current one
throws a runtime error.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ProgramRunner</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>this array is used to keep track of all the instances of "doOnce" in the
code we need to keep this so we can put the ticks next to doOnce once
that doOnce block has run.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">doOnceOccurrencesLineNumbers = </span><span class="p">[]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>contains the draw function as a Function object. Never mind the
initialisation as an empty string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawFunction = </span><span class="s">&quot;&quot;</span>
  
  <span class="nv">consecutiveFramesWithoutRunTimeError = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>contains the last stable draw function as a Function object. Never mind the
initialisation as an empty string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">lastStableDrawFunction = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>contains the code that is meant to be run, as a string.
note that it might be impossible to run it because of errors, in which case
LiveCodeLab might be running an older version.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">currentCodeString = </span><span class="s">&quot;&quot;</span>
  
  <span class="nv">constructor: </span><span class="nf">(@eventRouter, @liveCodeLabCoreInstance) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">addDoOnce = </span><span class="nf">(a) =&gt;</span> <span class="nx">@addDoOnce</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This is the function called from the compiled code to add the doOnce line</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addDoOnce: </span><span class="nf">(lineNum) -&gt;</span>
    <span class="nx">@doOnceOccurrencesLineNumbers</span><span class="p">.</span><span class="nx">push</span> <span class="nx">lineNum</span>

  <span class="nv">setDrawFunction: </span><span class="nf">(drawFunc) -&gt;</span>
    <span class="vi">@drawFunction = </span><span class="nx">drawFunc</span>

  <span class="nv">resetTrackingOfDoOnceOccurrences: </span><span class="nf">-&gt;</span>
    <span class="vi">@doOnceOccurrencesLineNumbers = </span><span class="p">[]</span>

  <span class="nv">putTicksNextToDoOnceBlocksThatHaveBeenRun: </span><span class="nf">-&gt;</span>
    <span class="nv">codeTransformer = </span><span class="nx">@liveCodeLabCoreInstance</span><span class="p">.</span><span class="nx">codeTransformer</span>
    <span class="k">if</span> <span class="nx">@doOnceOccurrencesLineNumbers</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">@setDrawFunction</span><span class="p">(</span>
        <span class="nx">codeTransformer</span><span class="p">.</span><span class="nx">addCheckMarksAndUpdateCodeAndNotifyChange</span><span class="p">(</span>
          <span class="nx">codeTransformer</span><span class="p">,</span> <span class="nx">@doOnceOccurrencesLineNumbers</span>
        <span class="p">)</span>
      <span class="p">)</span>

  <span class="nv">runDrawFunction: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>this invokation below could be throwing an error,
in which case the lines afterwards are not executed
and the exception is propagated to the callee of this function,
which is the main animation loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@drawFunction</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>if we are here it means that the draw function didn't generate
any runtime errors, so we increment a counter that tells how long
this program has been stable for.
Beyond 5 frames, we consider this program as "stable" and we save
it in a special variable.
This "stability" counter is obviously reset anytime the program is changed
so the new version too gets an opportunity to be tested and saved.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@consecutiveFramesWithoutRunTimeError</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">@consecutiveFramesWithoutRunTimeError</span> <span class="o">is</span> <span class="mi">5</span>
      <span class="vi">@lastStableDrawFunction = </span><span class="nx">@drawFunction</span>
      <span class="nx">@eventRouter</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;livecodelab-running-stably&quot;</span>

  <span class="nv">reinstateLastWorkingDrawFunction: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>mark the program as flawed and register the previous stable one.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@consecutiveFramesWithoutRunTimeError = </span><span class="mi">0</span>
    <span class="vi">@drawFunction = </span><span class="nx">@lastStableDrawFunction</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 