<!DOCTYPE html>  <html> <head>   <title>init-threejs.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation-controls.html">                 animation-controls.js               </a>                                           <a class="source" href="background-painting.html">                 background-painting.js               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.js               </a>                                           <a class="source" href="blend-style.html">                 blend-style.js               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="colour-definitions.html">                 colour-definitions.js               </a>                                           <a class="source" href="colour-functions.html">                 colour-functions.js               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="events.html">                 events.js               </a>                                           <a class="source" href="globals.html">                 globals.js               </a>                                           <a class="source" href="graphic-primitives.html">                 graphic-primitives.js               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.js               </a>                                           <a class="source" href="math.html">                 math.js               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.js               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.js               </a>                                           <a class="source" href="time-keeper.html">                 time-keeper.js               </a>                                           <a class="source" href="ui.html">                 ui.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               init-threejs.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="comment">/*jslint browser: true, devel: true */</span>

<span class="keyword">var</span> createThreeJs = <span class="function"><span class="keyword">function</span> <span class="params">(Detector, THREE, THREEx)</span> {</span>

    <span class="string">'use strict'</span>;

    <span class="keyword">var</span> ThreeJs = {},
        backgroundScene,
        backGroundFraction = <span class="number">15</span>,
        pointLight;

    ThreeJs.isWebGLUsed = <span class="literal">false</span>;

    ThreeJs.composer = {};

    ThreeJs.sceneRenderingCanvas = {};

    ThreeJs.forceCanvasRenderer = <span class="literal">false</span>;

    ThreeJs.scaledBackgroundWidth = Math.floor(window.innerWidth / backGroundFraction);
    ThreeJs.scaledBackgroundHeight = Math.floor(window.innerHeight / backGroundFraction);

    <span class="keyword">if</span> (!ThreeJs.forceCanvasRenderer &amp;&amp; Detector.webgl) {

        ThreeJs.ballDefaultDetLevel = <span class="number">16</span>;
        ThreeJs.sceneRenderingCanvas = document.createElement(<span class="string">'canvas'</span>);

        ThreeJs.renderer = <span class="keyword">new</span> THREE.WebGLRenderer({
            canvas: ThreeJs.sceneRenderingCanvas,
            preserveDrawingBuffer: <span class="literal">false</span>, <span class="comment">// to allow screenshot</span>
            antialias: <span class="literal">false</span>,
            premultipliedAlpha: <span class="literal">false</span>
        });

        ThreeJs.isWebGLUsed = <span class="literal">true</span>;

        ThreeJs.renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById(<span class="string">'container'</span>).appendChild(ThreeJs.sceneRenderingCanvas);

    } <span class="keyword">else</span> {


</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>we always draw the 3d scene off-screen</p>             </td>             <td class="code">               <div class="highlight"><pre>        ThreeJs.ballDefaultDetLevel = <span class="number">6</span>;
        ThreeJs.sceneRenderingCanvas = document.createElement(<span class="string">'canvas'</span>);
        ThreeJs.sceneRenderingCanvasContext = ThreeJs.sceneRenderingCanvas.getContext(<span class="string">'2d'</span>);
        ThreeJs.renderer = <span class="keyword">new</span> THREE.CanvasRenderer({
            canvas: ThreeJs.sceneRenderingCanvas,
            antialias: <span class="literal">true</span>, <span class="comment">// to get smoother output</span>
            preserveDrawingBuffer: <span class="literal">false</span> <span class="comment">// to allow screenshot</span>
        });


        ThreeJs.previousRenderForBlending = document.createElement(<span class="string">'canvas'</span>);
        ThreeJs.previousRenderForBlending.width = window.innerWidth;
        ThreeJs.previousRenderForBlending.height = window.innerHeight;
        ThreeJs.previousRenderForBlendingContext = ThreeJs.previousRenderForBlending.getContext(<span class="string">'2d'</span>);

        ThreeJs.finalRenderWithSceneAndBlend = document.getElementById(<span class="string">'finalRenderWithSceneAndBlendCanvas'</span>);
        ThreeJs.finalRenderWithSceneAndBlend.width = window.innerWidth;
        ThreeJs.finalRenderWithSceneAndBlend.height = window.innerWidth;
        ThreeJs.finalRenderWithSceneAndBlendContext = ThreeJs.finalRenderWithSceneAndBlend.getContext(<span class="string">'2d'</span>);

        ThreeJs.renderer.setSize(window.innerWidth, window.innerHeight);
    }


    backgroundScene = document.getElementById(<span class="string">'backGroundCanvas'</span>);
    backgroundScene.width = ThreeJs.scaledBackgroundWidth;
    backgroundScene.height = ThreeJs.scaledBackgroundHeight;
    ThreeJs.backgroundSceneContext = backgroundScene.getContext(<span class="string">'2d'</span>);


    ThreeJs.scene = <span class="keyword">new</span> THREE.Scene();
    ThreeJs.scene.matrixAutoUpdate = <span class="literal">false</span>;


</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>put a camera in the scene</p>             </td>             <td class="code">               <div class="highlight"><pre>    ThreeJs.camera = <span class="keyword">new</span> THREE.PerspectiveCamera(<span class="number">35</span>, window.innerWidth / window.innerHeight, <span class="number">1</span>, <span class="number">10000</span>);
    ThreeJs.camera.position.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>);
    ThreeJs.scene.add(ThreeJs.camera);

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>transparently support window resize</p>             </td>             <td class="code">               <div class="highlight"><pre>    THREEx.WindowResize.bind(ThreeJs.renderer, ThreeJs.camera);

    ThreeJs.buildPostprocessingChain = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> renderTargetParameters,
            renderTarget,
            effectSaveTarget,
            fxaaPass,
            screenPass,
            renderModel;

        renderTargetParameters = {
            format: THREE.RGBAFormat,
            stencilBuffer: <span class="literal">true</span>
        };

        renderTarget = <span class="keyword">new</span> THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, renderTargetParameters);
        effectSaveTarget = <span class="keyword">new</span> THREE.SavePass(<span class="keyword">new</span> THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, renderTargetParameters));
        effectSaveTarget.clear = <span class="literal">false</span>;

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Uncomment the three lines containing "fxaaPass" below to try a fast
antialiasing filter. Commented below because of two reasons: a) it's slow
b) it blends in some black pixels, so it only looks good in dark backgrounds
The problem of blending with black pixels is the same problem of the
motionBlur leaving a black trail - tracked in github with
https://github.com/davidedc/livecodelab/issues/22</p>             </td>             <td class="code">               <div class="highlight"><pre>        
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>fxaaPass = new THREE.ShaderPass(THREE.ShaderExtras.fxaa);
fxaaPass.uniforms.resolution.value.set(1 / window.innerWidth, 1 / window.innerHeight);</p>             </td>             <td class="code">               <div class="highlight"><pre>
        ThreeJs.effectBlend = <span class="keyword">new</span> THREE.ShaderPass(THREE.ShaderExtras.blend, <span class="string">"tDiffuse1"</span>);
        screenPass = <span class="keyword">new</span> THREE.ShaderPass(THREE.ShaderExtras.screen);

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>motion blur</p>             </td>             <td class="code">               <div class="highlight"><pre>        ThreeJs.effectBlend.uniforms.tDiffuse2.value = effectSaveTarget.renderTarget;
        ThreeJs.effectBlend.uniforms.mixRatio.value = <span class="number">0</span>;

        renderModel = <span class="keyword">new</span> THREE.RenderPass(ThreeJs.scene, ThreeJs.camera);

        ThreeJs.composer = <span class="keyword">new</span> THREE.EffectComposer(ThreeJs.renderer, renderTarget);

        ThreeJs.composer.addPass(renderModel);
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>ThreeJs.composer.addPass(fxaaPass);</p>             </td>             <td class="code">               <div class="highlight"><pre>        ThreeJs.composer.addPass(ThreeJs.effectBlend);
        ThreeJs.composer.addPass(effectSaveTarget);
        ThreeJs.composer.addPass(screenPass);
        screenPass.renderToScreen = <span class="literal">true</span>;
    };

    <span class="keyword">if</span> (ThreeJs.isWebGLUsed) {
        ThreeJs.buildPostprocessingChain();
    }




    <span class="keyword">return</span> ThreeJs;

};

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 