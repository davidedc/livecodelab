<!DOCTYPE html>  <html> <head>   <title>livecodelab.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="autocode.html">                 autocode.js               </a>                                           <a class="source" href="background-painting.html">                 background-painting.js               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.js               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="from-processing.html">                 from-processing.js               </a>                                           <a class="source" href="geometry-commands.html">                 geometry-commands.js               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.js               </a>                                           <a class="source" href="livecodelab.html">                 livecodelab.js               </a>                                           <a class="source" href="math.html">                 math.js               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.js               </a>                                           <a class="source" href="menu.html">                 menu.js               </a>                                           <a class="source" href="sound-functions.html">                 sound-functions.js               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.js               </a>                                           <a class="source" href="var-definitions.html">                 var-definitions.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               livecodelab.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> drawLoopTimer = <span class="literal">null</span>;
<span class="keyword">var</span> frame = <span class="number">0</span>;
<span class="keyword">var</span> doLNOnce = [];
<span class="keyword">var</span> loopInterval;
<span class="keyword">var</span> time;
<span class="keyword">var</span> timeAtStart;
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>if there isn't any code using the bpm setting then we can save a timer, so
worth tracking with this variable</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> anyCodeReactingTobpm;

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>animation loop</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="function"><span class="keyword">function</span> <span class="title">animate</span><span class="params">()</span> {</span>

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>loop on request animation loop
- it has to be at the begining of the function
- see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
requestAnimationFrame seems to only do 60 fps, which in my case is too much,
I rather prefer to have a slower framerate but steadier.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="keyword">if</span> (useRequestAnimationFrame) {
    <span class="keyword">if</span> (wantedFramesPerSecond === -<span class="number">1</span>) {
      requestAnimationFrame(animate);
    } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>setTimeout("window.requestAnimationFrame(animate)",
      1000 / wantedFramesPerSecond);</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> (loopInterval === <span class="literal">undefined</span>) {
        loopInterval = setInterval(<span class="string">"window.requestAnimationFrame(animate)"</span>, <span class="number">1000</span> / wantedFramesPerSecond);
      }
    }
  } <span class="keyword">else</span> {
    setTimeout(<span class="string">'animate();'</span>, <span class="number">1000</span> / wantedFramesPerSecond);
  }

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>clearDisplayList();</p>             </td>             <td class="code">               <div class="highlight"><pre>  matrixStack = [];
  worldMatrix.identity();

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>the sound list needs to be cleaned
so that the user program can create its own from scratch</p>             </td>             <td class="code">               <div class="highlight"><pre>  soundLoops.soundIDs = [];
  soundLoops.beatStrings = [];


</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>rootObject = new THREE.Object3D();
scene.add(rootObject);
parentObject = rootObject;</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="keyword">if</span> (<span class="keyword">typeof</span>(draw) != <span class="string">"undefined"</span>) {
    <span class="keyword">var</span> d = <span class="keyword">new</span> Date();
    <span class="keyword">if</span> (frame === <span class="number">0</span>) {
      timeAtStart = d.getTime();
      time = <span class="number">0</span>;
    } <span class="keyword">else</span> {
      time = d.getTime() - timeAtStart;
    }
    doLNOnce = [];
    anyCodeReactingTobpm = <span class="literal">false</span>;
    fill(<span class="number">0xFFFFFFFF</span>);
    stroke(<span class="number">0xFF000000</span>);
    currentStrokeSize = <span class="number">1</span>;
    defaultNormalFill = <span class="literal">true</span>;
    defaultNormalStroke = <span class="literal">true</span>;
    ballDetLevel = ballDefaultDetLevel;
    noLights();
    usedLines = <span class="number">0</span>;
    usedRectangles = <span class="number">0</span>;
    usedBoxes = <span class="number">0</span>;
    usedAmbientLights = <span class="number">0</span>;
    usedPointLights = <span class="number">0</span>;
    updatesPerMinute = <span class="number">60</span>*<span class="number">4</span>;
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>In theory there is no need to chuck away the
counter altogether, you could go through
the existing counters contained in this object
(one for each ball detail ever used)
and set it to zero. That would maybe save
some garbage collection time.
But it's probably not worth it...</p>             </td>             <td class="code">               <div class="highlight"><pre>    usedSpheres = {};
    animationStyleValue = normal;
    resetGradientStack();
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>bpm(0);</p>             </td>             <td class="code">               <div class="highlight"><pre>    
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Now here there is another try/catch check when the draw function is ran.
The reason is that there might be references to uninitialised or inexistent
variables. For example:
  box
  background yeLow
  ball
draws only a box, because the execution silently fails at the yeLow reference.
So in that case we need to a) highlight the error and b) run the previously
known good program.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">try</span> {
	    draw();
	  } <span class="keyword">catch</span> (e) {
		
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>I'm not sure that this type of error should occur during autocoding
but this can't hurt and it's symmetrical to the other try/catch
situation we have in livecodelab</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="keyword">if</span> (autocodeOn) {
					editor.undo();
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>alert("did an undo");</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="keyword">return</span>;
				}
		
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>highlight the error</p>             </td>             <td class="code">               <div class="highlight"><pre>				checkErrorAndReport(e);
				
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>mark the program as flawed and register the previous stable one.</p>             </td>             <td class="code">               <div class="highlight"><pre>				consecutiveFramesWithoutRunTimeError = <span class="number">0</span>;
				out = lastStableProgram;
  			window.eval(lastStableProgram);

				<span class="keyword">return</span>;
		}

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>we have to repeat this check because in the case
the user has set frame = 0,
then we have to catch that case here
after the program has executed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">if</span> (frame === <span class="number">0</span>) {
      timeAtStart = d.getTime();
      time = <span class="number">0</span>;
    }
    <span class="keyword">if</span> (anyCodeReactingTobpm) changeUpdatesPerMinuteIfNeeded();
    animationStyleUpdateIfChanged();
    simpleGradientUpdateIfChanged();
    changeUpdatesPerMinuteIfNeeded();
    frame++;
    consecutiveFramesWithoutRunTimeError++;
    <span class="keyword">if</span> (consecutiveFramesWithoutRunTimeError == <span class="number">5</span>) {
      lastStableProgram = out;
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>chromeHackUncaughtReferenceName = '';</p>             </td>             <td class="code">               <div class="highlight"><pre>    }
  } <span class="comment">// if typeof draw</span>

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>do the render</p>             </td>             <td class="code">               <div class="highlight"><pre>  combDisplayList();
  render();
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>clearDisplayList();
update stats</p>             </td>             <td class="code">               <div class="highlight"><pre>  stats.update();


  <span class="keyword">if</span> (doLNOnce.length !== <span class="number">0</span>) {
</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>alert("a doOnce has been ran");</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">var</span> elaboratedSource = editor.getValue();

    <span class="keyword">var</span> elaboratedSourceByLine = elaboratedSource.split(<span class="string">"\n"</span>);
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>alert('splitting: ' + elaboratedSourceByLine.length );</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">for</span> (<span class="keyword">var</span> iteratingOverSource = <span class="number">0</span>; iteratingOverSource &lt; doLNOnce.length; iteratingOverSource++) {
</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>alert('iterating: ' + iteratingOverSource );</p>             </td>             <td class="code">               <div class="highlight"><pre>      elaboratedSourceByLine[doLNOnce[iteratingOverSource]] = elaboratedSourceByLine[doLNOnce[iteratingOverSource]].replace(<span class="regexp">/^(\s*)doOnce([ ]*\-&gt;[ ]*.+)$/gm</span>, <span class="string">"$1\u2713doOnce$2"</span>);
      elaboratedSourceByLine[doLNOnce[iteratingOverSource]] = elaboratedSourceByLine[doLNOnce[iteratingOverSource]].replace(<span class="regexp">/^(\s*)doOnce([ ]*\-&gt;[ ]*)$/gm</span>, <span class="string">"$1\u2713doOnce$2"</span>);
    }
    elaboratedSource = elaboratedSourceByLine.join(<span class="string">"\n"</span>);

    <span class="keyword">var</span> cursorPositionBeforeAddingCheckMark = editor.getCursor();
    cursorPositionBeforeAddingCheckMark.ch = cursorPositionBeforeAddingCheckMark.ch + <span class="number">1</span>;

    editor.setValue(elaboratedSource);
    editor.setCursor(cursorPositionBeforeAddingCheckMark);

</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>we want to avoid that another frame is run with the old
code, as this would mean that the
runOnce code is run more than once,
so we need to register the new code.
TODO: ideally we don't want to register the
new code by getting the code from codemirror again
because we don't know what that entails. We should
just pass the code we already have.
Also registerCode() may split the source code by line, so we can
avoid that since we've just split it, we could pass
the already split code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    registerCode();
  }

}

<span class="keyword">var</span> composer;

<span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> {</span>

  <span class="comment">/*
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>need a light for the meshlambert material</p>             </td>             <td class="code">               <div class="highlight"><pre>      var light = new THREE.PointLight( 0xFFFFFF );
      light.position.set( 10, 0, 10 );
      scene.add( light );
  */

</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>//////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="keyword">if</span> (isWebGLUsed) {
    composer.render();
</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>renderer.render(scene,camera);</p>             </td>             <td class="code">               <div class="highlight"><pre>  } <span class="keyword">else</span> {

</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>the renderer draws into an offscreen canvas called sceneRenderingCanvas</p>             </td>             <td class="code">               <div class="highlight"><pre>    renderer.render(scene, camera);

</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>clear the final render context</p>             </td>             <td class="code">               <div class="highlight"><pre>    finalRenderWithSceneAndBlendContext.globalAlpha = <span class="number">1.0</span>;
    finalRenderWithSceneAndBlendContext.clearRect(<span class="number">0</span>, <span class="number">0</span>, window.innerWidth, window.innerHeight);

</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>draw the rendering of the scene on the final render
clear the final render context</p>             </td>             <td class="code">               <div class="highlight"><pre>    finalRenderWithSceneAndBlendContext.globalAlpha = blendAmount;
    finalRenderWithSceneAndBlendContext.drawImage(previousRenderForBlending, <span class="number">0</span>, <span class="number">0</span>);

    finalRenderWithSceneAndBlendContext.globalAlpha = <span class="number">1.0</span>;
    finalRenderWithSceneAndBlendContext.drawImage(sceneRenderingCanvas, <span class="number">0</span>, <span class="number">0</span>);

</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>previousRenderForBlendingContext.clearRect(0, 0, window.innerWidth,window.innerHeight)</p>             </td>             <td class="code">               <div class="highlight"><pre>    previousRenderForBlendingContext.globalCompositeOperation = <span class="string">'copy'</span>;
    previousRenderForBlendingContext.drawImage(finalRenderWithSceneAndBlend, <span class="number">0</span>, <span class="number">0</span>);

</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>clear the renderer's canvas to transparent black</p>             </td>             <td class="code">               <div class="highlight"><pre>    sceneRenderingCanvasContext.clearRect(<span class="number">0</span>, <span class="number">0</span>, window.innerWidth, window.innerHeight);

  }
}


<span class="keyword">var</span> dimcodeOn = <span class="literal">false</span>;

<span class="function"><span class="keyword">function</span> <span class="title">triggerReset</span><span class="params">()</span> {</span>
  pickRandomDefaultGradient();
  <span class="keyword">if</span> (autocodeOn) toggleAutocodeAndUpdateButtonAndBlinking();
  editor.setValue(<span class="string">''</span>);
  $(<span class="string">"#resetButtonContainer"</span>).css(<span class="string">"background-color"</span>, <span class="string">'#FF0000'</span>);
  setTimeout(<span class="string">'$("#resetButtonContainer").css("background-color","");'</span>, <span class="number">200</span>);
}


<span class="keyword">var</span> changesHappened = <span class="literal">false</span>;

<span class="keyword">var</span> cursorActivity = <span class="literal">true</span>;

<span class="function"><span class="keyword">function</span> <span class="title">selectTheme</span><span class="params">(node)</span> {</span>
  <span class="keyword">var</span> theme = node.options[node.selectedIndex].innerHTML;
  editor.setOption(<span class="string">"theme"</span>, theme);
}

</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>resizing the text area is necessary otherwise
as the user types to the end of it, instead of just scrolling
the content leaving all the other parts of the page where
they are, it expands and it pushes down
the view of the page, meaning that the canvas goes up and
the menu disappears
so we have to resize it at launch and also every time the window
is resized.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="function"><span class="keyword">function</span> <span class="title">adjustCodeMirrorHeight</span><span class="params">()</span> {</span>
</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>alert("code height:" + $('#code').height());
alert("window height:" + window.innerHeight);
alert("code height:" + $('.CodeMirror-scroll').css('height'));
alert("menu height:" + $('#theMenu').height());</p>             </td>             <td class="code">               <div class="highlight"><pre>  $(<span class="string">'.CodeMirror-scroll'</span>).css(<span class="string">'height'</span>, window.innerHeight - $(<span class="string">'#theMenu'</span>).height());
}


<span class="function"><span class="keyword">function</span> <span class="title">fullscreenify</span><span class="params">(canvas)</span> {</span>
  <span class="keyword">var</span> style = canvas.getAttribute(<span class="string">'style'</span>) || <span class="string">''</span>;
</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>alert('style: ' +  style);</p>             </td>             <td class="code">               <div class="highlight"><pre>  window.addEventListener(<span class="string">'resize'</span>, <span class="keyword">function</span>() {
    adjustCodeMirrorHeight();
    resize(canvas);
  }, <span class="literal">false</span>);

  resize(canvas);

  <span class="function"><span class="keyword">function</span> <span class="title">resize</span><span class="params">(canvas)</span> {</span>
    <span class="keyword">var</span> scale = {
      x: <span class="number">1</span>,
      y: <span class="number">1</span>
    };
    scale.x = (window.innerWidth + <span class="number">40</span>) / canvas.width;
    scale.y = (window.innerHeight + <span class="number">40</span>) / canvas.height;

    scale = scale.x + <span class="string">', '</span> + scale.y;

</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>this code below is if one wants to keep the aspect ratio
but I mean one doesn't necessarily resize the window
keeping the same aspect ratio.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="comment">/*
        if (scale.x &lt; 1 || scale.y &lt; 1) {
            scale = '1, 1';
        } else if (scale.x &lt; scale.y) {
            scale = scale.x + ', ' + scale.x;
        } else {
            scale = scale.y + ', ' + scale.y;
        }
        */</span>

    canvas.setAttribute(<span class="string">'style'</span>, style + <span class="string">' '</span> + <span class="string">'-ms-transform-origin: left top; -webkit-transform-origin: left top; -moz-transform-origin: left top; -o-transform-origin: left top; transform-origin: left top; -ms-transform: scale('</span> + scale + <span class="string">'); -webkit-transform: scale3d('</span> + scale + <span class="string">', 1); -moz-transform: scale('</span> + scale + <span class="string">'); -o-transform: scale('</span> + scale + <span class="string">'); transform: scale('</span> + scale + <span class="string">');'</span>);

</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>TODO In theory we want to re-draw the background because the
aspect ration might have changed.
But for the time being we only have vertical
gradients so that's not going to be a problem.</p>             </td>             <td class="code">               <div class="highlight"><pre>  }
}

</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>By doing some profiling it is apparent that
adding and removing objects has a big cost.
So instead of adding/removing objects every frame,
objects are only added at creation and they are
never removed from the scene. They are
only made invisible. This routine combs the
scene and finds the objects that need to be visible and
those that need to be hidden.
This is a scenario of how it works:
  frame 1: 3 boxes invoked. effect: 3 cubes are created and put in the scene
  frame 2: 1 box invoked. effect: 1st cube is updated with new scale/matrix/material
           and the other 2 boxes are set to hidden
So there is a pool of objects for each primitive. It starts empty, new objects are
added to the scene only if the ones available from previous draws are not sufficient.
TODO a way to shrink the scene if it's been a
long time that only a handful of lines/meshes
have been used.
Note: Mr Doob said that the new scene destruction/creation primitives of Three.js
      are much faster. Also the objects of the scene are harder to reach, so
      it could be the case that this mechanism is not needed anymore.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="function"><span class="keyword">function</span> <span class="title">combDisplayList</span><span class="params">()</span> {</span>
</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>scan all the objects in the display list</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; scene.objects.length; ++i) {
    <span class="keyword">var</span> sceneObject = scene.objects[i];
    
</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>check the type of object. Each type has one pool. Go through each object in the
pool and set to visible the number of used objects in this frame, set the
others to hidden.
Only tiny exception is that the sphere has one pool for each detail level.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">if</span> (sceneObject.isLine) {
</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>set the first "used<strong>*</strong>" objects to visible...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> (usedLines &gt; <span class="number">0</span>) {
        sceneObject.visible = <span class="literal">true</span>;
        usedLines--;
      } <span class="keyword">else</span> {
</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>... and the others to invisible</p>             </td>             <td class="code">               <div class="highlight"><pre>        sceneObject.visible = <span class="literal">false</span>;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (sceneObject.isRectangle) {
      <span class="keyword">if</span> (usedRectangles &gt; <span class="number">0</span>) {
        sceneObject.visible = <span class="literal">true</span>;
        usedRectangles--;
      } <span class="keyword">else</span> {
        sceneObject.visible = <span class="literal">false</span>;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (sceneObject.isBox) {
      <span class="keyword">if</span> (usedBoxes &gt; <span class="number">0</span>) {
        sceneObject.visible = <span class="literal">true</span>;
        usedBoxes--;
      } <span class="keyword">else</span> {
        sceneObject.visible = <span class="literal">false</span>;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (sceneObject.isCylinder) {
      <span class="keyword">if</span> (usedCylinders &gt; <span class="number">0</span>) {
        sceneObject.visible = <span class="literal">true</span>;
        usedCylinders--;
      } <span class="keyword">else</span> {
        sceneObject.visible = <span class="literal">false</span>;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (sceneObject.isAmbientLight) {
      <span class="keyword">if</span> (usedAmbientLights &gt; <span class="number">0</span>) {
        sceneObject.visible = <span class="literal">true</span>;
        usedAmbientLights--;
      } <span class="keyword">else</span> {
        sceneObject.visible = <span class="literal">false</span>;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (sceneObject.isSphere !== <span class="number">0</span>) {
</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>there is a separate pool for each sphere detail level
the detail level number is kept in the sceneObject.isSphere field
(should probably have its own field to keep things clean really)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">if</span> (usedSpheres[<span class="string">''</span> + sceneObject.isSphere] &gt; <span class="number">0</span>) {
        sceneObject.visible = <span class="literal">true</span>;
        usedSpheres[<span class="string">''</span> + sceneObject.isSphere] = usedSpheres[<span class="string">''</span> + sceneObject.isSphere] - <span class="number">1</span>;
      } <span class="keyword">else</span> {
        sceneObject.visible = <span class="literal">false</span>;
      }
    }
  }
}


<span class="function"><span class="keyword">function</span> <span class="title">clearDisplayList</span><span class="params">()</span> {</span>
  <span class="comment">/*
  for(var i = 0; i &lt; scene.objects.length; ++i) {
      scene.remove(scene.objects[i]);
      i--;
  }
  */</span>
}



</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>var chromeHackUncaughtReferenceName = '';
var chromeHackUncaughtReferenceNames = [];</p>             </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>swap the two lines below in case one needs to
debug the environment, otherwise all errors are
caught and not bubbled up to the browser debugging tool.</p>             </td>             <td class="code">               <div class="highlight"><pre> <span class="keyword">var</span> foo = <span class="keyword">function</span>(msg, url, linenumber) {
</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>window.onerror = function(msg, url, linenumber) {</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="keyword">if</span> (autocodeOn) {
    editor.undo();
</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>alert("did an undo");</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (msg.indexOf(<span class="string">"Uncaught ReferenceError: "</span>) &gt; -<span class="number">1</span>) {
    msg = msg.substring(<span class="number">25</span>);
  }

  $(<span class="string">'#dangerSignText'</span>).css(<span class="string">'color'</span>, <span class="string">'red'</span>);
  $(<span class="string">'#errorMessageText'</span>).text(msg);

</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>ok so this is kind of a hack that we need to put
in place for Chrome (both Windows and Mac)
what Chrome does is: when there is a function call,
it evaluates the arguments
of a function even if the function is undefined
so for example
doO alert "miao"
alerts a miao, because it's translated into
doO(alert("miao))
and even if doO is undefined, the argumen is evaluated
This is a problem because doOnce would encourage
the following use: misspell doOnce until the rest of the
line is finished, then correct the mispell to actually
run the line once.
But unfortunately because of the quirk described above,
that wouldn't work in Chrome.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="comment">/*
 if (msg.indexOf("Uncaught ReferenceError") &gt; -1) {
  chromeHackUncaughtReferenceName = msg.split(' ')[2];

  var lengthToCheck = chromeHackUncaughtReferenceNames.length;
  if (lengthToCheck == 0){
    chromeHackUncaughtReferenceNames.push(chromeHackUncaughtReferenceName);
  }
  else {
    for (var iteratingOverSource = 0; iteratingOverSource &lt; lengthToCheck; iteratingOverSource++) {
      if (chromeHackUncaughtReferenceNames[iteratingOverSource].indexOf(chromeHackUncaughtReferenceName) &gt; -1) {
        break;
      }
      else if (iteratingOverSource == lengthToCheck-1) {
</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>if we are here it means that the variable is not in the array</p>             </td>             <td class="code">               <div class="highlight"><pre>       chromeHackUncaughtReferenceNames.push(chromeHackUncaughtReferenceName);
      }
    }
  }
 }
 */

</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>we set this to 6 because we save it as stable
when it's 5, so we avoid re-saving.</p>             </td>             <td class="code">               <div class="highlight"><pre>  consecutiveFramesWithoutRunTimeError = <span class="number">6</span>;
  window.eval(lastStableProgram);

  <span class="keyword">return</span> <span class="literal">true</span>;
}

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 