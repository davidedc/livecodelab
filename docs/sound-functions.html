<!DOCTYPE html>  <html> <head>   <title>sound-functions.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="background-painting.html">                 background-painting.js               </a>                                           <a class="source" href="big-cursor-animation.html">                 big-cursor-animation.js               </a>                                           <a class="source" href="code-transformations.html">                 code-transformations.js               </a>                                           <a class="source" href="demos-and-tutorials.html">                 demos-and-tutorials.js               </a>                                           <a class="source" href="coffeescript-livecodelab-mode.html">                 coffeescript-livecodelab-mode.js               </a>                                           <a class="source" href="editor.html">                 editor.js               </a>                                           <a class="source" href="mousewheel.html">                 mousewheel.js               </a>                                           <a class="source" href="from-processing.html">                 from-processing.js               </a>                                           <a class="source" href="geometry-commands.html">                 geometry-commands.js               </a>                                           <a class="source" href="init-threejs.html">                 init-threejs.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="lights-functions.html">                 lights-functions.js               </a>                                           <a class="source" href="livecodelab.html">                 livecodelab.js               </a>                                           <a class="source" href="math.html">                 math.js               </a>                                           <a class="source" href="matrix-commands.html">                 matrix-commands.js               </a>                                           <a class="source" href="menu.html">                 menu.js               </a>                                           <a class="source" href="sound-functions.html">                 sound-functions.js               </a>                                           <a class="source" href="text-dimming.html">                 text-dimming.js               </a>                                           <a class="source" href="var-definitions.html">                 var-definitions.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               sound-functions.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> updatesPerMinute = <span class="number">0</span>;
<span class="keyword">var</span> oldupdatesPerMinute = <span class="number">0</span>;
<span class="keyword">var</span> soundLoopTimer;
<span class="keyword">var</span> beatNumber = <span class="number">0</span>;

<span class="keyword">var</span> bpm = <span class="keyword">function</span>(a) {

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>timid attempt at sanity check.
the sound system might well bork out
even below 500 bpm.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="keyword">if</span> (a === <span class="literal">undefined</span>) <span class="keyword">return</span>;
  <span class="keyword">if</span> (a &gt; <span class="number">125</span>) a = <span class="number">125</span>;
  <span class="keyword">if</span> (a &lt; <span class="number">0</span>) a = <span class="number">0</span>;

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>each beat is made of 4 parts, and we can trigger sounds
on each of those, so updatesPerMinute is 4 times the bpm.</p>             </td>             <td class="code">               <div class="highlight"><pre>  updatesPerMinute = a*<span class="number">4</span>;
}

<span class="keyword">var</span> changeUpdatesPerMinuteIfNeeded = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (oldupdatesPerMinute !== updatesPerMinute) {
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>alert('changing beats per minute old ' + oldupdatesPerMinute + ' new: ' + updatesPerMinute);</p>             </td>             <td class="code">               <div class="highlight"><pre>    clearTimeout(soundLoopTimer);

    <span class="keyword">if</span> (updatesPerMinute !== <span class="number">0</span>) {
      soundLoopTimer = setInterval(<span class="string">'soundLoop();'</span>, (<span class="number">1000</span> * <span class="number">60</span>) / updatesPerMinute);
    }
    oldupdatesPerMinute = updatesPerMinute;
  }
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>alert('AFTER old ' + oldupdatesPerMinute + ' new: ' + a);</p>             </td>             <td class="code">               <div class="highlight"><pre>}

<span class="keyword">var</span> soundLoop = <span class="keyword">function</span>() {
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>clearTimeout(soundLoopTimer);
alert('soundLoop');
if (updatesPerMinute !== 0) {
   soundLoopTimer = setTimeout('soundLoop();',(1000*60)/updatesPerMinute);
}</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="keyword">if</span> (soundSystemIsMangled) <span class="keyword">return</span>;

  beatNumber++;
  beatNumber = beatNumber % <span class="number">16</span>;

  log(<span class="string">'about to loop in '</span>+soundLoops.soundIDs+<span class="string">" of length "</span>+soundLoops.soundIDs.length);
  <span class="keyword">for</span> (<span class="keyword">var</span> loopingTheSoundIDs = <span class="number">0</span>; loopingTheSoundIDs &lt; soundLoops.soundIDs.length; loopingTheSoundIDs++) {
    <span class="keyword">var</span> loopedSoundID = soundLoops.soundIDs[loopingTheSoundIDs];
    <span class="keyword">var</span> playOrNoPlay;
    playOrNoPlay = soundLoops.beatStrings[loopingTheSoundIDs].charAt(beatNumber);
    log(<span class="string">'checking sound loop '</span>+soundLoops.beatStrings[loopingTheSoundIDs]+<span class="string">" beat "</span>+beatNumber+<span class="string">" : "</span>+playOrNoPlay);
    <span class="keyword">if</span> (playOrNoPlay === <span class="string">'x'</span>) {
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>OK so this is what we do here:
when each Audio object plays, it plays from start to end
and you can't get it to re-start until it's completely done
playing.
This is bad because some sounds last a second or so, and they
need to play more often than one time per second.
So there are two possible solutions:
1) to have 20 or so sound objects, and all the times that
   a file needs playing, scan them and find one that is free,
   then associate that to the file one wants to play
   this works well in IE and Chrome but really bad in Safari
2) for each file, give it a queue of audio objects.
   This is more complicated but seems to work
   about right in all browsers. Only caveat is that Safari
   needs the audio objects to be preloaded because otherwise
   it jams. Conversely, IE and Chrome don't like them preloaded
   because they have a limit of 35 or so sounds.
So here we went for 2), and we preload the sounds only for
browsers other than Chrome and IE.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="keyword">var</span> relevantSoundBank = soundBank[loopedSoundID];
      <span class="keyword">var</span> lengthOfSoundBank = relevantSoundBank.length;
      <span class="keyword">var</span> availableSoundBank = <span class="literal">undefined</span>;
      log(<span class="string">'playing  '</span>+loopedSoundID+<span class="string">" length: "</span>+lengthOfSoundBank);
      <span class="keyword">for</span> (<span class="keyword">var</span> checkingAvailableSoundBank = <span class="number">0</span>; checkingAvailableSoundBank &lt; lengthOfSoundBank; checkingAvailableSoundBank++) {
        <span class="keyword">var</span> checkingSoundBank = relevantSoundBank[checkingAvailableSoundBank];
        <span class="keyword">if</span> (checkingSoundBank.isEnded()) {
          availableSoundBank = checkingSoundBank;
          log(<span class="string">'sound bank '</span>+checkingAvailableSoundBank+<span class="string">" is available "</span>);
          <span class="keyword">break</span>;
        } <span class="keyword">else</span> {
          log(<span class="string">'sound bank '</span>+checkingAvailableSoundBank+<span class="string">" has not ended "</span>);
        }
      }
      <span class="keyword">if</span> (availableSoundBank === <span class="literal">undefined</span>) {
        log(<span class="string">'creating new sound object '</span>);
        <span class="keyword">if</span> (totalCreatedSoundObjects &gt; <span class="number">31</span>) {
          soundSystemIsMangled = <span class="literal">true</span>;
          $(<span class="string">'#soundSystemIsMangledMessage'</span>).modal();
          $(<span class="string">'#simplemodal-container'</span>).height(<span class="number">250</span>);
        }
        availableSoundBank = <span class="keyword">new</span> buzz.sound(soundFiles[loopedSoundID]);
        soundBank[loopedSoundID].push(availableSoundBank);
        totalCreatedSoundObjects++;
      }

      
      availableSoundBank.play();
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>soundBank[soundLoops.soundIDs[i]]['lastUsed'] = (soundBank[soundLoops.soundIDs[i]]['lastUsed']+1)%CHANNELSPERSOUND;</p>             </td>             <td class="code">               <div class="highlight"><pre>    }
  }
}


<span class="keyword">var</span> play = <span class="keyword">function</span>(soundID, beatString) {
  anyCodeReactingTobpm = <span class="literal">true</span>;
  beatString = beatString.replace(<span class="regexp">/\s*/g</span>, <span class="string">""</span>);
  soundLoops.soundIDs.push(soundID);
  soundLoops.beatStrings.push(beatString);
  log(<span class="string">'pushing '</span>+soundID+<span class="string">" beat: "</span>+beatString);
}

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 